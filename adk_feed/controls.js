rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);if(typeof String.prototype.startsWith!="function")String.prototype.startsWith=function(s){return this.lastIndexOf(s,0)===0};
(function($){function filterCssClass(className){if(className.startsWith("ng-"))return className;return null}function getPostLink($timeout){return function(scope,element,attrs,ngModelCtrl){var isSelect=element.is("select");if(ngModelCtrl){scope.$watch(attrs.ngModel,function(current,old){if(current===old)return;ngModelCtrl.$render()},true);ngModelCtrl.$render=function(){if(isSelect)if(angular.isObject(ngModelCtrl.$viewValue)&&!angular.isArray(ngModelCtrl.$viewValue))element.select2("data",ngModelCtrl.$viewValue);
else element.select2("val",ngModelCtrl.$viewValue);else if(angular.isObject(ngModelCtrl.$viewValue))element.select2("data",ngModelCtrl.$viewValue);else if(!ngModelCtrl.$viewValue)element.select2("data",null);else element.select2("val",ngModelCtrl.$viewValue)};ngModelCtrl.$parsers.push(function(value){var div=element.prev();div.toggleClass("ng-invalid",!ngModelCtrl.$valid).toggleClass("ng-valid",ngModelCtrl.$valid).toggleClass("ng-invalid-required",!ngModelCtrl.$valid).toggleClass("ng-valid-required",
ngModelCtrl.$valid).toggleClass("ng-dirty",ngModelCtrl.$dirty).toggleClass("ng-pristine",ngModelCtrl.$pristine);return value})}}}var defaultOptions={width:"off",dropdownAutoWidth:true,adaptContainerCssClass:filterCssClass,adaptDropdownCssClass:filterCssClass};rh.ng.directive("rhSelect",function($parse,$timeout,rhEnvironmentService){var postLink=getPostLink({},$timeout);return{restrict:"C",require:"?ngModel",compile:function compile(tElement,tAttrs,transclude){if(!tElement.is("select"))return;var initialValue=
tElement.val();return{pre:function(scope,element,attrs,ngModelCtrl){if(tAttrs.ngModel&&initialValue)$parse(attrs.ngModel).assign(scope,initialValue)},post:function(scope,element,attrs,ngModelCtrl){getPostLink($timeout)(scope,element,attrs,ngModelCtrl);$timeout(function(){var dataOptions={};if(attrs.options)dataOptions=$.extend({},dataOptions,JSON.parse(attrs.options));options=$.extend({},defaultOptions,{minimumResultsForSearch:10,placeholder:element.attr("data-placeholder")},dataOptions);if(rhEnvironmentService.isMobileView()||
attrs.multiple)options.minimumResultsForSearch=-1;options.attachToBody=!rhEnvironmentService.isWidgetView(element);if($.fn.select2&&$.fn.select2.ratehub)element.select2(options);if(ngModelCtrl){if($.fn.select2)element.select2("data",ngModelCtrl.$modelValue);ngModelCtrl.$render();element.on("select2-blur",function(event){scope.$apply(function(){ngModelCtrl.$setViewValue(ngModelCtrl.$viewValue)})})}})}}}}});rh.ng.directive("rhCitySelect",function($timeout,$compile,rhEnvironmentService,rhHttpRequestService){function formatResult(data){if(data==
null)return;if(data.id)return'<span class="province">'+data.province.common_name+'</span><span class="city">'+data.name+"</span>";else return'<span class="prompt">'+Globalize.localize("select-city-title")+'</span><span class="province">'+data.common_name+"</span>"}function formatSelection(data){var html="";if(data==null)return html;if(data.id)html=html+"<span>"+data.name+", "+data.province.code+"</span>";else html=html+"<span>"+data.common_name+"</span>";return html}return{restrict:"C",require:["?ngModel",
"^rhCitySelector"],priority:1,link:function(scope,element,attrs,controllers){if(!$.fn.select2||!$.fn.select2.ratehub)return;var ngModelCtrl=controllers[0];var input=element;input.unbind("change");input.bind("change",function(event){if(scope.$$phase||scope.$root.$$phase)return;$.cookie("location",event.added.id,{expires:365,path:"/"});$.cookie("locationStatus","selected",{expires:365,path:"/"});if(ratehub.user.logged_in)rhHttpRequestService.post({url:"/api/user-dashboard?operation=changeLocation",
headers:{"Content-Type":"application/json"},data:JSON.stringify({city:event.added.id})});if(ngModelCtrl)scope.$apply(function(){ngModelCtrl.$setViewValue(input.select2("data"))});input.closest(".rh-city-selector").find(".rh-tooltip").popover("hide");if("refresh"in attrs||"redirect"in attrs)changeLocation({newLocation:event.added,oldLocation:event.removed,redirect:"redirect"in attrs})});getPostLink($timeout)(scope,input,attrs,ngModelCtrl);if(ngModelCtrl){scope.$watch(attrs.ngModel,function(current,
old){if(current===old){if(current&&!current.id)ngModelCtrl.$setValidity("rhCitySelect",false)}else if(current)ngModelCtrl.$setValidity("rhCitySelect",true)});element.on("select2-blur",function(event){scope.$apply(function(){ngModelCtrl.$setViewValue(ngModelCtrl.$viewValue)})})}var options={ajax:{url:ratehub.serverUri+"/api/cities",dataType:"jsonp",data:function(query){return{city:query}},results:function(data){return{results:data}}},placeholder:input.attr("data-placeholder"),minimumInputLength:3,
formatResult:formatResult,formatSelection:formatSelection};options=$.extend({},defaultOptions,options);options.attachToBody=!rhEnvironmentService.isWidgetView(element)||rhEnvironmentService.isMobileView();$timeout(function(){input.select2(options);input.on("select2-open",function(){$(".select2-search input").attr("placeholder",Globalize.localize("enter-city-name-title"))}).on("select2-close",function(){$(".select2-search input").attr("placeholder",null)});if(!input.closest("html.is-iframe").length&&
attrs.disableMobileOp!=="true"){var dropDown=null;var scrollTop=null;var colorboxTop=null;input.on("select2-opening",function(){dropDown=dropDown||input.select2("container").find(".select2-drop");if(rhEnvironmentService.isMobileView()){scrollTop=$(window).scrollTop();dropDown.addClass("select2-drop-mobile");var closeButton=$('<i class="select2-drop-close fa fa-times-circle"></i>').click(function(){input.select2("close")});dropDown.find(".select2-search").append(closeButton);var topLevelElements=topLevelElements=
$("body > header").siblings().addBack();if(!topLevelElements.length){$(document.body).addClass("rh");topLevelElements=$("body > *")}topLevelElements.filter(function(){return!$(this).is("script")}).each(function(){if($(this).is("#colorbox"))colorboxTop=$(this).css("top");$(this).css("top",$(this).offset().top-$("body").scrollTop())}).each(function(){$(this).css("position","fixed").css("z-index",-1)});setTimeout(function(){dropDown.css("min-height",$(window).height()).css("position","relative");$(window).scrollTop(0)},
500)}});input.on("select2-close",function(){if(rhEnvironmentService.isMobileView()){dropDown.find(".select2-drop-close").remove();dropDown.removeClass("select2-drop-mobile");var topLevelElements=$("body > header").siblings().addBack();if(!topLevelElements.length){topLevelElements=$("body > *");$(document.body).removeClass("rh")}topLevelElements.filter(function(){return!$(this).is("script")}).each(function(){$(this).css("top",$(this).is("#colorbox")?colorboxTop||"":"").css("position","").css("z-index",
"")});setTimeout(function(){$(window).scrollTop(scrollTop)})}})}if(ngModelCtrl)input.select2("data",ngModelCtrl.$modelValue);else input.select2("data",ratehub.user.location);if(!("required"in attrs)){var rhCitySelectorCtrl=controllers[1];rhCitySelectorCtrl.configureTooltip(input.select2("data"))}})}}});rh.ng.directive("rhAmortSelect",function(){return{restrict:"C",priority:100,require:"?ngModel",link:function(scope,elem,attrs,ngModelCtrl){scope.amortSelectOther=false;scope.$watch(attrs.ngModel,function(amort,
prevAmort){if(amort===prevAmort)return;if(amort=="other"){scope.amortSelectOther=true;ngModelCtrl.$setViewValue(prevAmort)}})}}});rh.ng.directive("rhCitySelector",function($timeout){function configureTooltip(location,automatic){var tooltip=this.tooltip;var tooltipOptions=this.tooltip.data("bs.popover").options;var originalContent=tooltipOptions.content;var firstHideTooltipHandler=function(){ratehub.user.location.status="selected";$.cookie("location",ratehub.user.location.id,{expires:365,path:"/"});
$.cookie("locationStatus","selected",{expires:365,path:"/"});tooltipOptions.content=originalContent;tooltip.off("hidden.bs.popover",firstHideTooltipHandler);automateTooltip(tooltip);$(".rh-city-selector").find(".rh-tooltip").popover("hide")};var tabPane=tooltip.closest(".tab-pane");var tab=tooltip.closest(".tab-content").prev("ul.nav.nav-tabs").find('a[href="#'+tabPane.attr("id")+'"]');var initializeTooltip=function(){if(!automatic&&location.status&&location.status!="selected"&&location.status!="geolocation"){tooltipOptions.content=
Globalize.localize("location-tooltip-uncertain");tooltip.popover("show");tooltip.on("hidden.bs.popover",firstHideTooltipHandler);tab.off("shown.bs.tab",initializeTooltip)}else automateTooltip(tooltip)};if(tab.length&&!tabPane.is(".active"))tab.on("shown.bs.tab",initializeTooltip);else initializeTooltip()}function automateTooltip(tooltip){var tooltipOptions=tooltip.data("bs.popover").options;tooltipOptions.title=$("<span>"+tooltipOptions.title+"</span>").text();tooltip.hover(function(){tooltip.popover("show")},
function(){tooltip.popover("hide")})}return{restrict:"C",link:function(scope,element,attrs,ctrl){ctrl.tooltip=element.find(".rh-tooltip")},controller:function($scope){this.configureTooltip=configureTooltip}}})})(jQuery);rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("rhAgentDisplay",function($sce){return{restrict:"C",controller:"AgentDisplayCtrl",link:function(scope,elem,attrs){}}});
rh.ng.controller("AgentDisplayCtrl",function($scope,rhHttpRequestService,rhConversionService){$scope.agent=null;$scope.inputs={city:ratehub.user.location};rhHttpRequestService.get({operation:"getAgentDisplayData",callback:true},function(data){$scope.agent=data;var googleUrl="https://www.google.ca/maps/dir//";var location=encodeURIComponent($scope.agent.address.join(","));$("#getDirections").attr("href",googleUrl+location);$scope.drawMap()});$scope.drawMap=function(){var mapContainer=$("#map .map")[0];
$scope.map=new rh.Map(mapContainer,{center:[$scope.agent.latitude,$scope.agent.longitude],callback:function(){delete $scope.agent.profile_href;$scope.map.addMarker($scope.agent)}})};$scope.isInvalid=function(elem){return elem.$invalid&&(!elem.$pristine||$scope.contactForm.submitted)};$scope.submitForm=function(){if($scope.contactForm.$valid){var $button=$("#contactForm button");$button.prop("disabled",true);var formData=$("#contactForm").serialize();formData+="&province="+$scope.inputs.city.province.code;
var options={serializedForm:formData,type:"agent",isPaid:true,product:{providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription},done:function(){$("#contactForm").load("/thankyou .main-content",function(){initFbSdk()})},fail:function(){$button.prop("disabled",false)}};rhConversionService.lead(options)}else $scope.contactForm.submitted=true}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("AgentFilterCtrl",function($scope,$sce,$timeout,rhHttpRequestService){var defaultLimit=10;$scope.limit=defaultLimit;$scope.location=null;rhHttpRequestService.get({callback:true,operation:"getAgentFilterData"},function(data){$.each(data,function(i,agent){agent.htmlAddress=$sce.trustAsHtml(agent.address.join("<br />"))});$scope.agents=data});$scope.toggleLimit=function(){$scope.limit=$scope.limit===defaultLimit?$scope.agents.length:defaultLimit;var tableExpandedHeight=$(".rh-agent-filter .rh-sortable-table").outerHeight();
if($scope.limit===defaultLimit)$timeout(function(){var distance="-="+(tableExpandedHeight-$scope.tableCollapsedHeight)+"px";$("html, body").animate({scrollTop:distance},{duration:400,easing:"easeOutExpo"})})};$scope.isAgentEligible=function(agent){if($scope.brand&&(!agent.brand||$scope.brand!=agent.brand))return false;if($scope.specialty&&(!agent.specialties||!agent.specialties[$scope.specialty]))return false;if($scope.language&&(!agent.languages||!agent.languages[$scope.language]))return false;return true};
$scope.selectAgent=function(agent,$event){if($($event.target).is("a"))return;$scope.selected=agent;$.each($scope.map.markers,function(i,marker){if(marker.context===$scope.selected)$scope.map.selectMarker(marker)});$timeout(function(){var top=$(".rh-agent-filter").offset().top;if($(window).scrollTop()>top){var distance="-="+($(window).scrollTop()-top)+"px";$("html, body").animate({scrollTop:distance},{duration:400,easing:"easeOutExpo"})}})};$scope.agentSelected=function(agent){return $scope.selected===
agent?Number.MAX_VALUE:0};$scope.agentLocal=function(agent){return agent.local?agent.local:false};$scope.agentReviews=function(agent){return agent.rating?agent.rating.count:0};$scope.updateResults=function(){if(!$scope.agents)return;var markers=[];var filteredAgents=$.grep($scope.agents,$scope.isAgentEligible);$scope.map.clearMarkers();if(filteredAgents.length>0){if(filteredAgents.length>$scope.limit){$scope.stub;$(".rh-agent-filter .rh-stub").show()}else $(".rh-agent-filter .rh-stub").hide();hideNoResultsMsg();
$scope.map.addMarker(filteredAgents,true);$timeout(function(){$scope.tableCollapsedHeight=$(".rh-agent-filter .rh-sortable-table").outerHeight()})}else{$(".rh-agent-filter .rh-stub").hide();showNoResultsMsg()}};$scope.$watch("[agents, brand, specialty, language]",function(newValue,oldValue){if(newValue!==oldValue)$scope.updateResults()},true);function showNoResultsMsg(){if($(".rh-agent-filter table tbody .no-results").length>0)return;var htmlMsg=$.parseHTML(ratehub.noBrokerMsg);var template='<tr class="no-results">'+
'<td colspan="5">'+htmlMsg[0].data+"</td>"+"</tr>";$(".rh-agent-filter table tbody").append(template)}function hideNoResultsMsg(){$(".rh-agent-filter table tbody .no-results").remove()}});
rh.ng.directive("rhAgentFilter",function($sce){return{restrict:"C",controller:"AgentFilterCtrl",link:{pre:function(scope,elem,attrs){scope.location=rh.Control.getInfo(elem).location},post:function(scope,elem,attrs){createMap(scope)}}};function createMap(scope){var center=null;var zoom=10;if(!scope.location.latitude){center=[scope.location.principal_city.latitude,scope.location.principal_city.longitude];zoom=7}else center=[scope.location.latitude,scope.location.longitude];var options={center:center,
zoom:zoom,callback:function(){scope.$apply(function(){scope.updateResults()})}};var element=$(".map");scope.map=new rh.Map(element[0],options);element.on("selectionChanged",function(event){scope.$apply(function(){scope.selected=scope.map.selected.context})})}});rh.ng.filter("filterAgents",function(){return function(agents,$scope){if(!agents)return;var filteredAgents=[];for(var i=0;i<agents.length;i++)if($scope.isAgentEligible(agents[i]))filteredAgents.push(agents[i]);return filteredAgents}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.controller("AllRatesCtrl",function(){});
rh.ng.controller("AllRatesTableCtrl",function($scope,$sce,$timeout,rhHttpRequestService,rhTipService,rhConversionService,rhEnvironmentService,mortgageService,eyeReturnService){var $=jQuery;$scope.restoring=false;$scope.order="value";$scope.isWidget=false;$scope.sorted=false;$scope.ad=null;$scope.featuredRatesEnabled=false;$scope.tableInitialized=false;$scope.customInputs=false;$scope.shouldSkipLeadForm=false;$scope.mortgageUserDetails={};loadMortgageUserDetails();var defaultLimit=6;$scope.rates={limit:defaultLimit,
data:null,terms:[]};$scope.inputs={scenario:"purchase",type:"fixed",term:5,location:ratehub.user.location,amortization:25,paymentFrequency:12,preApproval:"no",occupancy:"owner",cmhc:"yes"};$scope.type=function(){if($scope.inputs.scenario==="heloc")return"heloc";return $scope.inputs.type};$scope.termNotAvailable=function(){var available=false;$.each($scope.rates.terms,function(i,term){if($scope.inputs.term==term.term){available=true;return false}});return!available};$scope.purchase={homePrice:4E5,
downPaymentPercent:.15,downPayment:4E5*.15,mortgageAmount:function(){return mortgageService.getMortgageAmount($scope.purchase.homePrice,$scope.purchase.downPayment,$scope.inputs.amortization)}};$scope.renew={mortgageBalance:35E4};$scope.refinance={mortgageBalance:3E5,additionalEquity:0,totalMortgage:function(){return $scope.refinance.mortgageBalance+$scope.refinance.additionalEquity}};$scope.heloc={helocLimit:2E5};$scope.getStateObject=function(){return{scenario:$scope.inputs.scenario,type:$scope.inputs.type,
term:$scope.inputs.term}};$timeout(function(){if($scope.urlHasParams())$scope.setTableParamsFromUrl();$scope.$watch("[type(), inputs.term, inputs.scenario, inputs.location.id || inputs.location.code, inputs.amortization, inputs.paymentFrequency, inputs.preApproval, inputs.occupancy, inputs.cmhc, purchase.mortgageAmount(), renew.mortgageBalance, renew.amortization, refinance.totalMortgage(), heloc.helocLimit]",function(newValue,oldValue){if(angular.equals(oldValue,newValue)){if($scope.urlHasParams())$scope.setTableParamsFromUrl();
initializeRates();if(!$scope.isWidget&&typeof history.replaceState=="function")history.replaceState($scope.getStateObject(),"")}else fetchRates(newValue,oldValue)},true)});var initializeRates=function(){var rates=ratehub.allRatesTable.rates;for(var i=0;i<rates.length;i++){var d=new Date;d.setDate(d.getDate()+rates[i].rate_hold);rates[i].rate_hold=Globalize.format(d,"MMM d");rates[i].value=$scope.inputs.amortization>25&&typeof rates[i].premium_bps!="undefined"&&rates[i].premium_bps!=null?rates[i].value+
rates[i].premium_bps/100:rates[i].value}$scope.rates.data=rates;$scope.rates.terms=ratehub.allRatesTable.availableTerms;$scope.updateRates();if($scope.rates.data)eyeReturnService.getEyeReturnTagCode("best_mortgage_rate",{"rates":$scope.rates.data,"mortgage":true})};var fetchRates=function(newValue,oldValue){$scope.customInputs=$scope.customInputs||newValue[2]===oldValue[2];if($scope.type()==="variable"&&$scope.inputs.term!=="3")$scope.inputs.term=5;if(newValue[6]=="yes"&&oldValue[6]=="no"&&$scope.inputs.preApproval==
"yes")$scope.inputs.term=5;$timeout(function(){$(".rh-all-rates-table .nav-tabs li a[href='#"+$scope.inputs.scenario+"']").tab("show")});var blackout='<div class="rh-loading"></div>';$(".rh-sortable-table").append(blackout);var url=appendQueryParams(getAllRatesUrl({type:$scope.type(),term:$scope.inputs.term<1?5:$scope.inputs.term}),$scope.getQuotedRateParams(null));var options={url:url,data:{operation:"getAllRatesTableData"},done:function(data){$.extend(ratehub.allRatesTable,data);initializeRates();
$(".rh-all-rates-table .rh-sortable-table .rh-loading").remove();if(!$scope.restoring&&!$scope.isWidget&&typeof history.pushState=="function")history.pushState($scope.getStateObject(),"",url);else if($scope.restoring)$scope.restoring=false;if($scope.$parent){$("title").html(data.title);$scope.$parent.header=$sce.trustAsHtml(data.header);$scope.$parent.content=$sce.trustAsHtml(data.content);if(!ratehub.isWidget&&typeof ga==="function"){ga("set","page",url.replace(ratehub.serverUri,""));ga("send","pageview")}}eyeReturnService.getEyeReturnTagCode("rate_change",
{"rates":$scope.rates.data,"mortgage":true})}};if($scope.inputs.location)if($scope.inputs.location.id)options.data.city=$scope.inputs.location.id;else options.data.province=$scope.inputs.location.code;rhHttpRequestService.jsonp(options)};$scope.$watch("[inputs.amortization, purchase.downPaymentPercent]",function(){if($scope.inputs.scenario==="purchase")if($scope.inputs.amortization>25&&$scope.purchase.downPaymentPercent<.2){alert(Globalize.localize("maximum-amortization-period-adjusted-your-selection"));
$scope.inputs.amortization=25}else if($scope.inputs.amortization>35){alert(Globalize.localize("maximum-amortization-period-adjusted-your-selection-to-35"));$scope.inputs.amortization=35}},true);rhTipService.setType("allRatesTable");$scope.activateTip=rhTipService.activateTip;$scope.isTipActive=rhTipService.isTipActive;$scope.disableTips=rhTipService.disableTips;$scope.toggleLimit=function(){$scope.rates.limit=$scope.rates.limit===defaultLimit?$scope.rates.data.length:defaultLimit;var tableExpandedHeight=
$(".rh-all-rates-table .rh-sortable-table").outerHeight();if($scope.rates.limit===defaultLimit)$timeout(function(){var distance="-="+(tableExpandedHeight-$scope.tableCollapsedHeight)+"px";$("html, body").animate({scrollTop:distance},{duration:400,easing:"easeOutExpo"})})};$scope.showStub=function(){return $scope.rates.data?$scope.rates.data.length>defaultLimit:true};$scope.isHeloc=function(){var type=$scope.inputs.type;return type=="heloc"||type=="all-in-one"||type=="tout-en-un"};$scope.updateRates=
function(){if(!$scope.rates.data)return;if($scope.rates.data.length===0){$(".rh-stub .stub").hide();showNoResultsMsg()}else{$(".rh-stub .stub").show();hideNoResultsMsg()}var paymentFrequency=$scope.inputs.paymentFrequency.split(",");var periods=paymentFrequency[0];var divisor=paymentFrequency.length>1?paymentFrequency[1]:1;if($scope.inputs.scenario==="purchase")for(var i=0;i<$scope.rates.data.length;i++)$scope.rates.data[i].payment=can_mortgage_payment_purchase($scope.purchase.homePrice,$scope.purchase.downPayment,
$scope.rates.data[i].value/100,$scope.inputs.amortization,periods,divisor);else if($scope.inputs.scenario==="heloc"){var b=$scope.heloc.helocLimit;for(var i=0;i<$scope.rates.data.length;i++){var rate=$scope.rates.data[i];var r=rate.value/100;rate.payment=b*r/12;rate.lump_sum=null;rate.regular_payment=null}}else{var amortization=$scope.inputs.amortization;switch($scope.inputs.scenario){case "renew":var principal=$scope.renew.mortgageBalance;amortization=$scope.renew.amortization;break;case "refinance":var principal=
$scope.refinance.totalMortgage();break}for(var i=0;i<$scope.rates.data.length;i++)$scope.rates.data[i].payment=can_mortgage_payment(principal,$scope.rates.data[i].value/100,amortization,periods,divisor)}$timeout(function(){$scope.tableCollapsedHeight=$(".rh-all-rates-table .rh-sortable-table").outerHeight()});$timeout(function(){try{var autoSubmitJson=localStorage.getItem("mortgageWizard.shouldAutoSubmit");if(autoSubmitJson){var autoSubmitDetails=JSON.parse(autoSubmitJson);if(autoSubmitDetails){var autoSubmitTimeoutHasExpired=
dateWasCreatedMoreThanMinutesAgo(autoSubmitDetails.createdOn,5);if(!autoSubmitTimeoutHasExpired){var rate=false;for(var i=0;i<$scope.rates.data.length;i++)if($scope.rates.data[i].external_id===autoSubmitDetails.rateId)rate=$scope.rates.data[i];if(rate!==false)try{submitWithoutLeadForm(rate)}catch(e){console.error(e)}}}localStorage.removeItem("mortgageWizard.shouldAutoSubmit")}}catch(e$0){console.error(e$0)}})};function showNoResultsMsg(){if($(".rh-all-rates-table table tbody .no-results").length>
0)return;var htmlMsg=$.parseHTML(ratehub.noRatesMsg);var template='<tr class="no-results">'+'<td colspan="6">'+htmlMsg[0].data+"</td>"+"</tr>";$(".rh-all-rates-table table tbody").append(template)}function hideNoResultsMsg(){$(".rh-all-rates-table table tbody .no-results").remove()}$scope.sortSponsored=function(rate){return rate.sponsored?0:1};$scope.sortFeatured=function(rate){return rate.featured&&$scope.featuredRatesEnabled?0:1};$scope.isFeatured=function(rate){return rate.featured&&$scope.featuredRatesEnabled};
function submitWithoutLeadForm(rate){rate.submitting=true;var productType="mortgage";try{var formData={external_id:rate.external_id,featured:rate.featured,scenario:$scope.inputs.scenario,amortization:$scope.inputs.amortization,provider_id:rate.provider.id,name:$scope.mortgageUserDetails.name,phone:$scope.mortgageUserDetails.phone,email:$scope.mortgageUserDetails.email,city:$scope.inputs.location.id,product_type:productType,province:$scope.inputs.location.province.code,_token:ratehub.csrf};if(rate.scenario)formData.quoted_rate_id=
rate.id;else formData.rate_id=rate.id;if($scope.activeTab==="purchase"){formData.mortgage_type=$scope.inputs.preApproval==="yes"?"Pre-approval":"Purchase";formData.home_price=$scope.purchase.homePrice;formData.down_payment_percent=$scope.purchase.downPaymentPercent;formData.amount=$scope.purchase.homePrice-$scope.purchase.downPayment}else if($scope.activeTab==="renew"){formData.mortgage_type="Renewal";formData.amount=$scope.renew.mortgageBalance}else if($scope.activeTab==="refinance"){formData.mortgage_type=
"Refinance";formData.amount=$scope.refinance.mortgageBalance}else if($scope.activeTab==="heloc"){formData.mortgage_type="Access equity";formData.amount=$scope.heloc.helocLimit}var options={serializedForm:jQuery.param(formData),vertical:"mtg",type:productType,isPaid:true,product:{providerName:rate.provider.name,productDescription:rate.description},done:function(data){if(rate.featured&&!ratehub.isWidget)eyeReturnService.getEyeReturnTagCode("submit_request_button",{"subscribe":$scope.mortgageUserDetails.hasConsentedToNewsletterSubscription,
"productType":productType,"data":data,"mortgage":true});rate.submitted=true;rate.submitting=false}};rhConversionService.lead(options)}catch(e){rate.submitted=true;rate.submitting=false;console.error("Error setting formData",e);alert("Sorry, we've encountered an error while trying to submit your request. Please try again later.")}}function loadMortgageUserDetails(){$scope.shouldSkipLeadForm=false;$scope.mortgageUserDetails={};try{var userDetailsJson=localStorage.getItem("mortgageWizard.userDetails");
if(userDetailsJson){var userDetails=JSON.parse(userDetailsJson);if(userDetails){var userDetailsExpired=dateWasCreatedMoreThanMinutesAgo(userDetails.createdOn,1440);if(userDetailsExpired)localStorage.removeItem("mortgageWizard.userDetails");else if(userDetails.fullName&&userDetails.email&&userDetails.phoneNumber){$scope.mortgageUserDetails={name:userDetails.fullName,email:userDetails.email,phone:userDetails.phoneNumber,hasConsentedToNewsletterSubscription:userDetails.isSubscribing&&userDetails.isSubscribing===
true};$scope.shouldSkipLeadForm=true}}}}catch(e){console.error(e)}}function dateWasCreatedMoreThanMinutesAgo(date,minutesAgo){var date=new Date(date);var minutesAsMilliseconds=minutesAgo*60*1E3;var expiryDate=new Date(Date.now()-minutesAsMilliseconds);return date.getTime()<expiryDate.getTime()}$scope.applyForRate=function(event,rate,referrer){event.preventDefault();event.stopPropagation();if(rate.provider.preapproval_app_paid){window.parent.open(rhConversionService.getCloakedUrl(rate.provider.preapproval_app),
"_blank");var options={isPaid:rate.provider.preapproval_app_paid,type:"mortgage",product:{id:rate.id,providerName:rate.provider.name,productDescription:rate.description},referrer:referrer};rhConversionService.preApprovalClick(options)}else if(rate.featured&&$scope.shouldSkipLeadForm===true)submitWithoutLeadForm(rate,referrer);else{var params=$scope.getQuotedRateParams(rate);jQuery.extend(params,{widget:ratehub.isWidget,referrer:referrer});if(rate.featured||ratehub.isWidget||Globalize.culture().language===
"fr")if($scope.hideSubscribe)params["hide_subscribe"]=$scope.hideSubscribe;var dialogOptions={forcePopup:ratehub.isWidget};jQuery.extend(dialogOptions,{minHeight:700,height:800});rh.Dialog.show(appendQueryParams(rate.href,params),dialogOptions)}};$scope.appendQueryParams=function(href,params){return appendQueryParams(href,params)};$scope.getQuotedRateParams=function(rate){var amount=null;var params={"scenario":$scope.inputs.scenario};if(rate!==null&&typeof rate.posted!=="undefined"&&rate.posted!==
null)params["posted"]=rate.posted;if($scope.customInputs)switch(params.scenario){case "purchase":jQuery.extend(params,{"home_price":$scope.purchase.homePrice,"down_payment_percent":$scope.purchase.downPaymentPercent,"amount":$scope.purchase.mortgageAmount(),"amortization":$scope.inputs.amortization,"live_in_property":$scope.inputs.occupancy=="owner","pre_approval":$scope.inputs.preApproval=="yes"});break;case "renew":jQuery.extend(params,{"amount":$scope.renew.mortgageBalance,"live_in_property":$scope.inputs.occupancy==
"owner","cmhc":$scope.inputs.cmhc=="yes"});break;case "refinance":jQuery.extend(params,{"amount":$scope.refinance.mortgageBalance+$scope.refinance.additionalEquity,"live_in_property":$scope.inputs.occupancy=="owner"});break;case "heloc":jQuery.extend(params,{"amount":$scope.heloc.helocLimit})}return params};$scope.setTableParamsFromUrl=function(){var quotedRateParams=parseUrlParams(window.location.search);if(quotedRateParams.down_payment_percent)$scope.purchase.downPaymentPercent=parseFloat(quotedRateParams.down_payment_percent);
if(quotedRateParams.home_price)$scope.purchase.homePrice=parseInt(quotedRateParams.home_price);if(quotedRateParams.amortization)$scope.inputs.amortization=quotedRateParams.amortization;if(quotedRateParams.live_in_property)$scope.inputs.occupancy=quotedRateParams.live_in_property=="true"?"owner":"renter";if(quotedRateParams.pre_approval)$scope.inputs.preApproval=quotedRateParams.pre_approval=="true"?"yes":"no";if(quotedRateParams.cmhc)$scope.inputs.cmhc=quotedRateParams.cmhc=="true"?"yes":"no"};$scope.urlHasParams=
function(){return window.location.search!==""};$scope.$on("tableSorted",function(event,type){if(type)$scope.order=type;$scope.sorted=true})});
rh.ng.directive("rhAllRatesTable",function($sce,rhEnvironmentService){var $=jQuery;return{restrict:"C",controller:"AllRatesTableCtrl",link:{pre:function(scope,elem,attrs){scope.isWidget=rhEnvironmentService.isWidgetView(elem);scope.ad=ratehub.ads?ratehub.ads.tags[rhEnvironmentService.isMobileView()?"mobile-leaderboard-chart":"leaderboard-all-rates"]:null;if(scope.ad)scope.ad.empty=false;scope.featuredRatesEnabled=typeof attrs.featuredRates!=="undefined";scope.inputs.scenario=elem.find(".nav-tabs li.active a").attr("href").substring(1);
if(scope.inputs.scenario==="heloc")scope.inputs.type="heloc";if(scope.$parent){scope.$parent.header=$sce.trustAsHtml(elem.closest("main").find("h1").html());scope.$parent.content=$sce.trustAsHtml(elem.closest("main").find(".content").html())}scope.hideSubscribe=typeof attrs.hideSubscribe!=="undefined"},post:function(scope,elem,attrs){elem.find(".nav-tabs li").on("shown.bs.tab",function(event){var s=$(event.target).attr("href").substring(1);scope.$apply(function(){scope.inputs.scenario=s})});$(window).bind("popstate",
function(event){event.preventDefault();var state=event.originalEvent.state;if(state)scope.$apply(function(){scope.restoring=true;scope.inputs.scenario=state.scenario;scope.inputs.type=state.type;scope.inputs.term=state.term})})}}}});
rh.ng.directive("rhAllRatesTableAdRow",function(rhEnvironmentService){if(rhEnvironmentService.isMobileView())var tmpl='<td colspan="4" class="leaderboard">'+'\t<div id="mobile-leaderboard-chart"></div>'+"</td>";else var tmpl='<td colspan="6" class="leaderboard">'+'\t<div id="leaderboard-all-rates"></div>'+"</td>";return{restrict:"A",template:tmpl,link:function(scope,elem){var onSlotRendered=function(){googletag.pubads().addEventListener("slotRenderEnded",function(event){if(event.slot===scope.ad.slot){scope.$apply(function(){scope.ad.empty=
event.isEmpty});$(document.body).off("ratehub.googletag",onSlotRendered)}})};$(document.body).on("ratehub.googletag",onSlotRendered);if(typeof googletag!="undefined"&&scope.ad)if(!scope.ad.slot){scope.ad.slot=googletag.defineSlot(scope.ad[0],scope.ad[1],scope.ad[2]).addService(googletag.pubads());googletag.display(scope.ad[2])}else if(!scope.ad.slot.empty)googletag.pubads().refresh()}}});jQuery(function($){$(".rh-collapsible-static-table").each(function(){var $self=$(this);var slideTime=400;var animation="easeOutExpo";var limit=$(this).find(".rh-stub").attr("data-limit");if($self.hasClass("collapsed"))$self.find(".toggle-content").hide();$self.find(".rh-banner").click(function(){$self.toggleClass("collapsed");$self.find(".toggle-content").slideToggle(slideTime,animation)});$self.find(".rh-stub .stub").click(function(){if(!limit){$self.toggleClass("collapsed");$self.find(".toggle-content").slideToggle(slideTime,
animation)}})})});rh.ng.controller("CollapsibleStaticTableGroupCtrl",function($scope,$element){$element.find('a[data-toggle="tab"]').each(function(){var tabPane=$(this).attr("href");$(this).on("shown.bs.tab",function(){$(tabPane).find(".rh-stub").trigger("render")})})});jQuery(function($){var animationTime=400;var showElement=function(selector){$(this).find(selector).show(0);$(this).find(selector).stop().animate({opacity:1},animationTime)};var hideElement=function(selector){$(this).find(selector).hide(0);$(this).find(selector).stop().animate({opacity:0},animationTime)};$(".rh-bio").each(function(index,item){var originalHeight=$(this).find(".slider").outerHeight();$(this).hover(function(){$(this).find(".slider").stop().animate({height:"100%"},animationTime,"easeOutExpo",
showElement.call(this,".description, .contact"));hideElement.call(this,".title")},function(){$(this).find(".slider").stop().animate({height:originalHeight},animationTime,"easeOutExpo",hideElement.call(this,".description, .contact"));showElement.call(this,".title")})})});rh=window.rh||{};jQuery("body").on("ratehub.initialized",function($){rh.Control.poll(500,10,function(){if(!rh.Chart.loaded)return false;for(chartId in rh.Chart.charts){var chart=rh.Chart.charts[chartId];if(!chart.initialized)return false}return true},function(){rh.Chart.fetchData()})});
rh.Chart=function(params){if(!rh.Chart.loaded)jQuery(function($){$.ajax({dataType:"script",cache:true,url:ratehub.serverUri+"/vendor/highcharts/highcharts.js",success:function(){if(!rh.Chart.loaded){rh.Chart.loaded=true;jQuery.each(rh.Chart.charts,function(i,chart){chart.initialize()})}}})});this.id=params.id;this.title=params.title;this.delayed=params.delayed;eval(params.options);this.options=options;this.series=options.series;options.series=[];if(this.series.length>1)delete options.chart.type;this.chart=
null;this.initialized=false;this.hasRequestedData=false;var self=this;self.initialize()};rh.Chart.prototype.addSeries=function(series){if(this.chart&&typeof this.chart.addSeries=="function")this.chart.addSeries(series,false,true);else this.options.series.push(series)};
rh.Chart.prototype.initialize=function(){rh.Chart.charts[this.id]=this;if(!rh.Chart.loaded||this.initialized)return;var target=jQuery("#"+this.id);if(target.length===0){this.initialized=true;return}var options=this.options;if(options=="error"||options===null)return;if(typeof options.chart=="undefined")options.chart={};if(typeof options.title=="undefined")options.title={};options.title.text=this.title||"";options.chart.renderTo=target[0];if(!this.delayed)this.chart=new Highcharts.Chart(options);this.initialized=
true};rh.Chart.prototype.renderDelayed=function(){if(!this.chart)this.chart=new Highcharts.Chart(this.options)};rh.Chart.charts={};rh.Chart.jsonpDispatch=function(data){rh.Chart.charts[data.reflection.id].loadData(data)};
rh.Chart.fetchData=function(){for(var i in rh.Chart.charts){var chart=rh.Chart.charts[i];if(chart.hasRequestedData)continue;chart.hasRequestedData=true;var options=chart.options;var series=chart.series;var fields=[];var startDate=null;var endDate=null;if(typeof options!="undefined"&&typeof options.dateRange!="undefined"){startDate=options.dateRange.start;endDate=options.dateRange.end}for(var j=0;j<series.length;j++)if(typeof series[j].data=="string"){var field=series[j].data;fields.push(field)}else chart.addSeries(series[j]);
if(fields.length===0)continue;var params={id:chart.id,series:fields.join(" ")};if(startDate)params["start"]=startDate;if(endDate)params["end"]=endDate;var url=ratehub.serverUri+"/api/charts";(function(i,url){chart.loadData=function(data){if(data.error)return;var dates=data.date;var series=this.series;for(var j=0;j<series.length;j++)try{if(typeof series[j].data=="string"){var a=series[j].data.split(".",3);var seriesName=a[0]+"-"+a[1];var plotData=[];if(a.length==2){var d=data[seriesName];for(var k=
0;k<d.length;k++)if(d[k]!==null)plotData.push([dates[k],d[k]])}else{var stat=a[2];plotData.push([dates[0],data.stats[seriesName][stat]]);plotData.push([dates[dates.length-1],data.stats[seriesName][stat]])}series[j].data=plotData;this.addSeries(series[j])}}catch(e){}if(this.chart)this.chart.redraw()};jQuery.ajax({url:url,data:params,type:"GET",dataType:"jsonp",jsonpCallback:"rh.Chart.jsonpDispatch",cache:true})})(i,url)}};rh.Chart.renderDelayed=function(chart){chart.renderDelayed()};rh.ng.directive("rhChequingAccount",function(){var tmpl='<span class="rh-provider">'+'<span class="provider-logo">'+'<img ng-attr-src="{{account.provider.logo}}" />'+"</span>"+'<a class="provider-name" ng-attr-href="{{account.href}}">'+"{{account.name}}"+"</a>"+"</span>";return{restrict:"A",scope:{account:"=rhChequingAccount"},replace:true,template:tmpl}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("chequingApplication",function(rhEnvironmentService){return{restrict:"C",controller:"ChequingApplicationCtrl",link:function(scope,elem,attrs){scope.elem=elem;scope.renderTable();if(rhEnvironmentService.isMobileView(elem))scope.doMobile()}}});
rh.ng.controller("ChequingApplicationCtrl",function($scope,$compile,rhConversionService,rhEnvironmentService){var $=jQuery;$scope.site=null;$scope.submitApplication=function(){var alreadyInPopup,href,alreadyCalled=false;function redirect(){if(alreadyCalled)return;alreadyCalled=true;if(alreadyInPopup)window.location=href;else{var options={className:"rh-popup",isMobile:rhEnvironmentService.isMobileView()};rh.Dialog.openAsPopup(rh.Dialog.createLink(href,true),options)}}if($scope.detailsForm.$valid){$("#detailsForm button[type=submit]").attr("disabled",
true);var formData=$("#detailsForm").serialize();var options={serializedForm:formData,type:"chequing",isPaid:true,product:{providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription},done:function(data){alreadyInPopup=$(".rh.is-iframe").length>0;href=rhConversionService.getThankyouUrl("gic",data);redirect()}};rhConversionService.lead(options);window.open($scope.site,"_blank")}else $scope.detailsForm.submitted=true};$scope.isInvalid=function(elem){return elem.$invalid&&
(elem.$dirty||$scope.detailsForm.submitted)};$scope.isMobile=function(){return rhEnvironmentService.isMobileView()}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("chequingDetails",function(rhEnvironmentService){return{restrict:"C",controller:"ChequingDetailsCtrl",link:function(scope,elem,attrs){scope.elem=elem;scope.renderTable()}}});
rh.ng.controller("ChequingDetailsCtrl",function($scope,$compile,chequingService){var $=jQuery;$scope.isChequingDetailsView=true;$scope.french=Globalize.culture().language==="fr";$scope.account=$scope.$parent.account||ratehub.chequingAccounts[0];$scope.estimatedCost=null;$scope.additionalFees=null;$scope.rebate=null;$scope.firstCall=true;$scope.expansions={"additionalFees":false,"rebates":false};$scope.filters={"transactions":$scope.$parent.$parent?$scope.$parent.$parent.$parent.filters.transactions:
15,"balance":$scope.$parent.$parent?$scope.$parent.$parent.$parent.filters.balance:500,"transactionsByType":$scope.$parent.$parent?$scope.$parent.$parent.$parent.filters.transactionsByType:{"debit":8,"bill":3,"eTransfer":0,"atm":3,"cheque":1,"teller":0}};$scope.applyForAccount=chequingService.applyForAccount;$scope.renderTable=function(update){if($scope.firstCall){$scope.setRebate();$scope.firstCall=false}if(update==="monthlyTransactions")$scope.updateTransactionsByType();else if(update==="transactionsByType")$scope.updateMonthlyTransactions();
$scope.additionalFees=$scope.getAdditionalFeesTotal();$scope.estimatedCost=$scope.getEstimatedMonthlyCost()};$scope.updateMonthlyTransactions=function(){$scope.filters.transactions=chequingService.getMonthlyTransactions($scope.filters.transactionsByType)};$scope.updateTransactionsByType=function(){$scope.filters.transactionsByType=chequingService.getTransactionsByType($scope.filters.transactions)};$scope.getRebate=function(){return chequingService.getRebate($scope.account,$scope.filters.balance,$scope.filters.transactionsByType,
$scope.getTableType())};$scope.setRebate=function(){$scope.rebate=chequingService.getRebate($scope.account,$scope.filters.balance,$scope.filters.transactionsByType,$scope.getTableType())};$scope.getEstimatedMonthlyCost=function(){return chequingService.getEstimatedMonthlyCost($scope.account,$scope.filters.transactionsByType,$scope.filters.balance,$scope.getTableType())};$scope.getAdditionalFeesTotal=function(){return chequingService.getAdditionalFees($scope.account,$scope.filters.transactionsByType)};
$scope.getAdditionalFee=function(fee,transactions,limit,type){return chequingService.getAdditionalFee(fee,transactions,limit,type)};$scope.applyForAccount=function(event,account){chequingService.applyForAccount(event,account,$scope.filters.balance,true)};$scope.getInterestAtBalance=function(){return chequingService.getInterestAtBalance($scope.account.other_services.interest,$scope.filters.balance)};$scope.getMonthlyFee=function(){var monthlyFee=$scope.account.monthly_fees.monthly_fee;if(!$scope.$parent.isChequingTableView)return monthlyFee;
var type=$scope.getTableType();if(type==="senior"&&$scope.account.monthly_fees.senior_monthly_fee!=="n/a")return $scope.account.monthly_fees.senior_monthly_fee;if(type==="student"&&$scope.account.monthly_fees.student_monthly_fee!=="n/a")return $scope.account.monthly_fees.student_monthly_fee;return monthlyFee};$scope.getTableType=function(){if(!$scope.$parent.isChequingTableView)return null;if(window.location.pathname.indexOf("/accounts/student")!==-1||window.location.pathname.indexOf("/comptes/etudiant")!==
-1)return"student";if(window.location.pathname.indexOf("/accounts/senior")!==-1||window.location.pathname.indexOf("/comptes/aines")!==-1)return"senior";return null};$scope.getMonthlyFeeString=function(fee){if(fee==="multiproduct"&&$scope.account.monthly_fees.multiproduct_monthly_fee!=="n/a")return Globalize.localize("multi-product-monthly-fee",null,Globalize.format($scope.account.monthly_fees.multiproduct_monthly_fee,"c2"));else if(fee==="student"&&$scope.account.monthly_fees.student_monthly_fee!==
"n/a")return Globalize.localize("student-monthly-fee",null,Globalize.format($scope.account.monthly_fees.student_monthly_fee,"c2"));else if(fee==="senior"&&$scope.account.monthly_fees.senior_monthly_fee!=="n/a")return Globalize.localize("senior-monthly-fee",null,Globalize.format($scope.account.monthly_fees.senior_monthly_fee,"c2"));return null}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("ChequingHeadCtrl",function($scope,chequingService){$scope.french=Globalize.culture().language==="fr";$scope.balance=500;$scope.transactions=15;$scope.location=ratehub.user.location?ratehub.user.location:null;$scope.findChequing=function(event){event.preventDefault();event.stopPropagation();var url=chequingService.getUrl({type:$scope.type!=="all"?chequingService.localizeType($scope.type):null,transactions:$scope.transactions,balance:$scope.balance});window.location=url}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("AllChequingTableCtrl",function($scope,$sce,chequingService,rhHistoryService,rhHttpRequestService){var $=jQuery;var CHEQUING_ACCCOUNT_TYPE_ALL=0;var CHEQUING_ACCCOUNT_TYPE_PERSONAL=1;var CHEQUING_ACCCOUNT_TYPE_YOUTH=2;var CHEQUING_ACCCOUNT_TYPE_STUDENT=3;var CHEQUING_ACCCOUNT_TYPE_SENIOR=4;var CHEQUING_ACCCOUNT_TYPES=[{index:CHEQUING_ACCCOUNT_TYPE_ALL,key:"all"},{index:CHEQUING_ACCCOUNT_TYPE_PERSONAL,key:"personal"},{index:CHEQUING_ACCCOUNT_TYPE_YOUTH,key:"youth"},{index:CHEQUING_ACCCOUNT_TYPE_STUDENT,
key:"student"},{index:CHEQUING_ACCCOUNT_TYPE_SENIOR,key:"senior"}];$scope.accounts={};$scope.filters={"location":ratehub.user.location,"balance":500,"transactions":15,"transactionsByType":{"debit":8,"bill":3,"eTransfer":0,"atm":3,"cheque":1,"teller":0},"promoOffers":{},"type":CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_ALL].key};$scope.filters["promoOffers"][CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_ALL].key]=false;$scope.filters["promoOffers"][CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_PERSONAL].key]=
false;$scope.filters["promoOffers"][CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_YOUTH].key]=false;$scope.filters["promoOffers"][CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_STUDENT].key]=false;$scope.filters["promoOffers"][CHEQUING_ACCCOUNT_TYPES[CHEQUING_ACCCOUNT_TYPE_SENIOR].key]=false;$scope.isLoading=false;$scope.restoring=false;$scope.defaultLimit=6;$scope.limit=$scope.defaultLimit;$scope.isLoading=false;$scope.order="estimated_monthly_cost";$scope.secondOrder="-transactions.number_of_monthly_transactions";
$scope.thirdOrder="additional_fees.debit.over_fee";$scope.firstCall=true;$scope.numAccounts=null;$scope.sorted=false;$scope.french=Globalize.culture().language==="fr";$scope.featuredChequingEnabled=false;$scope.getCurrentPromoFilterModel=function(){return $scope.filters.type};$scope.renderTable=function(update,trackPage){if(typeof trackPage==="undefined")trackPage=true;if(update==="monthlyTransactions"||$scope.firstCall){$scope.updateTransactionsByType();$scope.firstCall=false}else if(update==="transactionsByType")$scope.updateMonthlyTransactions();
var url=chequingService.getUrl({provider:$scope.filters.provider!=="all"?$scope.filters.provider:null,type:$scope.filters.type!=="all"?chequingService.localizeType($scope.filters.type):null});var options={url:url,data:{operation:"getAllChequingTableData"},done:function(response){if(!$scope.restoring){rhHistoryService.pushState($scope.getStateObject(),null,url);if(trackPage&&!ratehub.isWidget&&typeof ga==="function"){ga("set","page",url.replace(ratehub.serverUri,""));ga("send","pageview")}}else $scope.restoring=
false;$scope.accounts=$scope.filterAccounts(response.accounts)||[];$scope.isLoading=false;if($scope.$parent){$("title").html(response.title);$scope.$parent.header=$sce.trustAsHtml(response.header);$scope.$parent.content=$sce.trustAsHtml(response.content)}}};$scope.isLoading=true;if(ratehub.isWidget)options.data.isWidget=true;rhHttpRequestService.jsonp(options)};$scope.getStateObject=function(){return{type:$scope.filters.type,provider:$scope.filters.provider}};$scope.toggleLimit=function(){$scope.limit=
$scope.limit===$scope.defaultLimit?$scope.accounts.length:$scope.defaultLimit};$scope.isUndefined=function(val){return typeof val==="undefined"};$scope.applyForAccount=function(event,account){chequingService.applyForAccount(event,account,$scope.filters.balance,false)};$scope.sortSponsored=function(account){return account.sponsored?0:1};$scope.showTiers=function($event){chequingService.showTiers($event)};$scope.hideTiers=function($event){chequingService.hideTiers($event)};$scope.filterAccounts=function(accounts){var filteredAccounts=
[];var promoOffers=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];var type=$scope.filters.type;var balance=$scope.filters.balance;$scope.numAccounts=accounts.length;for(var i=0;i<$scope.numAccounts;i++)if(accounts[i]!==undefined){if(!accounts[i].sponsored){if($scope.filters.noMonthlyFee){if(type!=="student"&&type!=="senior"&&accounts[i].monthly_fees.monthly_fee>0)continue;if(type==="student"&&(accounts[i].monthly_fees.student_monthly_fee!=="n/a"&&accounts[i].monthly_fees.student_monthly_fee>
0||accounts[i].monthly_fees.student_monthly_fee==="n/a"&&accounts[i].monthly_fees.monthly_fee>0))continue;if(type==="senior"&&(accounts[i].monthly_fees.senior_monthly_fee!=="n/a"&&accounts[i].monthly_fees.senior_monthly_fee>0||accounts[i].monthly_fees.senior_monthly_fee==="n/a"&&accounts[i].monthly_fees.monthly_fee>0))continue}if($scope.filters.earnsInterest&&accounts[i].other_services.interest.initial<=0)continue;if(promoOffers&&!accounts[i].promo_offers.promo_on)continue}if(Object.keys(accounts[i].provider.provinces_served).length>
0&&!accounts[i].provider.provinces_served.hasOwnProperty($scope.filters.location.province.code))continue;accounts[i].estimated_monthly_cost=chequingService.getEstimatedMonthlyCost(accounts[i],$scope.filters.transactionsByType,balance,type);accounts[i].initialInterest=chequingService.getInterestAtBalance(accounts[i].other_services.interest,balance);filteredAccounts.push(accounts[i])}return filteredAccounts};$scope.updateMonthlyTransactions=function(){$scope.filters.transactions=chequingService.getMonthlyTransactions($scope.filters.transactionsByType)};
$scope.updateTransactionsByType=function(){$scope.filters.transactionsByType=chequingService.getTransactionsByType($scope.filters.transactions)};$scope.getEstimatedMonthlyCost=function(account){return chequingService.getEstimatedMonthlyCost(account,$scope.filters.transactionsByType,$scope.filters.balance,$scope.filters.type)};$scope.initializeFilters=function(){var params=parseUrlParams();$scope.filters.balance=params.balance?params.balance:500;$scope.filters.transactions=params.transactions?params.transactions:
15;$scope.filters.type="all";var type=window.location.pathname.match(/\/(comptes|accounts)\/(regulier|personal|jeunesse|youth|etudiant|student|aines|senior)/);if(type&&type.length>2)switch(type[2]){case "personal":case "regulier":$scope.filters.type="personal";break;case "youth":case "jeunesse":$scope.filters.type="youth";break;case "student":case "etudiant":$scope.filters.type="student";break;case "senior":case "aines":$scope.filters.type="senior";break;default:}};$scope.sortFeatured=function(account){return account.featured&&
$scope.featuredChequingEnabled?0:1};$scope.isFeatured=function(account){return account.featured&&!account.sponsored&&$scope.featuredChequingEnabled};$scope.displayPFAIcon=function(account){return account.pfa_winner&&ratehub.user.language!=="fr"&&ratehub.experiments&&ratehub.experiments.chequing&&ratehub.experiments.chequing.chqPFAIconTest&&ratehub.experiments.chequing.chqPFAIconTest===1};$scope.displayTransactionCategories=function(){if(ratehub.experiments.chequing.chqTransactionsTest===1&&$(".rh-toggle-bar.is-open").length===
0)$(".rh-toggle-bar").click()};$scope.$on("tableSorted",function(event,type){if(type)$scope.order=type;$scope.sorted=true});$scope.$watch("filters.promoOffers",function(){$scope.renderTable(null,false)},true);$scope.hasPromoOffers=function(){var showPromoOffersChecked=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];var hasAtLeastOnePromoOffer=$scope.accounts.length&&$scope.accounts.some(function(account){return account.promo_offers.promo_on});return showPromoOffersChecked||hasAtLeastOnePromoOffer}});
rh.ng.directive("allChequingTable",function($sce,$timeout,rhHistoryService){var $=jQuery;return{restrict:"C",controller:"AllChequingTableCtrl",link:{pre:function(scope,elem,attrs){scope.featuredChequingEnabled=typeof attrs.featuredChequing!=="undefined"},post:function(scope){scope.initializeFilters();scope.accounts=ratehub.chequingAccounts||{};scope.numAccounts=scope.accounts.length;if(!ratehub.isWidget)rhHistoryService.replaceState(scope.getStateObject(),"");scope.renderTable(null,false);$(window).bind("popstate",
function(event){event.preventDefault();var state=event.originalEvent.state;if(state)scope.$apply(function(){scope.restoring=true;scope.filters.type=state.type;scope.filters.provider=state.provider;scope.renderTable(null,false)})})}}}});rh.ng.directive("allChequingTableNoResults",function(){var template='<tr ng-show="accounts.length === 0">'+"<td>"+"<p>"+ratehub.noResultsMsg+"</p>"+"</td>"+"</tr>";return{restrict:"C",replace:true,template:template}});
rh.ng.directive("allChequingTableRow",function($compile,rhHttpRequestService){var $=jQuery;return{restrict:"A",scope:{account:"=allChequingTableRow"},link:function(scope,row){scope.accountDetailsMarkup=null;scope.showingDetails=false;row.find("[toggle-details-collapse]").on("click",function(event){event.preventDefault();event.stopPropagation();if(scope.showingDetails)return;scope.showingDetails=true;scope.isChequingTableView=true;var height=row.find("td").outerHeight();var tmpl='<td colspan="7" class="all-chequing-table__results__details">'+
'<a class="details-header" href="javascript:void(0);">'+'<span class="name" style="height:'+height+'px;">'+scope.account.name+"</span>"+'<span class="chevron">'+'<i class="fa fa-fw fa-chevron-up"></i>'+"</span>"+"</a>"+'<div class="details-description"></div>'+"</td>";row.find("td, th").fadeOut().promise().then(function(){row.append(tmpl);row.find(".details-header > *").hide().fadeIn();var options={url:scope.account.href,data:{details:true},done:function(data){scope.accountDetailsMarkup=data;scope.display=
1;showChequingDetails(scope,row)}};if(ratehub.isWidget)options.data.isWidget=true;rhHttpRequestService.jsonp(options)})})}};function showChequingDetails(scope,row){row.find(".all-chequing-table__results__details .details-header").click(function(){hideChequingDetails(scope,row);scope.showingDetails=false});var container=row.find(".all-chequing-table__results__details .details-description");container.html(scope.accountDetailsMarkup);$compile(container)(scope);container.hide().slideDown();if(!ratehub.isWidget&&
typeof ga==="function"){ga("set","page",scope.account.href.replace(ratehub.serverUri,""));ga("send","pageview")}}function hideChequingDetails(scope,row){delete scope.accountDetailsMarkup;row.find(".all-chequing-table__results__details .details-description").slideUp();row.find(".all-chequing-table__results__details").fadeOut().promise().then(function(){row.find(".all-chequing-table__results__details").remove();row.find("td, th").fadeIn()})}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.controller("BestChequingCtrl",function($scope){$scope.filters={"balance":500,"transactions":20,"location":ratehub.user.location};$scope.calcChequing=function(){$scope.$broadcast("update",$scope.filters)}});
rh.ng.controller("BestChequingTableCtrl",function($scope,chequingService){$scope.defaultLimit=5;$scope.limit=$scope.defaultLimit;$scope.order="estimated_monthly_cost";$scope.secondOrder="-transactions.number_of_monthly_transactions";$scope.toggleLimit=function(){$scope.limit=$scope.limit===$scope.defaultLimit?$scope.accounts.length:$scope.defaultLimit};$scope.setType=function(type){$scope.type=type;$scope.accounts=$scope.filterAccounts(ratehub[$scope.type],{"balance":500,"transactions":20})};$scope.filterAccounts=
function(accounts,filters){var filteredAccounts=[];var balance=filters.balance;var transactions=filters.transactions;for(var i=0;i<Object.keys(accounts).length;i++)if(accounts[i]!==undefined){if(Object.keys(accounts[i].provider.provinces_served).length>0&&!accounts[i].provider.provinces_served.hasOwnProperty($scope.filters.location.province.code))continue;accounts[i].estimated_monthly_cost=chequingService.getEstimatedMonthlyCost(accounts[i],chequingService.getTransactionsByType(transactions),balance,
$scope.type.split("Account")[0]);accounts[i].initialInterest=chequingService.getInterestAtBalance(accounts[i].other_services.interest,$scope.filters.balance);filteredAccounts.push(accounts[i])}return filteredAccounts};$scope.getEstimatedMonthlyCost=function(account){return chequingService.getEstimatedMonthlyCost(account,chequingService.getTransactionsByType($scope.filters.transactions),$scope.filters.balance,$scope.type.split("Account")[0])};$scope.applyForAccount=function(event,account){chequingService.applyForAccount(event,
account,$scope.filters.balance,false)};$scope.showTiers=function($event){chequingService.showTiers($event)};$scope.hideTiers=function($event){chequingService.hideTiers($event)};$scope.$on("update",function(event,filters){$scope.accounts=$scope.filterAccounts(ratehub[$scope.type],filters)})});rh=window.rh||{};rh.Control=rh.Control||{};rh.Control.poll=function poll(period,limit,predicate,success,count){if(!count)count=0;if(!predicate()){if(count<limit)setTimeout(function(){poll(period,limit,predicate,success,++count)},period)}else success()};rh.Control.get=function(element){var controlInfo=rh.Control.getInfo(element);if(controlInfo&&controlInfo.__instance)return controlInfo.__instance};
rh.Control.getInfo=function(element){var id=null;if(typeof element.attr==="function")id=element.attr("id");else id=element.id;return ratehub.controls[id]};
rh.Control.init=function(controls){controls=controls||ratehub.controls;for(var controlId in controls)if(controls[controlId].__class){if(controls[controlId].__instance)continue;var controlClass=controls[controlId].__class;var controlParams=controls[controlId];if(typeof rh[controlClass]=="function")controls[controlId].__instance=new rh[controlClass](controlParams)}else{var controlClass=controlId;var controlParams=ratehub.controls[controlClass].__static;if(typeof rh[controlClass]!="undefined"&&typeof rh[controlClass].init==
"function")rh[controlClass].init(controlParams);else{var namespace=controlClass.charAt(0).toLowerCase()+controlClass.slice(1);if(typeof rh[namespace]!="undefined"&&typeof rh[namespace].init=="function")rh[namespace].init(controlParams)}}jQuery("body").trigger("ratehub.initialized")};rh.ng.directive("rhCreditCard",function(){var tmpl='<div class="control credit-card">'+'<div class="credit-card__image">'+'<img ng-attr-src="{{card.card_image}}" ng-attr-alt="{{card.name}}" />'+"</div>"+'<div class="credit-card__description">'+'<a class="name" ng-attr-href="{{card.href}}" ng-bind="card.name"></a>'+"</div>"+"</div>";return{restrict:"A",scope:{card:"=rhCreditCard"},template:tmpl}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("CcCalcCtrl",function($scope,creditCardService){$scope.addResult=function(optionalCardSlug){$scope.cards[$scope.cardIdPool]=creditCardService.getEmptyCreditCard();$scope.cards[$scope.cardIdPool].resultId=$scope.cardIdPool;if(optionalCardSlug)$scope.cards[$scope.cardIdPool].initAs=optionalCardSlug;$scope.cardIdPool++;$scope.signupBonusExpand=false;$scope.oneTimeBonusExpand=false;$scope.spendingRewardExpand=false};$scope.resetResults=function(){$scope.cards={};$scope.cardIdPool=0};
$scope.makeCardDropdown=function(cardRules){var cardDropdown=[{id:0,text:Globalize.localize("select-card")}];for(var i=0;i<cardRules.length;i++){var tmp={id:i+1,text:cardRules[i].name,slug:cardRules[i].slug};cardDropdown.push(tmp)}return cardDropdown};$scope.getCardRules=function(cardDropdownElement){if(cardDropdownElement.id<1)return false;else return $scope.cardRules[cardDropdownElement.id-1]};$scope.makeTypeDropdown=function(){var typeDropdown=[{id:0,text:Globalize.localize("cash-back-title"),
value:"Cash back",disabled:true},{id:1,text:Globalize.localize("store-credit-title"),value:"Store credit",disabled:true},{id:2,text:Globalize.localize("travel-title"),value:"Travel",disabled:true}];return typeDropdown};$scope.setCards=function(cards){if(!cards)return;$scope.resetResults();for(var i=0;i<cards.length;i++)$scope.addResult(cards[i])};$scope.getNumberOfSpendingRewards=function(firstYearRewards){return new Array($scope.numberOfSpendingRewards[firstYearRewards?"firstYear":"subsequentYears"])};
$scope.updateSpendingRewardsDisplay=function(card){$scope.numberOfSpendingRewards.firstYear=1;$scope.numberOfSpendingRewards.subsequentYears=1;for(var scopeCardIndex in $scope.cards){$scope.numberOfSpendingRewards.firstYear=Math.max($scope.numberOfSpendingRewards.firstYear,$scope.cards[scopeCardIndex].firstYearRewards.length,card?card.firstYearRewards.length:0);$scope.numberOfSpendingRewards.subsequentYears=Math.max($scope.numberOfSpendingRewards.subsequentYears,$scope.cards[scopeCardIndex].subsequentYearRewards.length,
card?card.subsequentYearRewards.length:0)}$scope.$broadcast("updateDisplayedSpendingRewards",$scope.numberOfSpendingRewards.firstYear,$scope.numberOfSpendingRewards.subsequentYears)};$scope.$watch("spending",function(newProfile,oldProfile){if(newProfile===oldProfile)return;else $scope.$broadcast("updateSpending")},true);$scope.$on("updateCard",function(event,card,resultId){$scope.cards[resultId]=card;$scope.updateSpendingRewardsDisplay(card)});if($scope.isCardsTableView)$scope.spending={groceries:$scope.$parent.$parent.spending.groceries,
gas:$scope.$parent.$parent.spending.gas,restaurants:$scope.$parent.$parent.spending.restaurants,bills:$scope.$parent.$parent.spending.bills,travel:$scope.$parent.$parent.spending.travel,entertainment:$scope.$parent.$parent.spending.entertainment,pharmacy:$scope.$parent.$parent.spending.pharmacy,other:$scope.$parent.$parent.spending.other};else{$scope.cardRules=ratehub.cardRules;$scope.pointSystems=ratehub.pointSystems;$scope.spending={groceries:240,gas:180,restaurants:250,bills:200,travel:100,entertainment:60,
pharmacy:20,other:500}}$scope.numberOfSpendingRewards={firstYear:0,subsequentYears:0};$scope.cardRules.sort(function(a,b){if(a.name>b.name)return 1;if(a.name<b.name)return-1;return 0});$scope.cardDropdown=$scope.makeCardDropdown($scope.cardRules);$scope.resetResults();var urlParams=parseUrlParams();if("slugs"in urlParams){var slugs=urlParams["slugs"].split(" ");for(var i=0;i<slugs.length;i++)$scope.addResult(slugs[i])}else $scope.addResult()});
rh.ng.controller("CcCalcResultsCtrl",function($scope,creditCardService){$scope.removeResult=function(index){delete $scope.cards[index];$scope.updateSpendingRewardsDisplay();$scope.signupBonusExpand=false;$scope.oneTimeBonusExpand=false;$scope.spendingRewardExpand=false}});
rh.ng.directive("rewardsCalcCard",function($timeout,$sce,creditCardService){var $=jQuery;return{restrict:"C",replace:true,link:{pre:function(scope,elem,attrs){scope.isFirstYearRewards=$(elem).closest(".cc-calc-results").is(".cc-calc-results--show-first-year")?true:false;scope.resultId=attrs.resultId;scope.initAs=attrs.initAs;if(scope.isFirstYearRewards)scope.element=elem},post:function(scope,elem,attrs){if(scope.isFirstYearRewards&&scope.initAs)for(var i=0;i<scope.cardDropdown.length;i++)if(scope.initAs===
scope.cardDropdown[i].slug)scope.currentCard=scope.cardDropdown[i];$timeout(function(){scope.updateResult()})}},controller:function($scope,$timeout,rhEnvironmentService){$scope.rewardTypes=$scope.makeTypeDropdown();$scope.currentRewardType=$scope.rewardTypes[0];$scope.currentCard=$scope.cardDropdown[$scope.isCardDetailsView?1:0];$scope.$on("updateSpending",function(){$scope.updateResult()});$scope.$on("updateDisplayedSpendingRewards",function(event,numFirstYearRewards,numSubsequentYearRewards){$timeout(function(){$scope.card.displayedRewards=
{firstYear:[],subsequentYears:[]};for(var i=0;i<numFirstYearRewards;i++)if($scope.card.firstYearRewards.length>i)$scope.card.displayedRewards.firstYear.push($scope.card.firstYearRewards[i]);else $scope.card.displayedRewards.firstYear.push({});for(var i=0;i<numSubsequentYearRewards;i++)if($scope.card.subsequentYearRewards.length>i)$scope.card.displayedRewards.subsequentYears.push($scope.card.subsequentYearRewards[i]);else $scope.card.displayedRewards.subsequentYears.push({})})});$scope.removeResult=
function(){$scope.$parent.removeResult($scope.resultId)};$scope.updateResult=function(){if(!$scope.isFirstYearRewards)return;var cardRules=$scope.getCardRules($scope.currentCard);for(var i=0;i<$scope.rewardTypes.length;i++){var type=$scope.rewardTypes[i].value;if((!cardRules||!cardRules.point_system||!cardRules.point_system.category[type])&&type!==$scope.forceRewardType){$scope.rewardTypes[i].disabled=true;$($scope.element).find('select[name="type"] option[value="'+i+'"]').prop("disabled",true)}else{$scope.rewardTypes[i].disabled=
false;$($scope.element).find('select[name="type"] option[value="'+i+'"]').prop("disabled",false)}}var highestReward=-999999;var highestRewardIndex=0;for(var i=0;i<$scope.rewardTypes.length;i++)if($scope.rewardTypes[i].disabled)$scope.rewardTypes[i].card=creditCardService.getEmptyCreditCard();else{var type=$scope.rewardTypes[i].value;var usage=getUsage($scope.spending,999999,$scope.rewardTypes[i].value,false);$scope.rewardTypes[i].card=calcRewards(usage,[cardRules],$scope.pointSystems)[0];if($scope.rewardTypes[i].card.netFirstYearValue>
highestReward)highestRewardIndex=i}if($scope.forceRewardType)for(var i=0;i<$scope.rewardTypes.length;i++)if($scope.rewardTypes[i].value===$scope.forceRewardType)highestRewardIndex=i;$scope.setRewardType($scope.rewardTypes[highestRewardIndex])};$scope.setRewardType=function(newType){$scope.currentRewardType=newType;$scope.currentRewardType.card.firstYearRewardsSum=creditCardService.getSpendingBonusSum($scope.currentRewardType.card.firstYearRewards);$scope.currentRewardType.card.subsequentYearRewardsSum=
creditCardService.getSpendingBonusSum($scope.currentRewardType.card.subsequentYearRewards);$scope.$emit("updateCard",newType.card,$scope.resultId)};$scope.applyForCard=creditCardService.applyForCard},templateUrl:$sce.trustAsResourceUrl(ratehub.serverUri+"/assets/templates/angular/rewards-calc-card.html")}});
rh.ng.directive("rewardsCalcMetaTitle",function($sce,$filter){var tmpl='<span ng-bind-html="title"></span>';return{restrict:"A",replace:false,template:tmpl,controller:function($scope){if(!$scope.spendingReward||!$scope.spendingReward.metadata)return;var isCashback=$scope.$parent.card.isCashback;var metadata=$scope.spendingReward.metadata||{};var rate=$scope.spendingReward.rate||0;rate=isCashback?rate*100:rate;var titleStringID="x-on-these-categories";var titleVariables=[];if(isCashback)titleVariables.push('<span class="bold">'+
rate+"%</span>");else titleVariables.push('<span class="bold">'+rate+" "+$filter("localize")("points-title").toLowerCase()+"</span>");if(metadata.bonusRate){var months=metadata.bonusRate.months;var maximumAmount=metadata.bonusRate.maximumAmount;if(months){titleStringID="x-over-y-months";titleVariables.push('<span class="bold">'+months+"</span>")}if(maximumAmount){titleStringID="x-up-to-y-spent";titleVariables.push('<span class="bold">'+$filter("format")(maximumAmount,"c0")+"</span>")}if(months&&maximumAmount)titleStringID=
"x-over-y-months-up-to-z-spent"}else if(metadata.tieredRate){var from=metadata.tieredRate.from;var to=metadata.tieredRate.to;if(from){titleVariables.push('<span class="bold">'+$filter("format")(from,"c0")+"</span>");if(!to)titleStringID="x-from-y-spent-and-up";else{titleStringID="x-from-y-up-to-z-spent";titleVariables.push('<span class="bold">'+$filter("format")(to,"c0")+"</span>")}}}$scope.title=$sce.trustAsHtml($filter("localize")(titleStringID,titleVariables))}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("cardDetails",function(rhEnvironmentService){return{restrict:"C",controller:"CardDetailsCtrl",link:function(scope,elem,attrs){scope.elem=elem;if(rhEnvironmentService.isMobileView(elem))scope.doMobile()}}});
rh.ng.controller("CardDetailsCtrl",function($scope,$compile,creditCardService){var $=jQuery;$scope.isCardDetailsView=true;if($scope.isCardsTableView){$scope.forceRewardType=$scope.$parent.rewardType;if($scope.$parent.scenario!=="rewards"&&$.inArray("Rewards",$scope.cardRules[0].card_category)>-1){$scope.card=creditCardService.rulesToCreditCard($scope.cardRules[0]);$scope.card.isRewards=false}}else{$scope.cardRules=ratehub.cardRules;$scope.pointSystems=ratehub.pointSystems}if($.inArray("Rewards",$scope.cardRules[0].card_category)===
-1){$scope.card=creditCardService.rulesToCreditCard($scope.cardRules[0]);parseGiftCards([$scope.card])}$scope.applyForCard=creditCardService.applyForCard;$scope.getSpendingBonusSum=creditCardService.getSpendingBonusSum;$scope.$on("updateCard",function(event,card){$scope.card=card;if(card.isRewards){var shownColumns=0;if(card.selectedPromo)shownColumns++;if(card.welcomeSignup.value>0)shownColumns++;if(card.welcomeSpending.value>0)shownColumns++;if(card.monthlyBonus.value>0)shownColumns++;if(card.firstYearRewards.length>
0)shownColumns++;if(card.fees.firstYear>0||card.fees.firstYear===0&&card.fees.subsequentYears>0)shownColumns++;if(shownColumns>3)$scope.applySmallerFont=true}});$scope.doMobile=function(){var $this=$($scope.elem);var asideContentId=$this.find(".card-details__aside").attr("tab-id");var footerContentId=$this.find(".card-details__footer").attr("tab-id");var tabsExist=$this.find(".card-details__main .tab-content").length!==0;if(!tabsExist)$this.find(".card-details__main").append('<div class="rh-tabs"><ul class="nav-tabs"></ul><div class="tab-content"></div></div>');
$this.find(".card-details__main .tab-content").append('<div class="tab-pane '+(!tabsExist?"active":"")+'" id="'+asideContentId+'"></div>');$this.find(".card-details__main .tab-content").append('<div class="tab-pane" id="'+footerContentId+'"></div>');var aside=$compile('<a href="#'+asideContentId+'" class="nav-panel '+(!tabsExist?"active":"")+'" ng-click="showTab($event, \''+asideContentId+"')\" ng-bind=\"'cc-details-eligibility' | localize\"></a>")($scope);$this.find("#"+asideContentId).before(aside);
var footer=$compile('<a href="#'+footerContentId+'" class="nav-panel" ng-click="showTab($event, \''+footerContentId+"')\" ng-bind=\"'show-more-details-title' | localize\"></a>")($scope);$this.find("#"+footerContentId).before(footer);$this.find(".card-details__aside").appendTo("#"+asideContentId);$this.find(".card-details__footer").appendTo("#"+footerContentId)}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("CreditCardsHeadCtrl",function($scope,creditCardService){$scope.findCard=function(event){event.preventDefault();event.stopPropagation();var options={};if($scope.scenario)options.type=$scope.scenario;if($scope.provider&&$scope.provider!=="all")options.provider=$scope.provider;options.params={};if($scope.network&&$scope.network!=="all")options.params.network=$scope.network;if($scope.fee&&$scope.fee!=="I dont mind")options.params.fee=$scope.fee;if(parseInt($scope.creditScore))options.params.creditScore=
$scope.creditScore;var url=creditCardService.getUrl(options);window.location=url}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("SpendingProfileCtrl",function($scope,creditCardService,rhTipService){$scope.spending.monthlyTotal=function(){$scope.spending.monthlySpending=$scope.spending.groceries+$scope.spending.gas+$scope.spending.restaurants+$scope.spending.bills+$scope.spending.travel+$scope.spending.entertainment+$scope.spending.pharmacy+$scope.spending.other;if(typeof $scope.filters!=="undefined")$scope.filters.rewards.monthlySpending=$scope.spending.monthlySpending};$scope.distributeSpending=creditCardService.distributeSpending;
$scope.spending.monthlyTotal();rhTipService.setType("allCardsTable");$scope.activateTip=rhTipService.activateTip;$scope.isTipActive=rhTipService.isTipActive;$scope.disableTips=rhTipService.disableTips});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("AllCardsTableCtrl",function($scope,$sce,$timeout,rhHttpRequestService,rhHistoryService,rhTipService,creditCardService){var $=jQuery;var CREDIT_CARD_SCENARIO_REWARDS=0;var CREDIT_CARD_SCENARIO_LOW_INTEREST=1;var CREDIT_CARD_SCENARIO_BALANCE_TRANSFER=2;var CREDIT_CARD_SCENARIO_SECURED=3;var CREDIT_CARD_SCENARIOS=[{index:CREDIT_CARD_SCENARIO_REWARDS,key:"rewards"},{index:CREDIT_CARD_SCENARIO_LOW_INTEREST,key:"lowInterest"},{index:CREDIT_CARD_SCENARIO_BALANCE_TRANSFER,key:"balanceTransfer"},
{index:CREDIT_CARD_SCENARIO_SECURED,key:"secured"}];$scope.cards=null;$scope.cardsRules={"rewards":ratehub.rewardsCards?ratehub.rewardsCards:null,"lowInterest":ratehub.lowInterestCards?ratehub.lowInterestCards:null,"balanceTransfer":ratehub.balanceTransferCards?ratehub.balanceTransferCards:null,"secured":ratehub.securedCards?ratehub.securedCards:null};$scope.pointSystems=ratehub.pointSystems?ratehub.pointSystems:null;$scope.scenario=null;$scope.restoring=false;$scope.isLoading=false;$scope.rowLimitDefault=
6;$scope.rowLimit=$scope.rowLimitDefault;$scope.order="-netFirstYearValue";$scope.secondOrder="fee";$scope.isFirstPageLoad=true;$scope.isWidget=false;$scope.sorted=false;$scope.featuredCardsEnabled=false;$scope.sponsoredCardsEnabled=false;$scope.showIncomeColumn=ratehub.experiments&&ratehub.experiments.creditcards.showIncomeColumn===1;$scope.filters={rewards:{},lowInterest:{},balanceTransfer:{},secured:{},promoOffers:{}};$scope.filters["promoOffers"][CREDIT_CARD_SCENARIOS[CREDIT_CARD_SCENARIO_REWARDS].key]=
false;$scope.filters["promoOffers"][CREDIT_CARD_SCENARIOS[CREDIT_CARD_SCENARIO_LOW_INTEREST].key]=false;$scope.filters["promoOffers"][CREDIT_CARD_SCENARIOS[CREDIT_CARD_SCENARIO_BALANCE_TRANSFER].key]=false;$scope.filters["promoOffers"][CREDIT_CARD_SCENARIOS[CREDIT_CARD_SCENARIO_SECURED].key]=false;$scope.spending={groceries:240,gas:180,restaurants:250,bills:200,travel:100,entertainment:60,pharmacy:20,other:500,monthlyTotal:function(){return $scope.spending.groceries+$scope.spending.gas+$scope.spending.restaurants+
$scope.spending.bills+$scope.spending.travel+$scope.spending.entertainment+$scope.spending.pharmacy+$scope.spending.other}};$scope.$watch("[filters, scenario, spending]",function(newProfile,oldProfile){if(newProfile===oldProfile)return;else{var updateScenario=newProfile[1]!==oldProfile[1];var updateProvider=newProfile[0][$scope.scenario].bank!==oldProfile[0][$scope.scenario].bank;var updateProgram=newProfile[0][$scope.scenario].rewardsProgram!==oldProfile[0][$scope.scenario].rewardsProgram;var updateNetwork=
newProfile[0][$scope.scenario].network!==oldProfile[0][$scope.scenario].network;$scope.renderTable(updateProvider,updateScenario,updateProgram,updateNetwork)}},true);$scope.getCurrentPromoFilterModel=function(){return $scope.scenario};$scope.renderTable=function(updateProvider,updateScenario,updateProgram,updateNetwork){switch($scope.scenario){case "rewards":var cType="Rewards";break;case "secured":var cType="Secured";break;case "lowInterest":var cType="Low interest";break;case "balanceTransfer":var cType=
"Balance transfer";break}var scenario=$scope.scenario;var needPointSystems=$scope.pointSystems?false:true;var needCreditCards=!$scope.cardsRules[scenario]?true:false;var needNewContent=updateProvider||updateScenario||updateProgram||updateNetwork;if(needPointSystems||needCreditCards||needNewContent){var params={};if((updateProvider||$scope.isFirstPageLoad)&&$scope.filters[scenario].bank!=="all")params.provider=$scope.filters[scenario].bank;if(updateNetwork&&$scope.filters[scenario].network!=="all")params.network=
$scope.filters[scenario].network;params.type=scenario.replace(/([A-Z])/g,function(m){return"-"+m.toLowerCase()});var url=creditCardService.getUrl(params);var options={url:url,data:{operation:"getAllCardsTableData",getPointSystems:needPointSystems,getCreditCards:needCreditCards,getContent:needNewContent,card_category:cType,disable_promos:$scope.disablePromos},done:function(data){if(!$scope.isWidget){if(!$scope.restoring)rhHistoryService.pushState($scope.getStateObject(),null,url);if(!typeof ga==="function"){ga("set",
"page",url.replace(ratehub.serverUri,""));ga("send","pageview")}else $scope.restoring=false}$scope.isLoading=false;$scope.isFirstPageLoad=false;if(data.cardRules)$scope.cardsRules[scenario]=data.cardRules;if(data.pointSystems)$scope.pointSystems=data.pointSystems;if(data.intro)$scope.intro=$sce.trustAsHtml(data.intro);if(data.content)$scope.content=$sce.trustAsHtml(data.content);$scope.processCards();$scope.$broadcast("tableDidRender")}};if(ratehub.user.aff_info)$.extend(options.data,ratehub.user.aff_info);
if(ratehub.isWidget)options.data.isWidget=true;$scope.isLoading=true;rhHttpRequestService.jsonp(options)}else $scope.processCards()};$scope.toggleLimit=function(){$scope.rowLimit=$scope.rowLimit===$scope.rowLimitDefault?$scope.cards.length:$scope.rowLimitDefault};$scope.changeScenario=function(newScenario){$timeout(function(){$('a[href="#'+newScenario+'"]').tab("show")});$scope.scenario=newScenario;switch($scope.scenario){case "rewards":var order=$(".all-cards-table .rh-sortable-table .rewards-sort-criteria").attr("order-by");
break;case "lowInterest":var order=$(".all-cards-table .rh-sortable-table .low-interest-sort-criteria").attr("order-by");break;case "balanceTransfer":var order=$(".all-cards-table .rh-sortable-table .balance-transfer-sort-criteria").attr("order-by");break;case "secured":var order=$(".all-cards-table .rh-sortable-table .secured-sort-criteria").attr("order-by");break;default:var order=null}$scope.order=order};$scope.customSort=function(event){var $elem=$(event.currentTarget);var oldSort=$elem.attr("order-by");
var newSort="";if(oldSort==="-netFirstYearValue"){newSort="-netSubsequentYearValue";$elem.find(".title").text(Globalize.localize("cc-table-header-net-reward-subsequent"))}else{newSort="-netFirstYearValue";$elem.find(".title").text(Globalize.localize("cc-table-header-net-reward"))}$elem.attr("order-by",newSort);$scope.$broadcast("setSortableOrder",newSort)};$scope.sortPromo=function(card){if($scope.scenario!=="balanceTransfer")return;if(card.promo_rates&&card.promo_rates.balance_transfer)return-card.promo_rates.balance_transfer.term};
$scope.sortFeatured=function(card){return card.monetized&&$scope.featuredCardsEnabled?0:1};$scope.isFeatured=function(card){return card.monetized&&!card.sponsored&&$scope.featuredCardsEnabled};$scope.distributeSpending=creditCardService.distributeSpending;$scope.processCards=function(){var scenario=$scope.scenario;var results=null;switch(scenario){case "lowInterest":case "balanceTransfer":case "secured":results=$scope.cardsRules[scenario];parseGiftCards(results);break;case "rewards":var usage=getUsage($scope.spending,
$scope.filters[$scope.scenario].income,$scope.filters[$scope.scenario].rewards,$scope.filters[$scope.scenario].fee);var results=calcRewards(usage,$scope.cardsRules[scenario],$scope.pointSystems);break}$scope.cards=applyFilters(results)};$scope.getStateObject=function(){return{scenario:$scope.scenario,filters:$scope.filters[$scope.scenario]}};$scope.applyForCard=creditCardService.applyForCard;$scope.isSponsored=function(card){return card.sponsored&&$scope.featuredCardsEnabled};$scope.sortSponsored=
function(card){return card.sponsored&&$scope.sponsoredCardsEnabled?0:1};$scope.$on("tableSorted",function(event,type){if(type)$scope.order=type;$scope.sorted=true});$scope.hasPromoOffers=function(){var showPromoOffersChecked=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];var hasAtLeastOnePromoOffer=$scope.cards&&$scope.cards.some(function(card){return card.promo_offers.promo_on});return showPromoOffersChecked||hasAtLeastOnePromoOffer};rhTipService.setType("allCardsTable");$scope.activateTip=
rhTipService.activateTip;$scope.isTipActive=rhTipService.isTipActive;$scope.disableTips=rhTipService.disableTips;function applyFilters(cards){var income=$scope.filters[$scope.scenario].income;var fee=$scope.filters[$scope.scenario].fee==="I dont mind"?false:true;var rewards=$scope.filters[$scope.scenario].rewards==="All"?false:$scope.filters[$scope.scenario].rewards;var bank=$scope.filters[$scope.scenario].bank==="all"?false:$scope.filters[$scope.scenario].bank;var creditScore=$scope.filters[$scope.scenario].creditScore;
var promoOffers=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];var pointSystem=null;var network=null;var usage=$scope.initialType==="student"||$scope.initialType==="business"?$scope.initialType.charAt(0).toUpperCase()+$scope.initialType.slice(1):null;if($scope.filters[$scope.scenario].rewardsProgram)pointSystem=$scope.filters[$scope.scenario].rewardsProgram.indexOf("all")!==-1?false:$scope.filters[$scope.scenario].rewardsProgram;if($scope.filters[$scope.scenario].network)network=
$scope.filters[$scope.scenario].network.indexOf("all")!==-1?false:$scope.filters[$scope.scenario].network;var filteredCards=[];for(var i=0;i<cards.length;i++){if(cards[i].sponsored&&!promoOffers){var cardRules=null;for(var j=0;j<$scope.cardsRules[$scope.scenario].length;j++)if($scope.cardsRules[$scope.scenario][j].slug===cards[i].slug){cardRules=$scope.cardsRules[$scope.scenario][j];break}if(cardRules){var sponsoredUsage=getUsage($scope.spending,$scope.filters[$scope.scenario].income,"All",$scope.filters[$scope.scenario].fee);
cards[i]=calcRewards(sponsoredUsage,[cardRules],$scope.pointSystems)[0]}}else{if(promoOffers&&!cards[i].promo_offers.promo_on)continue;if(rewards&&cards[i].isRewards&&!cards[i].pointSystem.category[rewards])continue;if($scope.hideNonMon&&!cards[i].monetized)continue;if(fee&&cards[i].fee>0)continue;var reqPersonalIncome=cards[i].eligibility&&cards[i].eligibility.personal_income?parseInt(cards[i].eligibility.personal_income):0;var reqFamilyIncome=cards[i].eligibility&&cards[i].eligibility.household_income?
parseInt(cards[i].eligibility.household_income):0;if(income<reqPersonalIncome)continue;if(bank&&bank!==cards[i].bank)continue;if(pointSystem&&(pointSystem.indexOf(cards[i].pointSystem._slug)===-1&&cards[i].pointSystem._slug!=="cash-back-rewards"))continue;if(network&&network.indexOf(cards[i].network)===-1)continue;if(creditScore&&creditScore!=="not-sure"&&cards[i].credit_score&&cards[i].credit_score[0]>creditScore[0])continue;if(usage)if(cards[i].slug==="scotia-scene-visa"){if(usage==="Business")continue}else if(usage!==
cards[i].user_category)continue}filteredCards.push(cards[i])}return filteredCards}});
rh.ng.directive("allCardsTable",function($sce,rhHistoryService,rhEnvironmentService){var $=jQuery;return{restrict:"C",controller:"AllCardsTableCtrl",controllerAs:"AllCardsTableCtrl",link:{pre:function(scope,elem,attrs){scope.isWidget=rhEnvironmentService.isWidgetView(elem);var scenario=$(".all-cards-table__filters .nav-tabs li.active a").attr("href").substring(1);scope.changeScenario(scenario);scope.intro=$sce.trustAsHtml($('[rh-bind-compile-html="intro"]').html());scope.content=$sce.trustAsHtml($('[rh-bind-compile-html="content"]').html());
scope.initialType=attrs["initialType"];scope.hideNonMon=typeof attrs.hideNonMon!="undefined";scope.disablePromos=typeof attrs.disablePromos!=="undefined";scope.disableLeads=typeof attrs.disableLeads!=="undefined";scope.featuredCardsEnabled=typeof attrs.featuredCards!=="undefined";scope.sponsoredCardsEnabled=typeof attrs.hideFeatured==="undefined";scope.hideTabs=typeof attrs.hideTabs!=="undefined";scope.hideFilter=typeof attrs.hideFilter!=="undefined";scope.hideMonthly=typeof attrs.hideMonthly!=="undefined";
scope.disableShowMore=typeof attrs.disableShowMore!=="undefined";scope.rowLimitDefault=typeof attrs.resultCount!=="undefined"?attrs.resultCount:scope.rowLimitDefault;scope.rowLimit=scope.rowLimitDefault;if(typeof attrs.widgetHeight!=="undefined"){var filterHeight=scope.hideFilter?0:elem.find(".tab-content").outerHeight();var tabHeight=scope.hideTabs?0:elem.find(".nav-tabs").outerHeight();var spendingHeight=scope.hideMonthly?0:elem.find(".all-cards-table__spending").outerHeight();var bannerHeight=
elem.find(".banner").outerHeight();var stubHeight=elem.find(".rh-stub").outerHeight();var surroundingHeight=filterHeight+tabHeight+spendingHeight+bannerHeight+stubHeight;if(attrs.widgetHeight>surroundingHeight)scope.tableHeight=attrs.widgetHeight-surroundingHeight;else scope.tableHeight=attrs.widgetHeight;if(typeof attrs.resultCount==="undefined")scope.rowLimit=Number.MAX_SAFE_INTEGER;scope.widgetHeight=attrs.widgetHeight}if(typeof attrs.cardSlug!=="undefined")if(typeof attrs.resultCount==="undefined")scope.rowLimit=
Number.MAX_SAFE_INTEGER},post:function(scope){scope.renderTable();if(!scope.isWidget)rhHistoryService.replaceState(scope.getStateObject(),null);$(window).bind("popstate",function(event){event.preventDefault();var state=event.originalEvent.state;if(state)scope.$apply(function(){var newScenario=state.scenario;scope.restoring=true;scope.filters[newScenario]=state.filters;scope.changeScenario(newScenario)})})}}}});
rh.ng.directive("allCardsTableNoResults",function(){var template='<tr ng-show="cards.length === 0" class="no-results">'+"<td>"+"<p>"+Globalize.localize("cc-no-cards-match")+"</p>"+"</td>"+"</tr>";return{restrict:"C",replace:true,template:template}});
rh.ng.directive("allCardsTableRow",function($compile,$timeout,rhHttpRequestService){var $=jQuery;return{restrict:"A",scope:{card:"=allCardsTableRow"},link:function(scope,row,attrs){scope.cardDetailsMarkup=null;scope.showingDetails=false;scope.cardSlug=typeof attrs.cardSlug!=="undefined"?attrs.cardSlug:null;scope.hideReviews=typeof attrs.hideReviews!=="undefined";if(scope.card.slug===scope.cardSlug){scope.showingDetails=true;displayCardDetails(scope,row,null)}$timeout(function(){row.find("[toggle-details-collapse]").on("click",
function(event){event.preventDefault();event.stopPropagation();if(scope.showingDetails)return;scope.showingDetails=true;displayCardDetails(scope,row,event)})})}};function displayCardDetails(scope,row,e){var cardRules=scope.$parent.cardsRules;var scenario=scope.$parent.scenario;scope.isCardsTableView=true;scope.spending=scope.$parent.$parent.spending;scope.pointSystems=scope.$parent.pointSystems;scope.scenario=scenario;if(scenario==="rewards")scope.rewardType=scope.card.sponsored?"All":scope.$parent.filters[scenario].rewards;
for(var i=0;i<cardRules[scenario].length;i++)if(cardRules[scenario][i].name===scope.card.name){scope.cardRules=[cardRules[scenario][i]];break}var colspan=ratehub.experiments&&ratehub.experiments.creditcards.showIncomeColumn===1?7:6;var height=typeof scope.cardSlug!=="undefined"&&!e?80:row.find("td").outerHeight();var tmpl='<td colspan="'+colspan+'" class="all-cards-table__results__details" id="'+scope.card.slug+'">'+'<a class="details-header" href="javascript:void(0);">'+'<span class="name" style="height:'+
height+'px;">'+scope.card.name+"</span>"+'<span class="chevron">'+'<i class="fa fa-fw fa-chevron-up"></i>'+"</span>"+"</a>"+'<div class="details-description"></div>'+"</td>";row.find("td, th").fadeOut().promise().then(function(){row.find(".col-result").hide();row.append(tmpl);row.find(".details-header > *").hide().fadeIn();var options={url:typeof scope.cardSlug!=="undefined"&&!e?scope.card.href:e.target.href||scope.card.href,data:{details:true,scenario:scenario,isWidget:ratehub.isWidget===true||ratehub.isWidget===
"true",disableLeads:scope.$parent.disableLeads,disablePromos:scope.$parent.disablePromos,hideReviews:scope.hideReviews},done:function(data){scope.cardDetailsMarkup=data;scope.display=1;showCardDetails(scope,row)}};$.extend(options.data,scope.$parent.spending);if(ratehub.user.aff_info)$.extend(options.data,ratehub.user.aff_info);if(ratehub.isWidget)options.data.isWidget=true;rhHttpRequestService.jsonp(options);if(typeof scope.cardSlug!=="undefined"&&!e)$timeout(function(){row[0].scrollIntoView(true)})})}
function showCardDetails(scope,row){row.find(".all-cards-table__results__details .details-header").click(function(){hideCardDetails(scope,row);scope.showingDetails=false});var container=row.find(".all-cards-table__results__details .details-description");container.html(scope.cardDetailsMarkup);$compile(container)(scope);container.hide().slideDown();if(!scope.isWidget&&typeof ga==="function"){ga("set","page",scope.card.href.replace(ratehub.serverUri,""));ga("send","pageview")}}function hideCardDetails(scope,
row){delete scope.cardDetailsMarkup;row.find(".all-cards-table__results__details .details-description").slideUp();row.find(".all-cards-table__results__details").fadeOut().promise().then(function(){row.find(".all-cards-table__results__details").remove();row.find("td, th").fadeIn()})}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("BestCardsTableCtrl",function($scope,creditCardService){$scope.rowLimitDefault=5;$scope.rowLimit=$scope.rowLimitDefault;$scope.showIncomeColumn=ratehub.experiments&&ratehub.experiments.creditcards.showIncomeColumn===1;$scope.toggleLimit=function(){$scope.rowLimit=$scope.rowLimit===$scope.rowLimitDefault?$scope.cards.length:$scope.rowLimitDefault};$scope.cardsByType=function(type){return $scope.cards.filter(function(card){return card.pointSystem.category[type]&&card.user_category===
"Personal"})};$scope.applyForCard=creditCardService.applyForCard});rh.ng.directive("bestCardsTable",function(){return{restrict:"A",link:function(scope,elem,attrs){scope.cards=ratehub[attrs.type+"Cards"]?ratehub[attrs.type+"Cards"]:[];if(attrs.type==="balanceTransfer")for(var i=0;i<scope.cards.length;i++)if(scope.cards[i].promo_rates){var tmp=scope.cards[i].promo_rates.balance_transfer_interest.split(",");scope.cards[i].promo_rates.balance_transfer={rate:parseFloat(tmp[0]),term:tmp[1]}}}}});
rh.ng.controller("BestRewardsCardsTableCtrl",function($scope,creditCardService){$scope.applyForCard=creditCardService.applyForCard;$scope.showIncomeColumn=ratehub.experiments&&ratehub.experiments.creditcards.showIncomeColumn===1});
rh.ng.directive("bestRewardsCardsTable",function(){return{restrict:"A",controller:"BestRewardsCardsTableCtrl",link:function(scope,elem,attrs){scope.cardRules=ratehub.rewardsCards?ratehub.rewardsCards:[];scope.order="-netFirstYearValue";scope.rowLimit=3;scope.cards={};scope.displayedCards={};var spending={groceries:240,gas:180,restaurants:250,bills:200,travel:100,entertainment:60,pharmacy:20,other:500};var income=8E4;var fee="I dont mind";var usage={};["Store credit","Travel","Cash back"].forEach(function(type){usage=
getUsage(spending,income,type,fee);var filteredCards=scope.cardRules.filter(function(card){return card.point_system.category[type]&&card.user_category==="Personal"});scope.cards[type]=calcRewards(usage,filteredCards,ratehub.pointSystems)})}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("format",function($filter){return{require:"?ngModel",link:function(scope,elem,attrs,ngModelCtrl){if(!ngModelCtrl)return;var format=attrs.format;ngModelCtrl.$formatters.unshift(function(modelValue){return formatValue(modelValue)});ngModelCtrl.$parsers.unshift(function(viewValue){if(format.match(/:'[mtd]'/))value=viewValue;else{if(format.match(/:'p[0-9]'/)){value=Globalize.parseFloat(viewValue.replace(/[^\d|,|\.]/g,""));value=value>1?value/100:value}else value=Globalize.parseFloat(viewValue.replace(/[^\d|\-+|\.+]/g,
""));if(isNaN(value))value=ngModelCtrl.$modelValue}elem.val(formatValue(value));return value});function formatValue(modelValue){return scope.$eval($filter("json")(modelValue)+"|"+format)}}}});
rh.ng.filter("format",function($sce){return function(value,format){switch(true){case /^c/.test(format):case /^p/.test(format):case /^n/.test(format):var html=arguments[2];var underOnePercent=arguments[3];if(format&&typeof format==="string"&&/^p/.test(format))if(value>1||underOnePercent)value=value/100;var formatted=Globalize.format(value,format);if(formatted&&html){formatted=formatted.replace(/^([$%])\s?(\d+(?:[\s,\.]\d+)*)$/,"<sup>$1</sup><span>$2</span>");formatted=formatted.replace(/^(\d+(?:[\s,\.]\d+)*)\s?([$%])$/,
"<span>$1</span><sup>$2</sup>");formatted=$sce.trustAsHtml(formatted)}return formatted;default:if(typeof value!=="string")return;switch(true){case /^m/.test(format):value=value.toUpperCase().replace(/^(\w{3}) ?(\w{3})$/,"$1 $2");break;case /^t/.test(format):value=value.replace(/[^\d]/g,"").replace(/^(\w{3})(\w{3})(\w{4})$/,"$1-$2-$3");break;case /^d/.test(format):var formatString=arguments[2];value=Globalize.format(new Date(value),formatString);break}return value}}});
rh.ng.directive("rhPopup",function(rhEnvironmentService){var $=jQuery;return{restrict:"A",link:function(scope,elem,attrs){elem.click(function(event){event.preventDefault();event.stopPropagation();var options={};if(attrs.popupWidth)options.width=attrs.popupWidth;if(attrs.popupHeight)options.height=attrs.popupHeight;if(attrs.popupMinWidth)options.minWidth=parseInt(attrs.popupMinWidth);if(attrs.popupMinHeight)options.minHeight=parseInt(attrs.popupMinHeight);if(attrs.popupClass)options.popupClass=attrs.popupClass;
if(attrs.popupInline)options.inline=attrs.popupInline==="true";var link=$(this).attr("href");if(attrs.forceStandard==="true"||attrs.forceStandardMobile==="true"&&rhEnvironmentService.isMobileView())window.location.href=link;else if(attrs.forcePopup==="true"){options.isMobile=rhEnvironmentService.isMobileView();rh.Dialog.openAsPopup(link,options)}else if(attrs.ignoreMobileResize==="true")rh.Dialog.openAsPopup(link,options);else rh.Dialog.show(link,options)})}}});
rh.ng.directive("rhValidateRegion",function(){var $=jQuery;return{restrict:"A",controller:function($scope,$timeout){var previousValidatedCity=null;$scope.$watch("inputs.city",function(city,previousCity){if(city===previousCity){previousValidatedCity=city;return}previousCity=previousCity||{province:{}};if(!city||!city.id||city.id===previousCity.id||previousValidatedCity&&city.id===previousValidatedCity.id)return;var provinceChanged=city.province.code!==(previousCity.id?previousCity.province.code:previousCity.code);
var rollback=false;if($(".rate-details").hasClass("show-mortgage"))if(provinceChanged){var availability=ratehub.provincialAvailability[city.province.code];if(!availability){var message=Globalize.localize("rate-details-rate-not-available");var redirectMessage=message+" "+Globalize.localize("rate-details-rate-redirect");var fallback=sprintf(ratehub.provincialAvailability["default"],city.province.slug);var result=tryRedirect(null,null,redirectMessage,fallback);if(!result){rollback=true;if(result===false)alert(message)}}else if(typeof availability===
"string"){var urlParams=window.parseUrlParams();var url=availability+"?"+$.param(urlParams);$("#detailsForm").attr("action",url).submit()}}else if(ratehub.regionalAvailability[city.id]||checkInRange(city,ratehub.regionalAvailability)||ratehub.regionalAvailability["default"]===true)$("#detailsForm").attr("action",window.location.href).submit();else{if(typeof ratehub.regionalAvailability["default"]==="string"){var message=Globalize.localize("rate-details-rate-not-available");var redirectMessage=message+
" "+Globalize.localize("rate-details-rate-redirect");var fallback=sprintf(ratehub.regionalAvailability["default"],city.slug);var result=tryRedirect(null,null,redirectMessage,fallback);if(!result){rollback=true;if(result===false)alert(message)}}}else if($(".rate-details").hasClass("show-gic")||$(".rate-details").hasClass("show-savings"))if(provinceChanged){var availabilityByProvince=$(".rate-details").hasClass("show-savings")?ratehub.savingsProvincialAvailability:ratehub.gicProvincialAvailability;
var availability=availabilityByProvince[city.province.code];if(!availability){var message=Globalize.localize("rate-details-rate-not-available");var redirectMessage=message+" "+Globalize.localize("rate-details-rate-redirect");var result=tryRedirect(null,null,redirectMessage,availabilityByProvince["default"]);if(!result){rollback=true;if(result===false)alert(message)}}else if(typeof availability==="string")$("#detailsForm").attr("action",availability).submit()}else $("#detailsForm").attr("action",window.location.href).submit();
else{var availability=provinceChanged?ratehub.provincialAvailability[city.province.code]:ratehub.regionalAvailability[city.id];if(availability!==true){if(!provinceChanged&&checkInRange(city,ratehub.regionalAvailability))return;var message=Globalize.localize("rate-details-outside-agent-area");var redirectMessage=message+" "+Globalize.localize("rate-details-rate-redirect");var fallback=null;if(typeof availability==="string")fallback=availability;else{fallback=provinceChanged?ratehub.provincialAvailability["default"]:
ratehub.regionalAvailability["default"];fallback=sprintf(fallback,provinceChanged?city.province.slug:city.slug)}var result=tryRedirect(null,null,redirectMessage,fallback);if(!result){rollback=true;if(result===false)alert(message)}}}if(rollback)$scope.inputs.city=previousCity;else previousValidatedCity=city})}};function checkInRange(city,availability){if(!city.latitude||!city.longitude)return true;var inRange=false;$.each(availability,function(cityId,info){if(typeof info==="object"){var distance=6371*
circleDistance(city.latitude,city.longitude,info.latitude,info.longitude);if(distance<Math.max(info.service_radius/1E3,50)){inRange=true;return false}}});return inRange}function tryRedirect(selector,values,message,fallback,fallbackMessage){if(fallback){if(confirm(fallbackMessage||message)){window.parent.location=fallback;return true}return null}return false}});
rh.ng.directive("rhBindCompileHtml",function($sce,$compile){return{restrict:"A",link:function(scope,element,attrs){var expression=$sce.parseAsHtml(attrs.rhBindCompileHtml);var getValue=function(){return expression(scope)};scope.$watch(getValue,function(newValue,oldValue){var value=$(newValue);var thisSelector="[rh-bind-compile-html="+attrs.rhBindCompileHtml+"]";var thisElement=value.find(thisSelector).addBack(thisSelector);if(thisElement.length)value=thisElement.children();var html=$compile(value)(scope);
element.html(html)})}}});rh.ng.filter("localize",function($sce){return function(id,params,html){params=params||[];params.unshift(null);params.unshift(id);var s=Globalize.localize.apply(Globalize,params);if(!s)s="["+id+"]";if(html)return $sce.trustAsHtml(s);return s}});
rh.ng.directive("applyForCard",function(creditCardService){return{restrict:"A",link:function(scope,self,attrs){self.on("click",function(event){var cardSlug=attrs.applyForCard;var card=ratehub["apply-for-card-"+cardSlug];creditCardService.applyForCard(event,card,attrs.goto)})}}});
rh.ng.directive("calculateDownPayment",function(){return{restrict:"A",link:function(scope,self,attrs){var purchase=scope.$eval(attrs.purchase||"purchase");scope.downPaymentIsMin=false;scope.$watch("["+jQuery.map(["homePrice","downPayment","downPaymentPercent"],function(v){return(attrs.purchase||"purchase")+"."+v}).join()+"]",function(newValue,oldValue){var homePriceChanged=false;if(newValue!==oldValue&&newValue[0]!==oldValue[0])homePriceChanged=true;var minimumDownPayment=.05*purchase.homePrice;if(purchase.homePrice>
5E5)minimumDownPayment=25E3+.1*(purchase.homePrice-5E5);if(purchase.homePrice>=1E6)minimumDownPayment=.2*purchase.homePrice;if(newValue[1]!==oldValue[1]){if(!purchase.downPayment||scope.downPaymentIsMin&&homePriceChanged||purchase.downPayment<minimumDownPayment)purchase.downPayment=minimumDownPayment;else if(purchase.downPayment>purchase.homePrice)purchase.downPayment=purchase.homePrice;purchase.downPaymentPercent=purchase.downPayment/purchase.homePrice}else{minimumPercent=minimumDownPayment/purchase.homePrice;
if(scope.downPaymentIsMin&&homePriceChanged||purchase.downPaymentPercent<minimumPercent)purchase.downPaymentPercent=minimumPercent;purchase.downPayment=purchase.homePrice*purchase.downPaymentPercent}scope.downPaymentIsMin=Math.round(purchase.downPayment)==Math.round(minimumDownPayment)},true)}}});
rh.ng.directive("getThisRate",function(rhConversionService,eyeReturnService,nonMonService,depositsService){return{restrict:"A",link:function(scope,self,attrs){self.on("click",function(event){event.preventDefault();event.stopPropagation();if(!attrs.productId||!attrs.vertical)return;var productId=attrs.productId;var vertical=attrs.vertical;if(ratehub.depositsProducts&&ratehub.depositsProducts[vertical]&&ratehub.depositsProducts[vertical][productId])var product=ratehub.depositsProducts[vertical][productId];
else return;var tag=product.monetized?"monetized_"+vertical+"_leads":"non-monetized_"+vertical+"_leads";eyeReturnService.getEyeReturnTagCode(tag,{});var href=attrs.customHref||product.site||product.href;var conversionOptions={isPaid:product.monetized,type:vertical,product:{id:productId,providerName:product.provider,productDescription:product.description}};if(product.promoOn&&product.popupOn){href=product.applicationUrl?product.applicationUrl:product.href;rh.Dialog.show(href,{width:645,height:745})}else if(!product.monetized&&
!attrs.customHref)if(vertical==="chequing")window.open(product.href,"_blank");else rh.Dialog.show(product.detailsHref);else if(product.monetized&&ratehub.widgetLoaded){var url=depositsService.getApplyRedirect(product.href);window.open(url,"_blank");eyeReturnService.getThankYouPopup(false,vertical,{id:product.id});rhConversionService.trackConversion(conversionOptions,"web")}else depositsService.handleWebClick(href,vertical,conversionOptions)})}}});
rh.ng.directive("applyForRate",function(rhConversionService){return{restrict:"A",link:function(scope,self,attrs){self.on("click",function(event){event.preventDefault();event.stopPropagation();if(attrs.customHref){window.parent.open(attrs.href,"_blank");var options={isPaid:attrs.featured,type:"mortgage",product:{id:attrs.id,providerName:attrs.provider,productDescription:attrs.description}};rhConversionService.webClick(options)}else if(attrs.preapprovalAppPaid){window.parent.open(attrs.preapprovalApp,
"_blank");var options={isPaid:attrs.preapprovalAppPaid,type:"mortgage",product:{id:attrs.id,providerName:attrs.provider,productDescription:attrs.description}};rhConversionService.preApprovalClick(options)}else rh.Dialog.show(attrs.href,{})})}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhCheckbox",function($parse,$timeout){return{restrict:"C",require:"?ngModel",priority:100,link:{pre:function(scope,element,attrs){if(attrs.ngModel)$parse(attrs.ngModel).assign(scope,element.is(":checked"))},post:function(scope,element,attrs,ngModelCtrl){if(ngModelCtrl)ngModelCtrl.$render=function(){element.iCheck(ngModelCtrl.$viewValue?"check":"uncheck")};element.on("ifChanged",function(event){$timeout(function(){ngModelCtrl.$setViewValue(element[0].checked)})});var html='<i class="fa fa-square"></i><i class="fa fa-check-square"></i>';
element.iCheck({insert:html,increaseArea:"10%"})}}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhDateInput",function($filter,$compile,$timeout){return{require:"?ngModel",restrict:"C",compile:function compile(tElement,tAttrs){var name=tAttrs.name;var initialValue={year:tElement.find('input[name="year"]').val(),month:tElement.find('input[name="month"]').val(),day:tElement.find('input[name="day"]').val()};if(!initialValue.year&&!initialValue.month&&!initialValue.day)initialValue=null;var dirty=false;var focused=false;return function(scope,element,attrs,ngModelCtrl){var dateInputs=
element.find("> input");ngModelCtrl.$render=function(){if(!ngModelCtrl.$viewValue)return;var date=ngModelCtrl.$viewValue;dateInputs.each(function(i,input){var input=$(input);var name=input.attr("name");input.val(date[name])})};ngModelCtrl.$formatters.unshift(function(modelValue){if(!modelValue)return null;var date=new Date(modelValue);return{year:date.getUTCFullYear(),month:date.getUTCMonth()-1,day:date.getUTCDate()}});ngModelCtrl.$parsers.unshift(function(viewValue){if(viewValue.year&&viewValue.month&&
viewValue.day){var dateString=viewValue.year+"-"+(viewValue.month.toString().length<2?"0":"")+viewValue.month+"-"+(viewValue.day.toString().length<2?"0":"")+viewValue.day;var date=new Date(dateString);if(!isNaN(date)&&date.toJSON().substr(0,10)===dateString){ngModelCtrl.$setValidity("date_format",true);dirty=true;return date.toJSON().substr(0,10)}}if(!dirty)ngModelCtrl.$setPristine();ngModelCtrl.$setValidity("date_format",false);return null});element.bind("click",function(){focused=true;var input=
jQuery(element.find("input")[0]);input.focus()});dateInputs.bind("click",function(event){event.stopPropagation()});dateInputs.bind("focus",function(event){focused=true;element.addClass("focus");var input=event.target;input.setSelectionRange(0,input.value.length)});dateInputs.bind("input blur",handleChange);function handleChange(event){if(event.type=="blur"){focused=false;$timeout(function(){if(!focused){element.removeClass("focus");dirty=true;ngModelCtrl.$dirty=true}})}var target=$(event.target);
var name=target.attr("name");if(name==="year"&&target.val().length<4||name==="month"&&target.val().length<2||name==="day"&&target.val().length<2)if(event.type==="blur"&&!isNaN(parseInt(target.val()))&&(name==="month"||name==="day"))target.val("0"+target.val());else if(event.type!=="blur"){target.val(target.val().replace(/[^0-9]/g,""));return}var date=ngModelCtrl.$viewValue||{};var month=date.month;var day=date.day;var year=date.year;var update=false;var value=null;if(name==="year"){value=year=parseInt(target.val());
update=!isNaN(value)&&value>(new Date).getFullYear()-120}else if(name==="month"){value=month=parseInt(target.val());update=!isNaN(value)&&value>=1&&value<=12}else if(name==="day"){value=day=parseInt(target.val());update=!isNaN(value)&&value>=1&&value<=31}if(year&&month&&day){var ageInYears=(new Date(new Date-new Date(year,month-1,day))).getFullYear()-1970;update=update&&ageInYears>=18}if(update){date[name]=value;if(event.type!="blur"&&(name=="year"&&target.val().length===4||name!="year"&&target.val().length===
2))setTimeout(function(){target.find("+ input").focus()},50)}else{target.val(null);if(ngModelCtrl.$modelValue)date[name]=null}scope.$apply(function(){ngModelCtrl.$setViewValue(date)})}if(ngModelCtrl&&initialValue)ngModelCtrl.$setViewValue(initialValue);$compile(element.children())(scope)}}}});
rh.ng.directive("rhSinInput",function($filter,$compile,$timeout){return{require:"?ngModel",restrict:"C",compile:function compile(){var dirty=false;var focused=false;var sin=null;var sinParts={sinOne:"",sinTwo:"",sinThree:""};return function(scope,element,attrs,ngModelCtrl){var sinInputs=element.find("> input");ngModelCtrl.$render=function(){if(!ngModelCtrl.$viewValue)return;var sin=ngModelCtrl.$viewValue;sinInputs.each(function(i,input){var input=$(input);var name=input.attr("name");input.val(sin[name])})};
ngModelCtrl.$formatters.unshift(function(modelValue){});ngModelCtrl.$parsers.unshift(function(){return sin});element.bind("click",function(){focused=true;var input=jQuery(element.find("input")[0]);input.focus()});sinInputs.bind("click",function(event){event.stopPropagation()});sinInputs.bind("focus",function(event){focused=true;element.addClass("focus");var input=event.target;input.setSelectionRange(0,input.value.length)});sinInputs.bind("input blur",handleChange);function handleChange(event){if(event.type==
"blur"){focused=false;$timeout(function(){if(!focused){element.removeClass("focus");dirty=true;ngModelCtrl.$dirty=true}})}var target=$(event.target);var name=target.attr("name");if(target.val().length===3){sinParts[name]=target.val();var input=$("#"+name).next(":input");input.eq(input.index("#"+name)+1).focus()}sin=sinParts["sinOne"]+sinParts["sinTwo"]+sinParts["sinThree"];if(sin&&!$.isNumeric(sin)||ngModelCtrl.$viewValue&&target.val().length<3)scope.$apply(function(){ngModelCtrl.$setValidity("",
false);ngModelCtrl.$dirty=true});else if(sin.length===9)scope.$apply(function(){ngModelCtrl.$setValidity("",true);ngModelCtrl.$setViewValue(sin)})}$compile(element.children())(scope);scope.$on("resetSin",function(event){sinParts={sinOne:"",sinTwo:"",sinThree:""};sin=null;ngModelCtrl.$setViewValue(sin);$("#sinOne")[0].value=null;$("#sinTwo")[0].value=null;$("#sinThree")[0].value=null;ngModelCtrl.$setValidity("",true);ngModelCtrl.$setPristine()})}}}});rh=window.rh||{};rh.DetailsProviderRatesTable=rh.DetailsProviderRatesTable||{};rh.DetailsProviderRatesTable.init=function(params){jQuery(function($){$(".rh-details-provider-rates").each(function(){$(this).find(".apply").click(function(event){event.preventDefault();event.stopPropagation();var link=$(this).attr("href");if(link)rh.Dialog.show(link)})})})};rh=window.rh||{};rh.Dialog=rh.Dialog||{};rh.Dialog.minimumPopupWidth=1015;rh.Dialog.minimumPopupHeight=525;rh.Dialog.popupWidth=900;rh.Dialog.popupHeight=700;
rh.Dialog.show=function(link,options){var availableWidth=jQuery(window).outerWidth();var availableHeight=jQuery(window).outerHeight();options=options||{};var minWidth=options.minWidth||rh.Dialog.minimumPopupWidth;var minHeight=options.minHeight||rh.Dialog.minimumPopupHeight;if(window.isMobileView&&isMobileView()){options.isMobile=true;rh.Dialog.openAsPopup(link,options)}else if(options.forcePopup||options.width&&options.height)rh.Dialog.openAsPopup(link,options);else if(availableWidth>minWidth&&availableHeight>
minHeight)rh.Dialog.openAsPopup(link,options);else rh.Dialog.openAsWindow(link,options)};rh.Dialog.close=function(){parent.jQuery.colorbox.close()};
rh.Dialog.openAsPopup=function(link,options){options=options||{};options.width=options.isMobile?"100%":options.width||rh.Dialog.popupWidth;options.height=options.isMobile?"1200px":options.height||rh.Dialog.popupHeight;var popupClass=options.popupClass?options.popupClass:"";popupClass+=" rh-popup";popupClass+=options.isMobile?" rh-popup--mobile":"";var defaults={open:true,iframe:true,scrolling:false,href:rh.Dialog.createLink(link,true),innerWidth:options.width,innerHeight:options.height,top:options.isMobile?
"5%":false,reposition:!options.isMobile,className:popupClass};options=jQuery.extend(defaults,options||{});if(options.inline){options.iframe=false;options.href=link;options.className+=" rh-popup--inline"}if(jQuery.colorbox)jQuery.colorbox(options);else window.open(link)};rh.Dialog.openAsWindow=function(link){window.open(rh.Dialog.createLink(link,false),"_blank")};
rh.Dialog.createLink=function(link,isPopup){var params={};if(isPopup)params["popup"]="popup";if(ratehub.user.aff_info)jQuery.extend(params,ratehub.user.aff_info);return appendQueryParams(link,params)};rh.ng.directive("rhFbAlbum",function(){var tmpl='<ul class="photo-album">'+'\t<li ng-repeat="photo in photos | limitTo:limit" style="width: {{thumbWidth}}px; height: {{thumbHeight}}px; ">'+'\t\t<a ng-attr-href="{{photo.large}}" style="background-image: url({{photo.small}})" ng-click="showPhoto(this)"></a>'+"\t</li>"+"</ul>";return{restrict:"A",scope:{fb_album:"@rhFbAlbum"},replace:true,link:function(scope,elem){var baseFontSize=parseInt(elem.css("font-size"));scope.thumbWidth=9.5*baseFontSize;scope.thumbHeight=
7.5*baseFontSize;var width=elem.parent().width();scope.limit=Math.floor(width/scope.thumbWidth)},controller:function($scope){$.getJSON("https://graph.facebook.com/"+$scope.fb_album+"/photos?callback=?",function(result){var photos=result.data;if(photos&&photos.length)for(var photoId in photos){var photo=photos[photoId];photos[photoId]={"large":photo.source,"small":photo.picture}}$scope.$apply(function(){$scope.photos=photos})});$scope.showPhoto=function(elem){event.preventDefault();event.stopPropagation();
$.colorbox({href:elem.photo.large})}},template:tmpl}});jQuery(function($){$(".rh-featured-agent").each(function(i,element){element=$(element);var mapElement=element.find(".map");if(!mapElement.length)return;var agent=rh.Control.getInfo(element);var map=new rh.Map(mapElement[0],{center:[agent.latitude,agent.longitude],callback:function(){map.addMarker(agent)}})})});jQuery("#popular_content").hide();(function(){var footer=jQuery("footer");if(footer.length){var footerHeight=footer.outerHeight();var footerBottom=footer.position().top+footer.outerHeight();var content=jQuery(".content-area");var windowHeight=jQuery(window).height();if(content.length&&footerBottom<windowHeight){contentMargins=content.outerHeight()-content.height();content.css("min-height",windowHeight-footerHeight-content.position().top-contentMargins)}}})();
jQuery(function($){var slideTime=400;$("#footer_stub").click(function(){$("#popular_content").slideToggle(slideTime,"easeOutExpo")})});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.controller("GicHeadCtrl",function($scope,gicService){$scope.type="non-registered";$scope.term=12;$scope.location=ratehub.user.location;$scope.amount=5E3;$scope.findGic=function(event){event.preventDefault();event.stopPropagation();var url=gicService.getUrl({type:gicService.localizeType($scope.type),term:gicService.termToSlug($scope.term),province:$scope.location.province.slug,investmentAmount:$scope.amount},true);window.location=url}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("AllGicsTableCtrl",function($scope,$sce,$timeout,rhHistoryService,gicService,rhConversionService,rhHttpRequestService,rhTipService,rhEnvironmentService,eyeReturnService,nonMonService,depositsService){var $=jQuery;var GIC_SCENARIO_NON_REGISTERED=0;var GIC_SCENARIO_REGISTERED=1;var GIC_SCENARIO_TFSA=2;var GIC_SCENARIO_US_DOLLARS=3;var GIC_SCENARIOS=[{id:GIC_SCENARIO_NON_REGISTERED,key:"nonRegistered"},{id:GIC_SCENARIO_REGISTERED,key:"registered"},{id:GIC_SCENARIO_TFSA,key:"tfsa"},{id:GIC_SCENARIO_US_DOLLARS,
key:"usd"}];$scope.rateData={};$scope.rates={};$scope.order="-total_return";$scope.defaultLimit=6;$scope.limit=$scope.defaultLimit;$scope.isLoading=false;$scope.restoring=false;$scope.sorted=false;$scope.featuredGicsEnabled=false;$scope.french=Globalize.culture().language==="fr";$scope.isMobile=rhEnvironmentService.isMobileView();var params=parseUrlParams();$scope.filters={tfsa:{},usd:{},registered:{},nonRegistered:{},global:{location:ratehub.user.location,investmentAmount:params.investmentAmount?
params.investmentAmount:5E3},promoOffers:{}};$scope.filters["promoOffers"][GIC_SCENARIOS[GIC_SCENARIO_NON_REGISTERED].key]=false;$scope.filters["promoOffers"][GIC_SCENARIOS[GIC_SCENARIO_REGISTERED].key]=false;$scope.filters["promoOffers"][GIC_SCENARIOS[GIC_SCENARIO_TFSA].key]=false;$scope.filters["promoOffers"][GIC_SCENARIOS[GIC_SCENARIO_US_DOLLARS].key]=false;$scope.getCurrentPromoFilterModel=function(){return $scope.scenario};$scope.getStateObject=function(){return{scenario:$scope.scenario,filters:$scope.filters[$scope.scenario]}};
$scope.toggleLimit=function(){$scope.limit=$scope.limit===$scope.defaultLimit?$scope.rates.length:$scope.defaultLimit};$scope.changeScenario=function(newScenario){$timeout(function(){$('a[href="#'+newScenario+'"]').tab("show")});$scope.scenario=newScenario;$scope.renderTable()};$scope.renderTable=function(trackPage){if(typeof trackPage==="undefined")trackPage=true;var filters=$scope.filters[$scope.scenario];var url=gicService.getUrl({provider:filters.provider!=="all"?filters.provider:null,type:gicService.localizeType($scope.scenario),
term:gicService.termToSlug(filters.term),marketLinked:filters.marketLinkedEligible,redeemable:filters.redeemable!=="all"?filters.redeemable==="redeemable"||filters.redeemable==="rachetable":null,cdic:filters.cdicEligible,purchaseMethod:filters.purchaseMethod!=="no-preference"?filters.purchaseMethod:null,eligibility:filters.eligibility&&filters.eligibility!=="all"?filters.eligibility:null,city:$scope.filters.global.location.id},true);var options={url:url,data:{operation:"getAllGicsTableData"},done:function(response){if(!ratehub.isWidget)if(!$scope.restoring){rhHistoryService.pushState($scope.getStateObject(),
null,url);if(trackPage&&!ratehub.isWidget&&typeof ga==="function"){ga("set","page",url.replace(ratehub.serverUri,""));ga("send","pageview")}}else $scope.restoring=false;document.title=response.title;$scope.$parent.intro=$sce.trustAsHtml(response.intro);$scope.$parent.content=$sce.trustAsHtml(response.content);response.rates=response.rates||[];$scope.rateData=response.rates;$scope.processRates(response.rates);$scope.isLoading=false}};if(ratehub.isWidget)options.data.isWidget=true;$scope.isLoading=
true;rhHttpRequestService.jsonp(options)};$scope.processRates=function(rates){for(var i=0;i<rates.length;i++)rates[i].total_return=calculateTotalReturn(rates[i]);$scope.rates=applyFilters(rates)};$scope.applyForGic=function(event,rate){event.preventDefault();event.stopPropagation();var vertical="gic";var site=rate.site||rate.provider.gic_site||rate.provider.site;var tag=rate.featured?"monetized_gic_leads":"non-monetized_gic_leads";eyeReturnService.getEyeReturnTagCode(tag,{});var conversionOptions=
{isPaid:rate.featured,type:vertical,product:{id:rate.id,providerName:rate.provider.name,productDescription:rate.description}};if(rate.promo_offers.promo_on&&rate.promo_offers.popup_on)rh.Dialog.show(appendQueryParams(rate.href,{"gic-amount":$scope.filters.global.investmentAmount,"widget":ratehub.isWidget}),{width:645,height:745});else if(rate.featured){var url=depositsService.getApplyRedirect(rate.href);window.open(url,"_blank");eyeReturnService.getThankYouPopup(false,vertical,{id:rate.id});rhConversionService.trackConversion(conversionOptions,
"web")}else rh.Dialog.show(appendQueryParams(rate.details_href,{"widget":ratehub.isWidget}))};$scope.sortSponsored=function(rate){return rate.sponsored?0:1};$scope.sortFeatured=function(rate){return rate.featured&&$scope.featuredGicsEnabled?0:1};$scope.isFeatured=function(rate){return rate.featured&&!rate.sponsored&&$scope.featuredGicsEnabled};$scope.getDetailsHref=function(href){return appendQueryParams(href,{city:$scope.filters.global.location.id,widget:ratehub.isWidget})};$scope.$on("tableSorted",
function(event,type){if(type)$scope.order=type;$scope.sorted=true});$scope.$watch("[filters.global.investmentAmount, filters.tfsa.term, filters.usd.term, filters.registered.term, filters.nonRegistered.term]",function(){if($scope.filters.global.investmentAmount>1E5){$scope.filters.tfsa.cdicEligible=false;$scope.filters.usd.cdicEligible=false;$scope.filters.registered.cdicEligible=false;$scope.filters.nonRegistered.cdicEligible=false}if($scope.filters[$scope.scenario].term>60)$scope.filters[$scope.scenario].cdicEligible=
false},true);$scope.$watch("filters.promoOffers",function(){$scope.renderTable(false)},true);$scope.hasPromoOffers=function(){var showPromoOffersChecked=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];var hasAtLeastOnePromoOffer=$scope.rates.length&&$scope.rates.some(function(rate){return rate.promo_offers.promo_on});return showPromoOffersChecked||hasAtLeastOnePromoOffer};$scope.displayPFAIcon=function(rate){return rate.pfa_winner&&ratehub.user.language!=="fr"&&ratehub.experiments&&
ratehub.experiments.gic&&ratehub.experiments.gic.gicPFAIconTest&&ratehub.experiments.gic.gicPFAIconTest===1};rhTipService.setType("allGicsTable");$scope.activateTip=rhTipService.activateTip;$scope.isTipActive=rhTipService.isTipActive;$scope.disableTips=rhTipService.disableTips;function applyFilters(rates){var filteredRates=[];var investmentAmount=$scope.filters.global.investmentAmount;var promoOffers=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];for(var i=0;i<rates.length;i++){if(promoOffers&&
!rates[i].promo_offers.promo_on)continue;if(investmentAmount<rates[i].min_investment)continue;if(investmentAmount>1E5&&(rates[i].provider.slug=="oaken-financial"||rates[i].provider.slug=="hometrust"))continue;filteredRates.push(rates[i])}filteredRates=removeRBCDuplicates(filteredRates);return filteredRates}function calculateTotalReturn(rate){var principal=$scope.filters.global.investmentAmount;var rateValue=rate.value/100;var termInYears=$scope.filters[$scope.scenario].term/12;var compoundingPeriodsPerYear=
1;if(rate.compounded===0)return principal*rateValue*termInYears;else if(rate.compounded===1)compoundingPeriodsPerYear=365;else if(rate.compounded===2)compoundingPeriodsPerYear=12;var balance=principal*Math.pow(1+rateValue/compoundingPeriodsPerYear,termInYears*compoundingPeriodsPerYear);return balance-principal}function removeRBCDuplicates(rates){var rbcRates=rates.filter(function(rate){return rate.provider.slug.indexOf("rbc-royal-bank")>-1});if(rbcRates.length>1){var rbcProfileToRemove=$scope.filters.global.location.id===
797?"rbc-royal-bank":"rbc-royal-bank-winnipeg";rates=rates.filter(function(rate){return rate.provider.slug!==rbcProfileToRemove})}return rates}});
rh.ng.directive("allGicsTable",function($sce,rhHistoryService){var $=jQuery;return{restrict:"C",controller:"AllGicsTableCtrl",link:{pre:function(scope,elem,attrs){scope.scenario=$(".all-gics-table__filters .nav-tabs li.active a").attr("href").substring(1);scope.$parent.intro=$sce.trustAsHtml($('[rh-bind-compile-html="intro"]').html());scope.$parent.content=$sce.trustAsHtml($('[rh-bind-compile-html="content"]').html());scope.featuredGicsEnabled=typeof attrs.featuredGics!=="undefined"},post:function(scope){scope.rateData=
ratehub.gicRates||{};scope.processRates(scope.rateData);scope.renderTable(false);if(!ratehub.isWidget)rhHistoryService.replaceState(scope.getStateObject(),"");$(window).bind("popstate",function(event){event.preventDefault();var state=event.originalEvent.state;if(state)scope.$apply(function(){var newScenario=state.scenario;scope.restoring=true;scope.filters[newScenario]=state.filters;scope.changeScenario(newScenario)})})}}}});
rh.ng.directive("allGicsTableNoResults",function(){var template='<tr ng-show="rates.length === 0">'+"<td>"+"<p>"+ratehub.noRatesMsg+"</p>"+"</td>"+"</tr>";return{restrict:"C",replace:true,template:template}});rh.ng.directive("rhInput",function($parse,rhHttpRequestService){function loadInputValue(el){if(!localStorage)return;var value=null;var name=el.getAttribute("name");var storeAs=el.getAttribute("store-as");var alias=storeAs?storeAs:name;var namespace=$(el).closest("form").attr("name");if(namespace)alias=namespace+"."+alias;if(alias)if(ratehub.user.auto_save_data)value=ratehub.user.auto_dave_data[alias];else value=localStorage.getItem(alias);return value}function storeInputValue(el){if(!localStorage)return;
var name=el.getAttribute("name");var storeAs=el.getAttribute("store-as");var alias=storeAs?storeAs:name;var value=el.value;var namespace=$(el).closest("form").attr("name");if(namespace)alias=namespace+"."+alias;if(alias&&value){localStorage.setItem(alias,value);if(ratehub.user.auto_save_data){var dataObj={};dataObj[alias]=value;rhHttpRequestService.post({url:"?callback=true&operation=autoSaveData",headers:{"Content-Type":"application/json"},data:JSON.stringify(dataObj)})}}}return{restrict:"C",require:"?ngModel",
priority:100,compile:function compile(tElement,tAttrs,transclude){var initialValue=tElement.val();var autoStore=tAttrs.autoStore;if(autoStore)initialValue=loadInputValue(tElement[0]);return{pre:function(scope,element,attrs,ngModelCtrl){if(ngModelCtrl&&initialValue&&!attrs.format)$parse(attrs.ngModel).assign(scope,initialValue)},post:function(scope,elm,attrs,ngModelCtrl){if(ngModelCtrl&&initialValue&&attrs.format)ngModelCtrl.$setViewValue(initialValue);if(attrs.type==="radio"||attrs.type==="checkbox")return;
var changeTrigger=attrs.changeTrigger||"blur";if(changeTrigger!=="change"){elm.off("input").off("keydown").off("change");if(ngModelCtrl){elm.bind("keydown keypress",function(event){if(event.which===13)scope.$apply(function(){ngModelCtrl.$setViewValue(elm.val())})});elm.bind(changeTrigger,function(){scope.$apply(function(){ngModelCtrl.$setViewValue(elm.val())});if(autoStore)storeInputValue(elm[0])})}}}}}}});jQuery("input").placeholder();
jQuery(function($){$("input.input-number").each(function(){var input=$(this);input.attr("pattern","[0-9]*");if(typeof ratehub.user.browser!=="undefined"){var browser=ratehub.user.browser;if(browser.mobile&&browser.mobile==="android")try{input.attr("type","tel")}catch(e){}}})});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("rhLogin",function(loginService){return{restrict:"A",controller:"LoginCtrl",link:function(scope,self,attrs){scope.currentPanel=attrs.initialPanel||"login-forms";if(window.location.search.indexOf("reset=true")>0)loginService.displaySaveBar("reset-password")}}});
rh.ng.controller("LoginCtrl",function($scope,$sce,rhHttpRequestService,loginService){$scope.isInvalid=function(elem,formName){return elem.$invalid&&(elem.$dirty||$scope[formName].submitted)};$scope.login=function(){loginService.login($scope,false,null,null)};$scope.register=function(){loginService.register($scope,false)};$scope.requestPasswordReset=function(){loginService.requestPasswordReset($scope)};$scope.showPanel=function(panelName,e){if(e){e.preventDefault();e.stopPropagation()}$scope.currentPanel=
panelName};$scope.resetPassword=function(){if($scope.resetPasswordForm.$valid){$scope.submitting=true;var formData=$("#resetPasswordForm").serialize();var options={url:"/api/password/reset",data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){window.open(ratehub.serverUri+"/login?reset=true","_self")},error:function(response){$scope.resetPasswordErrMsg=Globalize.localize(response.errors[0].code);$scope.submitting=false}};rhHttpRequestService.post(options)}else $scope.resetPasswordForm.submitted=
true}});jQuery(function($){var slideTime=400;var delayTime=400;function showSubmenu(item){var parent=item.parent();var submenu=item.find("> .submenu");if(!mobile){var position=item.position();if(parent.is(".submenu")){submenu.css("top",0);submenu.css("left",position.left+item.width())}else if(position.left+submenu.outerWidth()>$(document).outerWidth())submenu.css("left",position.left+item.outerWidth()-submenu.outerWidth()-1);if(submenu.hasClass("hang-left")){var itemRect=item.get(0).getBoundingClientRect();
submenu.css({left:itemRect.left-submenu.outerWidth()+itemRect.width+"px"})}else if(submenu.hasClass("hang-right")){var itemRect=item.get(0).getBoundingClientRect();submenu.css({left:itemRect.left+"px"})}}else submenu.css("left",0);item.siblings().find(" > .submenu").hide().end().find("> a, > span").find(".submenu-indicator").removeClass("submenu-expanded");submenu.slideDown(slideTime,"easeOutExpo");item.find("> a, > span").find(".submenu-indicator").addClass("submenu-expanded")}function hideSubmenu(item){var submenu=
item.find("> .submenu");submenu.slideUp(slideTime,"easeOutExpo");item.find("> a, > span").find(".submenu-indicator").removeClass("submenu-expanded")}function drillIntoSubmenu(item){var parentMenuItem=item.parents("li");var clonedItem=$("<li></li").attr("class","drill-down");var displayItem=parentMenuItem.find("> a, > span").clone();displayItem.find("i.submenu-indicator").after('<span class="parent"></span>');displayItem.find(".parent").text(item.find("> a, > span").text());clonedItem.data("drillItem",
item);clonedItem.append(displayItem);parentMenuItem.parent().prepend(clonedItem);clonedItem.siblings().hide();var submenu=null;if(item.find("> .content").length){submenu=$("<ul></ul>").attr("class","submenu");item.find("li").each(function(index,item){submenu.append($(item).clone())})}else submenu=item.find("> ul.submenu");clonedItem.append(submenu);clonedItem.click(function(event){var target=$(event.target);if(target.is(".drill-down")||target.parentsUntil("ul").is(".drill-down")){event.stopPropagation();
event.preventDefault();escapeFromSubmenu(clonedItem)}})}function escapeFromSubmenu(item){item.siblings().css("display","");var menuItem=item.data("drillItem");if(!menuItem.find("> .content").length)menuItem.append(item.find("> .submenu"));$(item).remove()}var mobile=false;var width=null;var scrollTop=null;$("ul.menu").each(function(index,menu){$(menu).find("li").each(function(i,element){var item=$(element);var submenu=item.find("> .submenu");if(item.attr("data-url")&&item.attr("data-url")===window.ratehub.canonicalUrl)item.addClass("active");
if(submenu.length)item.hoverIntent({over:function(){if(!mobile)showSubmenu(item)},out:function(){if(!mobile)hideSubmenu(item)},timeout:delayTime});item.click(function(event){var target=$(event.target);if(mobile&&(target.is(".submenu-indicator")||target.is(".fa-search"))){event.stopPropagation();event.preventDefault();var menuItem=$(this);if(menuItem.parent().is(".menu, .drill-down > .submenu"))if(!target.is(".submenu-expanded"))showSubmenu(menuItem);else hideSubmenu(menuItem);else drillIntoSubmenu(menuItem)}})});
$(this).find(".submenu.advanced > li:first-child").addClass("active");$(this).find(".submenu.advanced > li").hoverIntent({over:function(){$(this.parentNode).find(".active").removeClass("active");$(this).addClass("active")},timeout:delayTime});$(this).find("> li.active, .submenu.simple > li.active").parents("li").addClass("active")});$("ul.rh-panels > li:not(.collapsed), ul.rh-check-list > li.checked").each(function(i,element){$(element).parents("li").removeClass("collapsed")});$("#nav_mobile").click(function(){function showMobileMenu(){mobile=
true;width=$(window).width();scrollTop=$(window).scrollTop();$("#topbar").addClass("nav-mobile-open").closest("header").siblings().each(function(){$(this).css("top",$(this).offset().top-$("body").scrollTop())}).each(function(){$(this).css("position","fixed").css("z-index",-1)}).end().end().css("position","static");$("#my_account").appendTo($("#nav_main ul.menu"));$("#nav_main").find("ul.menu").addClass("mobile").removeClass("desktop").end().slideDown(slideTime,"easeOutExpo");$("#nav_mobile").addClass("submenu-expanded");
$("#search .fa-close").click(function(){hideSubmenu($("li.search"))});$(document.body).bind("click",clickOutHandler);$(window).bind("resize",resizeHandler);$("#nav_logo").addClass("nav_logo--hidden");$("#nav_mobile").after($("#nav_other"))}function hideMobileMenu(immediate){if(immediate){$("#nav_main").css("display","").find("ul.menu").removeClass("mobile").addClass("desktop");$("#nav_main").find("li.drill-down").each(function(){escapeFromSubmenu($(this))})}else $("#nav_main").slideUp(slideTime,"easeOutExpo",
function(){$(this).find("ul.menu").removeClass("mobile").addClass("desktop").end().css("display","");$(this).find("li.drill-down").each(function(){escapeFromSubmenu($(this))})});$("#nav_mobile").removeClass("submenu-expanded");$(document.body).unbind("click",clickOutHandler);$(window).unbind("resize",resizeHandler);$("#nav_logo").removeClass("nav_logo--hidden");$("#nav_mobile").after($("#nav_other"));$("#my_account").appendTo($("#nav_other ul.menu"));$("#topbar").css("position","").removeClass("nav-mobile-open").closest("header").siblings().each(function(i,
element){$(element).css("top","").css("position","").css("z-index","")});mobile=false;$(window).scrollTop(scrollTop)}var clickOutHandler=function(event){var target=$(event.target);if(!target.closest("#topbar").length)hideMobileMenu()};var resizeHandler=function(event){if($(window).width()!=width)hideMobileMenu(true)};if($(this).is(".submenu-expanded"))hideMobileMenu();else showMobileMenu()})});rh=window.rh||{};rh.Map=function(el,options){if(!el)return;if(!rh.Map.loaded)jQuery(function($){$.ajax({dataType:"script",cache:true,url:"https://maps.google.com/maps/api/js?sensor=false&region=CA&callback=rh.Map.apiLoaded&key="+ratehub.mapsKey})});this.el=el;this.id=el.id||"Map_"+Math.floor(Math.random()*99999)+1;this.options=options;this.markers=[];this.selected=null;this.initialized=false;this.initialize()};rh.Map.maps={};
rh.Map.apiLoaded=function(){rh.Map.loaded=true;jQuery.each(rh.Map.maps,function(i,map){map.initialize()})};
rh.Map.prototype.initialize=function(){rh.Map.maps[this.id]=this;if(!rh.Map.loaded||this.initialized)return;this.mapBounds=new google.maps.LatLngBounds;var defaultOptions={zoom:10,scrollwheel:false,mapTypeId:google.maps.MapTypeId.ROADMAP};this.options=jQuery.extend(defaultOptions,this.options);if(typeof this.options.center==="string"){var self=this;var geocoder=new google.maps.Geocoder;geocoder.geocode({address:this.options.center},function(results,status){if(status!=google.maps.GeocoderStatus.OK)return;
self.options.center=results[0].geometry.location;self.createMap()});return}else if(jQuery.isArray(this.options.center))this.options.center=new google.maps.LatLng(this.options.center[0],this.options.center[1]);this.createMap()};rh.Map.prototype.createMap=function(){if(this.options.center)this.mapBounds.extend(this.options.center);this.map=new google.maps.Map(this.el,this.options);this.initialized=true;var self=this;google.maps.event.addListenerOnce(this.map,"bounds_changed",function(){if(self.options.callback)self.options.callback()})};
rh.Map.prototype.addMarker=function(m,fit){if(!this.initialized||!m)return;var bounds=this.map.getBounds();var needsFit=false;if(!(m instanceof Array))m=[m];for(var i=0;i<m.length;i++)if(m[i].latitude&&m[i].longitude){var marker=injectMarker.call(this,m[i]);needsFit=bounds&&(needsFit||!bounds.contains(marker.getPosition()))}if(fit&&needsFit)this.fitMarkers();if(this.markers.length===1){var self=this;google.maps.event.addListenerOnce(this.map,"idle",function(){self.selectMarker(self.markers[0])})}function injectMarker(m){var infoContent=
"";if(m.name)infoContent+="<strong>"+m.name+"</strong><br/>";if(m.provider&&m.provider.name)infoContent+='<span style="font-size:0.9em;">'+m.provider.name+"</span><br/>";if(m.profile_href)infoContent+='<div style="font-size:0.85em;padding-top:0.3em">'+'<a href="'+m.profile_href+'" style="font-size:0.85em">'+Globalize.localize("view-profile")+"</a>"+"&nbsp;&nbsp;&nbsp;"+'<a href="'+m.contact_href+'" style="font-size:0.85em">'+Globalize.localize("contact-now")+"</a>"+"</div>";if(m.address){infoContent+=
'<address style="font-size:0.9em;padding-top:1em">';if(m.address instanceof Array)infoContent+=m.address.join("<br />");else infoContent+=m.address;infoContent+="</address>"}var marker=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(m.latitude,m.longitude),title:m.name,infoWindow:new google.maps.InfoWindow({content:infoContent}),context:m});var self=this;google.maps.event.addListener(marker,"click",function(){self.selectMarker(this)});this.markers.push(marker);return marker}};
rh.Map.prototype.clearMarkers=function(){if(!this.initialized)return;$.each(this.markers,function(i,marker){marker.setMap(null)});this.markers=[]};rh.Map.prototype.fitMarkers=function(){if(!this.initialized)return;var self=this;$.each(this.markers,function(i,marker){self.mapBounds.extend(marker.position);self.map.fitBounds(self.mapBounds)})};
rh.Map.prototype.selectMarker=function(marker){if(!this.initialized||this.selected===marker)return;$.each(this.markers,function(i,marker){marker.infoWindow.close()});marker.infoWindow.open(this.map,marker);this.selected=marker;$(this.el).trigger("selectionChanged")};rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("rhMasterProviderRates",function(){return{restrict:"C",controller:function($scope){$scope.tableData=ratehub.masterProviderRatesTable}}});rh.ng.directive("rhMasterProviderRatesRow",function(){return{restrict:"A",link:function(scope,elem){elem.find(".apply").click(function(event){event.preventDefault();event.stopPropagation();var link=$(this).attr("href");rh.Dialog.show(link)})}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("MortgageHeadCtrl",function($scope){$scope.scenario="purchase";$scope.type="fixed";$scope.term="5";$scope.location=ratehub.user.location;$scope.findMortgage=function(event){event.preventDefault();event.stopPropagation();var scenario=$scope.scenario;var type=$scope.type;var term=$scope.term;var url=getAllRatesUrl({type:scenario==="heloc"?"heloc":type,term:term});url+=scenario==="heloc"?"":"/?scenario="+scenario;window.location=url}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("rhMortgageQuote",function(){return{restrict:"C",controller:"MortgageQuoteCtrl"}});
rh.ng.controller("MortgageQuoteCtrl",function($scope,$timeout,rhHttpRequestService,mortgageService){$scope.currentStep=0;$scope.rates=null;$scope.preapprovalRates=null;$scope.helocRate=null;$scope.checks={};$scope.forms={purchase:{homePrice:25E4,downPayment:5E4,downPaymentPercent:.2,mortgageAmount:function(){return mortgageService.getMortgageAmount($scope.forms.purchase.homePrice,$scope.forms.purchase.downPayment,25)}},heloc:{}};$scope.isInvalid=function(elem){return elem.$invalid&&elem.$dirty};$scope.previous=
function(prevent){if(prevent)return;if($scope.currentStep===2&&$scope.scenario==="heloc")$scope.currentStep-=2;else $scope.currentStep--};$scope.next=function(prevent){if(prevent)return;if($scope.currentStep===0&&$scope.scenario==="heloc")$scope.currentStep+=2;else $scope.currentStep++};$scope.checkScenario=function(newScenario){$scope.checks[$scope.scenario]=false;$scope.scenario=newScenario;$scope.checks[newScenario]=true};$scope.serializeForm=function(){var form=$scope.forms[$scope.scenario];var obj=
angular.extend({scenario:$scope.scenario,product_type:"quotedrate"},form);if(obj.mortgage_type)if(obj.mortgage_type==="rates")obj.already_found_new_home="yes";else obj.already_found_new_home="no";if(form.renewal_day){var date=new Date(form.renewal_year+"-"+form.renewal_month+"-"+form.renewal_day);if(date=="Invalid Date")obj.mortgage_renewal_date="0000-00-00";else obj.mortgage_renewal_date=date.toLocaleDateString(["en-ca"])}if($scope.gotRates()){obj.fixed_rate_value=$scope.rates[0].value;obj.fixed_rate_id=
$scope.rates[0].id;obj.variable_rate_value=$scope.rates[1].value;obj.variable_rate_id=$scope.rates[1].id}if($scope.gotHelocRate()){obj.heloc_rate_value=$scope.helocRate.value;obj.heloc_rate_id=$scope.helocRate.id}if($scope.gotPreapprovalRate()){obj.pre_approval_rate_value=$scope.preapprovalRate.value;obj.pre_approval_rate_id=$scope.preapprovalRate.id}return $.param(obj)};$scope.submitForm=function(){$scope.submitting=true;var options={url:url=ratehub.serverUri+ratehub.requestPath+"?callback=JSON_CALLBACK&"+
$scope.serializeForm()};rhHttpRequestService.get(options,function(data){$scope.rates=data.rates;$scope.preapprovalRate=data.preapprovalRate;$scope.helocRate=data.helocRate;$scope.submitting=false;$scope.next()})};$scope.submitFormMaybe=function(){if($scope.scenario==="heloc")$scope.submitForm();else $scope.next()};$scope.scheduleMeeting=function(event){event.preventDefault();event.stopPropagation();var url=event.target.getAttribute("href")+"?"+$scope.serializeForm();rh.Dialog.show(url,{minHeight:350,
height:320})};$scope.gotRates=function(){return $scope.rates&&$scope.rates.length>0};$scope.gotPreapprovalRate=function(){return $scope.preapprovalRate};$scope.gotHelocRate=function(){return $scope.helocRate};$scope.$watch("[forms.purchase.downPaymentPercent, forms.purchase.form_of_residence]",function(newValue,oldValue){var isValid=true;if(newValue[0]<.2&&newValue[1]==="renting")isValid=false;$scope.purchaseForm.form_of_residence.$setValidity("form_of_residence",isValid);$scope.purchaseForm.down_payment_percent.$setValidity("down_payment_percent",
isValid)},true)});rh.ng.directive("multiNav",function($timeout){return{restrict:"C",link:function(scope,elem){elem.find('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var currentTab=e.target.hash.substr(1);var activeElement="sponsored-"+currentTab.replace(/[A-Z]/g,function(c){return"-"+c.toLowerCase()});var ad=ratehub.ads.tags[activeElement];if(ad){window.googletag=window.googletag||{};googletag.cmd=googletag.cmd||[];googletag.cmd.push(function(){googletag.display(ad[2])})}})}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("NonMonFormsCtrl",function($scope,$compile,$timeout,rhHttpRequestService,rhConversionService,loginService,eyeReturnService){var $=jQuery;$scope.answers={};$scope.productTypeSlugs={creditcard:"cc",gic:"gic",chequing:"chq",savings:"sav"};$scope.setPage=function(page){if(page==="questions")$scope.getUserAnswers();$scope.page=page};$scope.login=function(){loginService.login($scope,true,null)};$scope.register=function(){loginService.register($scope,true)};$scope.requestPasswordReset=function(){loginService.requestPasswordReset($scope)};
$scope.submitPersonalizedOfferForm=function(){if($scope.answers.income&&$scope.answers.creditScore&&$scope.answers.verticalFeature){$scope.submitting=true;window.open(rhConversionService.getCloakedUrl($scope.productSite),"_blank");$scope.postPersonalizedOfferData()}else $scope.personalizedOfferErrMsg=Globalize.localize("missing-answers-err-msg")};$scope.postPersonalizedOfferData=function(){var formData=$("#personalizedOfferForm").serialize();formData+="&product-id="+$scope.productId;formData+=window.location.search.replace("?",
"&");var options={url:"/login?callback=true&operation=savePersonalizedOfferData",data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){$scope.submitting=false;$scope.submitLead(formData,data,function(){eyeReturnService.getThankYouPopup(false,$scope.productType,{nonMonFirst:true})})},error:function(data){$scope.personalizedOfferErrMsg=data;$scope.submitting=false}};rhHttpRequestService.post(options)};$scope.submitLead=function(formData,userData,callback){formData+=
"&province="+(ratehub.user&&ratehub.user.location?ratehub.user.location.province.code:"ON");formData+=userData;var options={serializedForm:formData,type:$scope.agent?"agent":$scope.productType,isPaid:false,nonMonForm:true,product:{id:$scope.productId,providerName:$scope.providerName,productDescription:$scope.productDescription},done:callback};if($scope.productType==="creditcard")options.card=ratehub.creditCard;rhConversionService.lead(options)};$scope.getUserAnswers=function(){var options={url:"/login?callback=true&operation=getUserAnswers",
data:"vertical="+$scope.productType+"&_token="+ratehub.csrf,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){$scope.answers=data}};rhHttpRequestService.post(options)};$scope.loginCallback=function(priorLeads){$scope.submitting=false;if(!priorLeads||!priorLeads[$scope.productTypeSlug])$scope.setPage("questions");else{var options={isPaid:false,type:$scope.productType,product:{id:$scope.productId,providerName:$scope.productDescription,productDescription:$scope.providerName},
done:function(){window.open(rhConversionService.getCloakedUrl($scope.productSite),"_blank");eyeReturnService.getThankYouPopup(false,$scope.productType,{nonMonFirst:true})}};if($scope.productType==="creditcard")options.card=ratehub.creditCard;rhConversionService.webClick(options)}}});
rh.ng.directive("rhNonMonForms",function(){return{restrict:"C",controller:"NonMonFormsCtrl",link:{pre:function(scope,elem,attrs){scope.productId=attrs.productId;scope.productSite=attrs.productSite;scope.productType=attrs.productType;scope.productTypeSlug=scope.productTypeSlugs[scope.productType];scope.setPage(typeof ratehub.user.logged_in!=="undefined"&&ratehub.user.logged_in?"questions":"initial")}}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("rhPromoOfferFilterCtrl",function($scope,$element){var $ctrl=this;$ctrl.init=function(){$ctrl.parentElement=$element[0];$ctrl.helpOuter=$ctrl.parentElement.querySelector(".help-outer");$ctrl.helpInner=$ctrl.parentElement.querySelector(".help-inner");if($ctrl.parentElement.classList.contains("open")){$ctrl.toggleHelpLabel=Globalize.localize("show-less-title");$ctrl.helpOuter.style.maxHeight=$ctrl.helpInner.clientHeight+"px"}else{$ctrl.toggleHelpLabel=Globalize.localize("show-more-title");
$ctrl.helpOuter.style.maxHeight="0px"}window.addEventListener("resize",function(){if($ctrl.parentElement.classList.contains("open"))$ctrl.helpOuter.style.maxHeight=$ctrl.helpInner.clientHeight+"px"})};$ctrl.saveToggleState=function(state){$.cookie("rhPromoOfferFilterCtrl-toggleState",state,{expires:365,domain:"."+window.location.hostname,path:"/"})};$ctrl.toggleHelp=function(){if($ctrl.parentElement.classList.contains("open"))$ctrl.closeHelp();else $ctrl.openHelp()};$ctrl.openHelp=function(){$ctrl.toggleHelpLabel=
Globalize.localize("show-less-title");$ctrl.parentElement.classList.add("open");$ctrl.helpOuter.style.maxHeight=$ctrl.helpInner.clientHeight+"px";$ctrl.saveToggleState("open")};$ctrl.closeHelp=function(){$ctrl.toggleHelpLabel=Globalize.localize("show-more-title");$ctrl.parentElement.classList.remove("open");$ctrl.helpOuter.style.maxHeight=0;$ctrl.saveToggleState("closed")};$ctrl.init()});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("PromoOfferCtrl",function($scope,$compile,$timeout,rhHttpRequestService,rhConversionService,eyeReturnService){var $=jQuery;$scope.inputs={};$scope.submitPromoForm=function(){if($scope.detailsForm.$valid){$("#detailsForm button[type=submit]").attr("disabled",true);var formData=$("#detailsForm").serialize();var options={serializedForm:formData,type:$scope.inputs.productType,isPaid:true,product:{providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription},
done:function(data){if($scope.productType==="mortgage"&&!ratehub.isWidget)eyeReturnService.getEyeReturnTagCode("submit_request_button",{"subscribe":$scope.inputs.subscribe,"productType":$scope.inputs.productType,"data":data,"mortgage":true});else eyeReturnService.getThankYouPopup($scope.inputs.subscribe,$scope.inputs.productType,data)}};if($scope.inputs.productType==="creditcard")options.card=ratehub.creditCard;rhConversionService.lead(options);window.open($scope.inputs.promoSite,"_blank")}else $scope.detailsForm.submitted=
true}});rh.ng.directive("rhPromoOffer",function(){return{restrict:"C",controller:"PromoOfferCtrl",link:{pre:function(scope,elem,attrs){}}}});rh.ng.directive("rhProvider",function(){var tmpl='<span class="rh-provider">'+'<span class="provider-logo">'+'<img ng-attr-src="{{provider.logo}}" />'+"</span>"+'<span class="provider-name">'+"{{provider.name}}"+'<span class="brand" ng-if="provider.subtext" ng-bind="provider.subtext"></span>'+'<div class="rating" ng-if="provider.rating">'+'<span rh-rating="provider.rating"></span>'+'<a class="reviews-link" href="{{provider.reviews_href}}" force-popup="true" rh-popup popup-height="650px">'+"("+"{{provider.reviews.length}}"+
")"+"</a>"+"</div>"+'<span ng-if="provider.fsco_license" class="fsco">FSCO {{provider.fsco_license}}</span>'+"</span>"+"</span>";return{restrict:"A",scope:{provider:"=rhProvider"},replace:true,template:tmpl}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("ReviewsCtrl",function($scope,$timeout){var $=jQuery;$scope.sortBy="newest-oldest";$scope.averageRating=null;$scope.renderReviews=function(){if(!$scope.averageRating)$scope.calculateAverageRating();switch($scope.sortBy){case "oldest-newest":$scope.reviews.sort(function(a,b){if(a.date.date<b.date.date)return-1;else if(a.date.date>b.date.date)return 1;return 0});break;case "highest-lowest":$scope.reviews.sort(function(a,b){if(a.rating<b.rating)return 1;else if(a.rating>b.rating)return-1;
return 0});break;case "lowest-highest":$scope.reviews.sort(function(a,b){if(a.rating<b.rating)return-1;else if(a.rating>b.rating)return 1;return 0});break;default:$scope.reviews.sort(function(a,b){if(a.date.date<b.date.date)return 1;else if(a.date.date>b.date.date)return-1;return 0})}};$scope.calculateAverageRating=function(){var sum=0;$.each($scope.reviews,function(i,review){sum+=review.rating});$scope.averageRating=(sum/$scope.reviews.length).toPrecision(2)};$scope.getDateString=function(dateTime){return Globalize.format(new Date(dateTime),
"MMMM dd, yyyy")};$scope.loadMore=function(){$scope.limit=$scope.reviews.length;$scope.showAllReviews=true;if(!$scope.reviewsHeight)calcHeight();$scope.this.find(".reviews-pane").css({height:$scope.reviewsHeight+"px","overflow-y":"scroll"})};$timeout(function(){calcHeight()});function calcHeight(){$scope.reviewsHeight=$scope.this.find(".reviews-pane").outerHeight()}});
rh.ng.directive("rhReviews",function($sce,rhEnvironmentService){return{restrict:"C",controller:"ReviewsCtrl",link:{pre:function(scope,elem,attrs){scope.this=elem;scope.reviews=attrs.reviews?JSON.parse(attrs.reviews):ratehub.reviews||[];scope.reviews=Object.values(scope.reviews);scope.limit=ratehub.user.browser.mobile?2:3;scope.renderReviews()}}}});rh.ng.directive("rhRate",function(){var tmpl='<span class="rh-rate">'+"<span ng-bind-html=\"rate.value | format:'p2':true\"></span>"+'<div class="sub" ng-if="rate.additional_info">{{rate.additional_info}}</div>'+"</span>";return{restrict:"A",scope:{rate:"=rhRate"},template:tmpl}});
rh.ng.directive("rhRateBadge",function(){var tmpl='<div class="badge">'+'<div class="badge__title" ng-if="rate.extended_description">{{rate.extended_description}}</div>'+'<div class="badge__info">'+'<a ng-if="rate.href" ng-attr-href="rate.href" rh-popup ng-bind-html="rate.value | format:\'p2\':true"></a>'+'<span ng-if="!rate.href" ng-bind-html="rate.value | format:\'p2\':true"></span>'+'<sub ng-if="rate.additional_info">{{rate.additional_info}}</sub>'+"</div>"+"</div>";return{restrict:"C",scope:{rate:"=rate"},
template:tmpl}});rh=window.rh||{};rh.RateSelector=function(params){this.$=jQuery;this.id=params.id;this.callbackUrl=params.callbackUrl||null;this.operation=params.operation||null;this.options={"year":params.y||null,"term":params.t||null,"scenario":params.scenario||null,"provider":params.provider||null,"showLowest":params.showLowest||null,"liveInProperty":params.liveInProperty||null};this.rateSelector=null;this.initialize()};
rh.RateSelector.prototype.initialize=function(){var self=this;this.rateSelector=this.$(".rh-rate-selector");this.rateSelector.find(".rate-display-custom a").click(function(event){event.preventDefault();var rate=Globalize.parseFloat(self.rateSelector.find(".rate-display-custom input").val());if(isNaN(rate)||rate==null){alert("Please enter a valid rate.");return}var ret={value:parseFloat(rate),provider:null};self.$.colorbox.result=ret;self.$.colorbox.close()});setTimeout(function(){self.rateSelector.find("select, input").change(function(event){self.filterTermOptions(options);
self.updateRates()})});var options=this.$("#rs-term").children();this.filterTermOptions(options);this.$(".rate-selector").click(function(event){event.preventDefault();event.stopPropagation();var isMobile=window.isMobileView&&isMobileView();jQuery.colorbox({open:true,inline:true,trapFocus:false,elem:event.target,href:self.rateSelector,className:"rh rh-popup",innerWidth:isMobile?"100%":"400px",onOpen:function(){if(self.rateSelector.find(".loading").length)if(typeof window.initSelects==="function")self.rateSelector.find("select").each(function(){window.initSelects(this)});
self.updateRates()},onClosed:function(){self.rateSelector.trigger("rateSelected")}})})};
rh.RateSelector.prototype.updateRates=function(){var self=this;var xhrParams={"operation":self.operation,"y":this.$("#rs-term").val(),"t":this.$("#rs-type").val()};if(this.options.scenario)xhrParams.scenario=this.options.scenario;if(this.options.provider)xhrParams.provider=this.options.provider;if(this.options.showLowest)xhrParams.showlowest=this.options.showLowest;if(this.options.liveInProperty)xhrParams.live_in_property=this.options.liveInProperty;this.$.getJSON(this.callbackUrl,xhrParams,function(result){self.rateSelector.find(".rate-display tbody").children(".rate-display-best").remove().end().prepend(self.$("#rs-rate-template").tmpl(result));
self.$.colorbox.resize();self.rateSelector.find(".rate-display-best a").click(function(event){var rate=self.$(event.currentTarget).closest("tr").tmplItem().data;self.$.colorbox.result=rate;self.$.colorbox.close();event.preventDefault()})})};
rh.RateSelector.prototype.filterTermOptions=function(options,includeSelected){var typeCode=this.$("#rs-type").val();var termInput=this.$("#rs-term");var selected=termInput.val();if(selected!="na")selected=parseInt(selected);termInput.empty();var terms=ratehub.rateTypes[typeCode];if(includeSelected)if(this.$.inArray(selected,terms)==-1){terms.push(selected);terms.sort(function(a,b){return a-b})}this.$.each(terms,function(i,term){if(term==0)term="na";termInput.append(options.filter("option[value='"+
term+"']"))});termInput.val(selected);if(typeCode==3){termInput.append('<option value="na" selected="selected">N/A</option>');termInput.attr("disabled",true)}else{termInput.find("option[value=na]").remove();termInput.attr("disabled",false)}};rh.ng.directive("rhRating",function(){return{restrict:"A",scope:{rating:"=rhRating",max:"@"},controller:function($scope){$scope.stars=function(){var max=$scope.max||5;var stars=[];for(var i=0;i<max;i++){var star=$scope.rating-i;if(star>=1)stars.push("fa-star");else if(star>0)stars.push("fa-star-half-o");else stars.push("fa-star-o")}return stars}},template:'<span class="rh-star-rating"><meta itemprop="rating" ng-attr-content="{{rating}}" /><i ng-repeat="star in stars() track by $index" class="fa" ng-class="star" /></span>'}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("ReEnablePopupCtrl",function($scope,$compile,$timeout,rhHttpRequestService){var $=jQuery;$scope.reEnableAccount=function(){$scope.submitting=true;var params=window.location.search.substring(1);var options={url:"/api/account/re-enable",data:params,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){$scope.currentPanel="email-verify";$scope.submitting=false},error:function(response){$scope.reEnableErrMsg=Globalize.localize(response.errors[0].code);$scope.submitting=
false}};rhHttpRequestService.post(options)};$scope.createNewAccount=function(){rh.Dialog.close()}});rh.ng.directive("reEnablePopup",function(){return{restrict:"C",controller:"ReEnablePopupCtrl",link:{}}});rh.ng.service("creditCardService",function(rhEnvironmentService,rhConversionService,eyeReturnService){var slugs={en:{"credit-cards":"credit-cards","rewards":"rewards","balance-transfer":"balance-transfer","low-interest":"low-interest","secured":"secured","student":"student","business":"business","no-fee":"no-fee","cash-back":"cash-back","travel":"travel","store-credit":"store-credit","american-express":"american-express","bank-of-montreal":"bank-of-montreal","canadian-tire":"canadian-tire","capital-one":"capital-one",
"chase":"chase","cibc":"cibc","home-trust":"home-trust","hsbc":"hsbc","mbna":"mbna","rbc-royal-bank":"rbc-royal-bank","scotiabank":"scotiabank","tangerine":"tangerine","td-bank":"td-bank","walmart":"walmart","pc-financial":"pc-financial","desjardins":"desjardins","laurentian-bank":"laurentian-bank","national-bank":"national-bank","rogers-bank":"rogers-bank","hudsons-bay":"hudsons-bay","peoples-trust-company":"peoples-trust-company"},fr:{"credit-cards":"cartes-de-credit","rewards":"recompenses","balance-transfer":"transfert-de-solde",
"low-interest":"faible-taux-d-interets","secured":"guarantie","student":"etudiant","business":"entreprises","no-fee":"sans-frais","cash-back":"remise-en-argent","travel":"voyages","store-credit":"credit-magasins","american-express":"american-express","bank-of-montreal":"banque-de-montreal","canadian-tire":"canadian-tire","capital-one":"capital-one","chase":"chase","cibc":"banque-cibc","home-trust":"home-trust","hsbc":"hsbc","mbna":"mbna","rbc-royal-bank":"banque-royale","scotiabank":"banque-scotia",
"tangerine":"tangerine","td-bank":"banque-td","walmart":"walmart","pc-financial":"le-choix-du-president-services-financiers","desjardins":"desjardins","laurentian-bank":"banque-laurentian","national-bank":"banque-nationale-du-canada","rogers-bank":"rogers-bank","hudsons-bay":"hudsons-bay","peoples-trust-company":"peoples-trust-company"}};this.getUrl=function(options){var lang=Globalize.culture().language;var urlPieces=[];if(options.provider){var piece=slugs[lang][options.provider]||options.provider;
urlPieces.push(piece)}if(options.type){var piece=slugs[lang][options.type]||options.type;urlPieces.push(piece)}var queryPieces=[];if(typeof options.params!=="undefined"){if(options.params.fee)queryPieces.push("fee="+options.params.fee);if(options.params.usage)queryPieces.push("usage="+options.params.usage);if(options.params.creditScore)queryPieces.push("creditScore="+options.params.creditScore);if(options.params.network)queryPieces.push("network="+options.params.network)}return ratehub.serverUri+
"/"+slugs[lang]["credit-cards"]+(urlPieces.length?"/"+urlPieces.join("/")+(queryPieces.length?"?"+queryPieces.join("&"):""):"")};this.applyForCard=function(event,card,redirect){event.preventDefault();event.stopPropagation();var popupOptions={isMobile:rhEnvironmentService.isMobileView()};if(typeof card==="undefined"){window.open(event.target.href);return}var tag=card.monetized?"monetized_credit_card_leads":"non-monetized_credit_card_leads";eyeReturnService.getEyeReturnTagCode(tag,{});var conversionOptions=
{isPaid:card.monetized,type:"creditcard",card:card,product:{id:card.id,providerName:card.bank,productDescription:card.name}};if(card.monetized&&(!card.promo_offers.promo_on||!card.promo_offers.popup_on)){var url=card.apply_redirect;if(redirect)url=appendQueryParams(url,{goto:redirect});if(ratehub.experiments)url+="&experiments="+encodeURIComponent(JSON.stringify(ratehub.experiments));if(ratehub.analytics&&ratehub.analytics.visitorId)url+="&visitorId="+ratehub.analytics.visitorId;window.open(url,"_blank");
rhConversionService.trackConversion(conversionOptions,"web")}else{popupOptions.width=645;popupOptions.height=745}var url=appendQueryParams(card.promo_url,{"widget":ratehub.isWidget});rh.Dialog.show(url,popupOptions)};this.distributeSpending=function(spendingCategories,monthlySpending){var oldTotal=spendingCategories.groceries+spendingCategories.gas+spendingCategories.restaurants+spendingCategories.bills+spendingCategories.travel+spendingCategories.entertainment+spendingCategories.pharmacy+spendingCategories.other;
var currentProportions={groceries:spendingCategories.groceries/oldTotal,gas:spendingCategories.gas/oldTotal,restaurants:spendingCategories.restaurants/oldTotal,bills:spendingCategories.bills/oldTotal,travel:spendingCategories.travel/oldTotal,entertainment:spendingCategories.entertainment/oldTotal,pharmacy:spendingCategories.pharmacy/oldTotal,other:spendingCategories.other/oldTotal};spendingCategories.groceries=monthlySpending*currentProportions.groceries;spendingCategories.gas=monthlySpending*currentProportions.gas;
spendingCategories.restaurants=monthlySpending*currentProportions.restaurants;spendingCategories.bills=monthlySpending*currentProportions.bills;spendingCategories.travel=monthlySpending*currentProportions.travel;spendingCategories.entertainment=monthlySpending*currentProportions.entertainment;spendingCategories.pharmacy=monthlySpending*currentProportions.pharmacy;spendingCategories.other=monthlySpending*currentProportions.other};this.getEmptyCreditCard=function(cardRules){var card=toCreditCard([]);
formatRewardValues({},card,{});return card};this.rulesToCreditCard=function(cardRules){var card=toCreditCard(cardRules);formatRewardValues({},card,{});return card};this.getSpendingBonusSum=function(creditCard){return getSpendingBonusSum(creditCard)}});
rh.ng.factory("gicService",function(){return{getUrl:function(params,isAllRatesPage){var french=Globalize.culture().language==="fr";var pathPieces=[];var firstPiece=(params.provider?params.provider+"-":"")+(french?"taux-cpg":"gic-rate"+(isAllRatesPage?"s":""));pathPieces.push(firstPiece);if(params.type)pathPieces.push(params.type);if(params.term)pathPieces.push(params.term);if(params.marketLinked)pathPieces.push(french?"lies-au-marche":"market-linked");if(typeof params.redeemable==="boolean")pathPieces.push((params.redeemable===
false?"non-":"")+(french?"rachetable":"redeemable"));if(params.province)pathPieces.push((french?"meilleur-au-":"best-in-")+params.province);var pathString=pathPieces.join("/");var queryPieces=[];if(params.investmentAmount)queryPieces.push("investment-amount="+params.investmentAmount);if(params.purchaseMethod)queryPieces.push("purchase-method="+params.purchaseMethod);if(params.cdic===true)queryPieces.push("cdic="+params.cdic);if(params.eligibility)queryPieces.push("eligibility="+params.eligibility);
if(params.city)queryPieces.push("city="+params.city);var queryString=queryPieces.length>0?"?"+queryPieces.join("&"):"";var root=french?"/cpg/":"/gics/";return root+pathString+queryString},localizeType:function(type){var french=Globalize.culture().language==="fr";switch(type){case "tfsa":return french?"celi":type;case "usd":return type;case "registered":return french?"enregistre":type;case "nonRegistered":case "non-registered":return french?"non-enregistre":"non-registered"}},termToSlug:function(term){var french=
Globalize.culture().language==="fr";if(term<12)return term*30+(french?"-jour":"-day");else return term/12+(french?"-ans":"-year")}}});
rh.ng.factory("rhHttpRequestService",function($http,$timeout){var $=jQuery;return{get:function(options,callback){var url=options.url||window.location.href;delete options.url;$http.get(url,{params:options}).success(function(data){if(callback)callback(data);$timeout(function(){rh.Control.init(data.controls)})})},jsonp:function(options){$.ajax({url:options.url,dataType:"jsonp",jsonpCallback:options.callback,data:options.data}).done(function(data){if(options.done)options.done(data);$timeout(function(){rh.Control.init(data.controls)})}).fail(function(data){if(options.fail)options.fail(data)})},
post:function(options){var url=options.url||window.location.href;var config={"headers":options.headers};$http.post(url,options.data,config).success(function(data){if(options.success)options.success(data);$timeout(function(){rh.Control.init(data.controls)})}).error(function(data){if(options.error)options.error(data)})}}});
rh.ng.factory("rhHistoryService",function(){var h=window.history;var emptyFunc=function(){return};if(!h.pushState||!h.replaceState||document.body.getAttribute("ng-app")!=="ratehub")h={back:emptyFunc,forward:emptyFunc,go:emptyFunc,pushState:emptyFunc,replaceState:emptyFunc};return h});
rh.ng.factory("rhConversionService",function(rhHttpRequestService,nonMonService){var f={};function clickConversion(options,type){var leadsUrl=nonMonService.getLeadsUrl(options.vertical?options.vertical:"cc");rhHttpRequestService.jsonp({url:ratehub.serverUri+leadsUrl+"?version=3&action="+type+"_click",data:{type:options.type,id:options.product.id,is_agent:options.isAgent,is_quoted:options.isQuoted,experiments:ratehub.experiments?JSON.stringify(ratehub.experiments):null,visitorId:ratehub.analytics&&
ratehub.analytics.visitorId?ratehub.analytics.visitorId:null},done:options.done});f.trackConversion(options,type)}f.phoneClick=function(options){clickConversion(options,"phone")};f.webClick=function(options){clickConversion(options,"web")};f.lead=function(options){if(options.isPaid||options.nonMonForm){var leadsUrl=nonMonService.getLeadsUrl(options.vertical?options.vertical:"cc");var url=leadsUrl+"?version=3&action="+(options.update?"update":"submit");var data=options.serializedForm;if(ratehub.analytics&&
ratehub.analytics.visitorId)data+="&visitorId="+ratehub.analytics.visitorId;if(ratehub.experiments)data+="&experiments="+encodeURIComponent(JSON.stringify(ratehub.experiments));var params={url:url,data:data,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){var params=parseUrlParams("?"+options.serializedForm);if(!Boolean(heap.identity)||!isNaN(parseFloat(heap.identity)))addEmailToHeap(params.email);f.trackConversion(options,"lead");if(options.done)options.done(data)},
error:function(data){alert('There was an error submitting your information. Please contact us directly by calling 1-800-679-9622 or using the "contact us" link at the top right of the page.');if(options.fail)options.fail(data)}};rhHttpRequestService.post(params)}else f.trackConversion(options,"lead")};f.preApprovalClick=function(options){f.trackConversion(options,"pre-approval")};f.trackConversion=function(options,conversionType){var eventOptions=null;if(!ratehub.isWidget){switch(options.type){case "creditcard":eventOptions=
{event:"lead-form-conversion",eventCategory:options.type,eventAction:conversionType+", "+(options.card.monetized?"monetized":"non-monetized"),eventLabel:options.product.providerName+", "+options.product.productDescription,hitCallback:options.hitCallback};if(options.hitCallback)setTimeout(options.hitCallback,1E3);break;case "mortgage":case "gic":case "savings":case "agent":case "chequing":if(!conversionType)break;eventOptions={event:"lead-form-conversion",eventCategory:options.type,eventAction:conversionType+
", "+(options.isPaid?"monetized":"non-monetized"),eventLabel:options.product.providerName+", "+options.product.productDescription};break}if(eventOptions)analyticsEvent(eventOptions)}triggerConversionEvent(conversionType,options)};f.getTrackingUrl=function(type,channel,isPaid){var p=isPaid?"paid":"unpaid";if(trackingUrls[type]&&trackingUrls[type][channel]&&trackingUrls[type][channel][p])return trackingUrls[type][channel][p];else return null};f.getThankyouUrl=function(type,data){var params=[];if(type===
"quotedrate")type="mortgage";params.push("v="+type);params.push("track=track");if(data){if(data.id)params.push("id="+data.id);if(data.nonMonFirst)params.push("nonMonFirst=true")}if(ratehub.isWidget||ratehub.widgetLoaded)params.push("widget=true");return trackingUrls.thankyou+"?"+params.join("&")};f.getCloakedUrl=function(url){if(url.indexOf("//ad.")>-1)return"/go/"+btoa(url);return url};function triggerConversionEvent(conversionType,options){if(options.card&&typeof document.body.dispatchEvent==="function")document.body.dispatchEvent(new CustomEvent("ratehub.conversion",
{detail:{productType:options.type,conversionType:conversionType,product:options.product}}))}var trackingUrls={mortgage:{phone:{paid:"/thankyou-phone",unpaid:"/thankyou-nophone"},web:{paid:"/thankyou-visit",unpaid:"/thankyou-novisit"},lead:{paid:"/thankyou-lead",unpaid:"/thankyou-noapp"}},gic:{phone:{paid:"/thankyou-gic-phone",unpaid:"/thankyou-gic-nophone"},web:{paid:"/thankyou-gic-visit",unpaid:"/thankyou-gic-novisit"},lead:{paid:"/thankyou-gic-lead",unpaid:"/thankyou-gic-noapp"}},savings:{lead:{paid:"/thankyou-savings-lead",
unpaid:"/thankyou-savings-noapp"}},chequing:{lead:{paid:"/thankyou-chequing-lead",unpaid:"/thankyou-chequing-noapp"}},creditcard:{lead:{paid:"/thankyou-creditcard-lead"}},thankyou:"/thankyou"};return f});rh.ng.factory("rhEnvironmentService",function(){var f={isMobileView:window.isMobileView,isWidgetView:window.isWidgetView,isMobileOrWidgetView:function(elem){return isMobileView()||isWidgetView(elem)},isMobileDevice:window.isMobileDevice,isAndroidOrIOS:window.isAndroidOrIOS};return f});
rh.ng.factory("depositsService",function(eyeReturnService,rhConversionService){return{handleWebClick:function(href,vertical,conversionOptions){window.open(rhConversionService.getCloakedUrl(href),"_blank");eyeReturnService.getThankYouPopup(false,vertical,{});rhConversionService.webClick(conversionOptions)},getApplyRedirect:function(href){var affId=ratehub.user&&ratehub.user.aff_info&&ratehub.user.aff_info.aff_id?ratehub.user.aff_info.aff_id:null;var experiments=ratehub.experiments?JSON.stringify(ratehub.experiments):
null;var visitorId=ratehub.analytics&&ratehub.analytics.visitorId?ratehub.analytics.visitorId:null;return appendQueryParams(href,{apply:true,aff_id:affId,experiments:experiments,visitorId:visitorId})}}});
rh.ng.factory("savingsService",function(){return{getUrl:function(params){var urlPieces=[];if(params.type)urlPieces.push(params.type);if(params.provider)urlPieces.push(params.provider);var urlString=urlPieces.join("/");var queryPieces=[];if(params.balance)queryPieces.push("balance="+params.balance);var queryString=queryPieces.length>0?"?"+queryPieces.join("&"):"";var root=Globalize.culture().language==="fr"?"/comptes-d-epargne/comptes":"/savings-accounts/accounts";if(urlString.length>0)root+="/";return root+
urlString+queryString},localizeType:function(type){if(Globalize.culture().language==="fr")switch(type){case "tfsa":return"celi";case "senior":return"aines";case "youth":return"jeunesse";case "high-interest":return"interets-eleves";case "rrsp":return"reer";default:}return type},getSavingsValues:function(accounts,balance,location,promoOffers){var results=[];for(var i=0;i<accounts.length;i++){var account=accounts[i];if(!account)continue;if(Object.keys(accounts[i].provider.provinces_served).length>0&&
!accounts[i].provider.provinces_served.hasOwnProperty(location.province.code))continue;if(!account.sponsored&&promoOffers&&!account.promo_offers.promo_on)continue;account.first_year_return=null;if(account.interest){for(var j=0;j<account.interest.length;j++){var tier=account.interest[j];if(balance>=tier.from)account.tiered_interest_rate=tier.rate;if(balance<tier.to)break}account.displayed_interest_rate=account.tiered_interest_rate}else{account.displayed_interest_rate=0;account.tiered_interest_rate=
0}if(account.bonus_interest&&balance>account.bonus_interest.from)if(account.bonus_interest.expiry.mode==="relative"){var bonusPeriod=account.bonus_interest.expiry.days;var remainingPeriod=365-bonusPeriod;account.first_year_return=account.bonus_interest.rate/100*balance*(bonusPeriod/365);account.first_year_return+=account.tiered_interest_rate/100*balance*(remainingPeriod/365);account.displayed_interest_rate=account.bonus_interest.rate}else if(account.bonus_interest.expiry.mode==="absolute"){var expiryDate=
(new Date(account.bonus_interest.expiry.date)).getTime();var now=(new Date).getTime();if(expiryDate>now){var oneDay=24*60*60*1E3;var bonusPeriod=Math.round(Math.abs((expiryDate-now)/oneDay));var remainingPeriod=365-bonusPeriod;account.first_year_return=account.bonus_interest.rate/100*balance*(bonusPeriod/365);account.first_year_return+=account.tiered_interest_rate/100*balance*(remainingPeriod/365);account.displayed_interest_rate=account.bonus_interest.rate}else delete account.bonus_interest}if(!account.first_year_return)account.first_year_return=
account.tiered_interest_rate/100*balance;results.push(account)}return results}}});
rh.ng.factory("chequingService",function(rhEnvironmentService,rhConversionService,nonMonService,depositsService,eyeReturnService){var $=jQuery;return{getUrl:function(params){var urlPieces=[];if(params.type)urlPieces.push(params.type);if(params.provider)urlPieces.push(params.provider);var urlString=urlPieces.join("/");var queryPieces=[];if(params.balance)queryPieces.push("balance="+params.balance);if(params.transactions)queryPieces.push("transactions="+params.transactions);var queryString=queryPieces.length>
0?"?"+queryPieces.join("&"):"";var root=ratehub.user&&ratehub.user.language==="fr"?"/comptes-cheques/comptes":"/chequing-accounts/accounts";if(urlString.length>0)root+="/";return root+urlString+queryString},localizeType:function(type){if(Globalize.culture().language==="fr")switch(type){case "personal":return"regulier";case "senior":return"aines";case "youth":return"jeunesse";case "student":return"etudiant";default:}return type},applyForAccount:function(event,account,balance,detailsPage){event.preventDefault();
event.stopPropagation();if(typeof account==="undefined"){window.open(event.target.href);return}var vertical="chequing";var monetized=account.featured;var conversionOptions={isPaid:monetized,type:vertical,product:{id:account.id,providerName:account.provider.name,productDescription:account.name}};if(account.promo_offers.promo_on&&account.promo_offers.popup_on)rh.Dialog.show(appendQueryParams(account.application_url,{"chequing-balance":balance,"widget":ratehub.isWidget}),{width:645,height:745});else if(!monetized)if(detailsPage)rh.Dialog.show(appendQueryParams(account.application_url,
{"chequing-balance":balance,"widget":ratehub.isWidget}),{width:651,height:700});else window.open(account.href,"_blank");else{var url=depositsService.getApplyRedirect(account.href);window.open(url,"_blank");eyeReturnService.getThankYouPopup(false,vertical,{id:account.id});rhConversionService.trackConversion(conversionOptions,"web")}},getTransactionsByType:function(transactions){switch(true){case transactions<15:transactionsByType={"debit":transactions,"bill":0,"eTransfer":0,"atm":0,"cheque":0,"teller":0};
break;default:transactionsByType={"debit":transactions-7,"bill":3,"eTransfer":0,"atm":3,"cheque":1,"teller":0};break}return transactionsByType},getMonthlyTransactions:function(transactionsByType){var numTransactions=0;for(var type in transactionsByType)numTransactions+=parseInt(transactionsByType[type]);return numTransactions},getEstimatedMonthlyCost:function(account,transactionsByType,balance,type){if(getRebateTotal(account,balance,transactionsByType)>0)if(account.rebate_type==="additional")return parseFloat(account.monthly_fees.monthly_fee);
else if(account.rebate_type==="both")return 0;else return getAdditionalFeesTotal(account,transactionsByType);else return getMonthlyFee(account,type)+getAdditionalFeesTotal(account,transactionsByType)},getAdditionalFees:function(account,transactionsByType){return getAdditionalFeesTotal(account,transactionsByType)},getAdditionalFee:function(fee,transactions,limit,type){return getAdditionalFeeIndividual(fee,transactions,limit,type)},getRebate:function(account,balance,transactionsByType,type){return getRebateTotal(account,
balance,transactionsByType,type)},showTiers:function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseover()},hideTiers:function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseout()},getInterestAtBalance:function(interest,balance){var initialInterest=interest.initial;if(interest.tiers!==null&&interest.tiers.length>0){var tiers=interest.tiers;for(var i=0;i<tiers.length;i++){if(tiers[i].range.search("or more")>
-1){initialInterest=tiers[i].rate;break}balance=parseFloat(balance);var boundaries=tiers[i].range.split("-");var lower=parseFloat(boundaries[0].trim().replace("$","").replace(",",""));var upper=parseFloat(boundaries[1].trim().replace("$","").replace(",",""));if(balance<=upper&&balance>=lower){initialInterest=tiers[i].rate;break}}}return initialInterest}};function getAdditionalFeesTotal(account,transactionsByType){if(account.slug==="cibc-smart-account"||account.slug==="compte-intelli"){var numTransactions=
transactionsByType.debit+transactionsByType.atm+transactionsByType.bill+transactionsByType.cheque+transactionsByType.teller+transactionsByType.eTransfer;return numTransactions>7?10:1.25*numTransactions}else return getAdditionalFeeIndividual(account.additional_fees.debit.over_fee,transactionsByType,account.transactions.number_of_self_serve_transactions,"debit")+getAdditionalFeeIndividual(account.additional_fees.bill_payment.over_fee,transactionsByType,account.transactions.number_of_self_serve_transactions,
"bill")+getAdditionalFeeIndividual(account.additional_fees.interac_e_transfer.over_fee,transactionsByType.eTransfer,account.transactions.number_of_interac_e_transfers,"eTransfer")+getAdditionalFeeIndividual(account.additional_fees.atm_bank_canada.over_fee,transactionsByType,account.transactions.number_of_self_serve_transactions,"atm")+getAdditionalFeeIndividual(account.additional_fees.cheque.over_fee,transactionsByType.cheque,account.transactions.number_of_cheque_transactions,"cheque")+getAdditionalFeeIndividual(account.additional_fees.in_branch_transaction.over_fee,
transactionsByType.teller,account.transactions.number_of_teller_assisted_transactions,"teller")}function calculateTransactionsOverLimit(transactions,limit){return limit!=="Unlimited"&&transactions>limit?transactions-limit:0}function getAdditionalFeeIndividual(fee,transactions,limit,type){switch(type){case "debit":case "atm":case "bill":mostTransactions={type:"debit",number:transactions.debit};if(parseInt(transactions.atm)>parseInt(mostTransactions.number))mostTransactions={type:"atm",number:transactions.atm};
if(parseInt(transactions.bill)>parseInt(mostTransactions.number))mostTransactions={type:"bill",number:transactions.bill};additionalFee=mostTransactions.type===type?parseFloat(fee)*calculateTransactionsOverLimit(parseInt(transactions.debit)+parseInt(transactions.atm)+parseInt(transactions.bill),limit):0;break;default:additionalFee=parseFloat(fee)*calculateTransactionsOverLimit(parseInt(transactions),limit);break}return additionalFee}function getRebateTotal(account,balance,transactionsByType,type){if(account.rebate.value>
0&&balance>=account.rebate.value)if(account.rebate_type==="additional")return getAdditionalFeesTotal(account,transactionsByType);else if(account.rebate_type==="both")return getMonthlyFee(account,type)+getAdditionalFeesTotal(account,transactionsByType);else return getMonthlyFee(account,type);else return 0}function getMonthlyFee(account,type){if(type==="student"&&account.monthly_fees.student_monthly_fee!=="n/a")return account.monthly_fees.student_monthly_fee;else if(type==="senior"&&account.monthly_fees.senior_monthly_fee!==
"n/a")return account.monthly_fees.senior_monthly_fee;else return account.monthly_fees.monthly_fee}});
rh.ng.factory("rhTipService",function(){var $=jQuery;var f={};var tips={};var activeTip=null;var type=null;var tipsEnabled=null;f.setType=function(newType){type=newType+"TipsEnabled";tipsEnabled=$.cookie(type)!=="false"};f.activateTip=function(whichTip){if(!tipsEnabled)return;tips[activeTip]=false;tips[whichTip]=true;activeTip=whichTip};f.isTipActive=function(whichTip){return tips[whichTip]};f.disableTips=function(){if(!tipsEnabled)return;tips[activeTip]=false;tipsEnabled=false;$.cookie(type,"false",
{expires:365,path:"/"})};return f});rh.ng.factory("mortgageService",function(){var f={};f.getMortgageAmount=function(homePrice,downPayment,amortization){return can_mortgage_principal_purchase(homePrice,downPayment,amortization)};return f});
rh.ng.factory("eyeReturnService",function(rhConversionService){var $=jQuery;var f={};var alreadyCalled,href=false;f.getEyeReturnTagCode=function(tag,options){return function l(d){var site="7471",page=tag,s,er=d.createElement("script");if(tag!=="submit_request_button"&&options.mortgage)window.er_custom_rate+=","+(options.rates?getEyeReturnRateIds(options.rates):options.rateIDs);er.type="text/javascript";er.async=true;if(options.productType)er.onload,er.onerror=f.getThankYouPopup(options.subscribe,
options.productType,options.data);er.src="//o2.eyereturn.com/?site="+site+"&page="+page;s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(er,s)}(document)};f.getThankYouPopup=function(subscribe,productType,data){alreadyCalled=false;href=rhConversionService.getThankyouUrl(productType,data);if(subscribe){analyticsEvent({"event":"newsletter-signup","eventCategory":"newsletter-signup","eventAction":"rate-details","eventLabel":productType,"hitCallback":f.redirect});setTimeout(f.redirect,
1E3)}else f.redirect()};f.redirect=function(){var alreadyInPopup=$(".rh.is-iframe").length>0;if(alreadyCalled)return;alreadyCalled=true;if(alreadyInPopup)window.location=href;else{var options={className:"rh-popup"};rh.Dialog.openAsPopup(rh.Dialog.createLink(href,true),options)}};function getEyeReturnRateIds(rates){return rates.filter(function(rate){return rate.featured}).sort(function(a,b){return a.value>b.value?1:b.value>a.value?-1:0}).slice(0,3).map(function(rate){return rate.external_id}).join(",")}
return f});
rh.ng.factory("loginService",function(rhHttpRequestService,nonMonService){function login(scope,nonMonForm,formData){if(scope.loginForm.$valid){scope.submitting=true;var formData=formData?formData:$("#loginForm").serialize();var options={url:"/authenticate",data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(response){if(response.data.email)addEmailToHeap(response.data.email);if(nonMonForm)scope.loginCallback(response.data.non_mon_leads);else window.top.location=response.data.redirect},
error:function(response){scope.loginErrMsg=Globalize.localize(response.errors[0].code);scope.submitting=false}};rhHttpRequestService.post(options)}else scope.loginForm.submitted=true}function register(scope,nonMonForm){if(scope.registerForm.$valid){scope.submitting=true;var formData=$("#registerForm").serialize();if(nonMonForm)formData+="&product_type="+scope.productTypeSlug;var options={url:"/api/register",data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(response){var params=
parseUrlParams("?"+formData);if(params.email)addEmailToHeap(params.email);scope.submitting=false;if(nonMonForm){formData+="&_token="+ratehub.csrf;nonMonService.subscribeToNewsletter();validateUser(scope,nonMonForm,formData,response.data.token,null)}else{scope.showPanel("email-verify");analyticsEvent({"event":"user-registration-pre-verify","eventCategory":"free-credit-score","eventAction":"register-pre-verify"})}},error:function(data){scope.submitting=false;scope.registerErrMsg=Globalize.localize(data.errors[0].code);
if(data.errors[0].code==="user-disabled"){var params=parseUrlParams("?"+formData);delete params.password;delete params._token;rh.Dialog.show(appendQueryParams("/re-enable-account",params),{popupClass:"rh-re-enable-popup"})}}};rhHttpRequestService.post(options)}else scope.registerForm.submitted=true}function validateUser(scope,nonMonForm,formData,token){var options={url:"/api/register/validate",data:"token="+token,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){if(nonMonForm)login(scope,
nonMonForm,formData)},error:function(response){scope.registerErrMsg=Globalize.localize(response.errors[0].code);scope.submitting=false}};rhHttpRequestService.post(options)}function requestPasswordReset(scope){if(scope.requestPasswordResetForm.$valid){scope.submitting=true;var formData=$("#requestPasswordResetForm").serialize();var options={url:"/api/password/reset/request",data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){scope.requestPasswordResetMsg=
true;scope.requestPasswordResetErrMsg=null;scope.emailSent=true;scope.submitting=false},error:function(response){scope.requestPasswordResetMsg=false;scope.requestPasswordResetErrMsg=Globalize.localize(response.errors[0].code);scope.submitting=false}};rhHttpRequestService.post(options)}else scope.requestPasswordResetForm.submitted=true}function displaySaveBar(type){var saveBar=$(".save-bar."+type);if(saveBar.length>0){saveBar.css({"display":"block","position":"fixed","top":"0"});setTimeout(function(){saveBar.css({"display":"none"})},
5E3)}}return{login:login,register:register,validateUser:validateUser,requestPasswordReset:requestPasswordReset,displaySaveBar:displaySaveBar}});
rh.ng.factory("nonMonService",function(rhHttpRequestService){function isNewNonMon(){var newNonMonForm=true;if(ratehub.experiments&&ratehub.experiments.creditcards)newNonMonForm=!(ratehub.experiments.creditcards.ccNonMonForm===0);return newNonMonForm}function isFirstLead(vertical){return!(ratehub.nonMonLeads&&ratehub.nonMonLeads[vertical])}function getLeadsUrl(vertical){if(vertical!=="mtg"&&ratehub.user.api_token)return"/api/logged-in-leads";return"/api/leads"}function subscribeToNewsletter(){var href=
window.location.href;var vertical="gic";if(href.indexOf("/savings-accounts")>-1||href.indexOf("/comptes-d-epargne")>-1)vertical="sav";else if(href.indexOf("/chequing-accounts")>-1||href.indexOf("/comptes-cheques")>-1)vertical="chq";var data={"first_name":$("#registerForm input[name='first_name']").val(),"last_name":$("#registerForm input[name='last_name']").val(),"email":$("#registerForm input[name='email']").val(),"product_type":vertical};if(data.email&&(!Boolean(heap.identity)||!isNaN(parseFloat(heap.identity))))addEmailToHeap(data.email);
var options={url:"/api/newsletter",data:data,success:function(){analyticsEvent({"eventCategory":"newsletter-"+vertical,"eventAction":"cta"})}};rhHttpRequestService.post(options)}return{isNewNonMon:isNewNonMon,isFirstLead:isFirstLead,getLeadsUrl:getLeadsUrl,subscribeToNewsletter:subscribeToNewsletter}});rh.ng.factory("rhHttpInterceptor",function(){return{response:function(data){if(data.data&&data.data.api_token)ratehub.user.api_token=data.data.api_token;return data}}});rh.ng.config(function($httpProvider){$httpProvider.interceptors.push("rhHttpInterceptor")});rh.ng.directive("rhSavingsAccount",function(){var tmpl='<span class="rh-provider">'+'<span class="provider-logo">'+'<img ng-attr-src="{{account.provider.logo}}" />'+"</span>"+'<span class="provider-name">'+"{{account.provider.name}} {{account.name}}"+"</span>"+"</span>";return{restrict:"A",scope:{account:"=rhSavingsAccount"},replace:true,template:tmpl}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("SavingsHeadCtrl",function($scope,savingsService){$scope.french=Globalize.culture().language==="fr";$scope.balance=5E3;$scope.location=ratehub.user.location;$scope.findSavings=function(event){event.preventDefault();event.stopPropagation();var url=savingsService.getUrl({type:$scope.type!=="all"?savingsService.localizeType($scope.type):null,provider:$scope.provider!=="all"?$scope.provider:null,balance:$scope.balance});window.location=url}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.controller("AllSavingsTableCtrl",function($scope,$sce,savingsService,rhHistoryService,rhHttpRequestService,rhConversionService,rhEnvironmentService,eyeReturnService,nonMonService,depositsService){var $=jQuery;var SAVINGS_ACCOUNT_TYPE_ALL=0;var SAVINGS_ACCOUNT_TYPE_HIGH_INTEREST=1;var SAVINGS_ACCOUNT_TYPE_TFSA=2;var SAVINGS_ACCOUNT_TYPE_YOUTH=3;var SAVINGS_ACCOUNT_TYPE_SENIOR=4;var SAVINGS_ACCOUNT_TYPES=[{index:SAVINGS_ACCOUNT_TYPE_ALL,key:"all"},{index:SAVINGS_ACCOUNT_TYPE_HIGH_INTEREST,key:"highInterest"},
{index:SAVINGS_ACCOUNT_TYPE_TFSA,key:"tfsa"},{index:SAVINGS_ACCOUNT_TYPE_YOUTH,key:"youth"},{index:SAVINGS_ACCOUNT_TYPE_SENIOR,key:"senior"}];$scope.rawAccounts={};$scope.accounts={};$scope.filters={"type":SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_ALL].key,"location":ratehub.user.location,"promoOffers":{}};$scope.filters["promoOffers"][SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_ALL].key]=false;$scope.filters["promoOffers"][SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_HIGH_INTEREST].key]=false;$scope.filters["promoOffers"][SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_TFSA].key]=
false;$scope.filters["promoOffers"][SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_YOUTH].key]=false;$scope.filters["promoOffers"][SAVINGS_ACCOUNT_TYPES[SAVINGS_ACCOUNT_TYPE_SENIOR].key]=false;$scope.isLoading=false;$scope.restoring=false;$scope.defaultLimit=6;$scope.limit=$scope.defaultLimit;$scope.isLoading=false;$scope.order="-first_year_return";$scope.sorted=false;$scope.french=Globalize.culture().language==="fr";$scope.featuredSavingsEnabled=false;$scope.isMobile=rhEnvironmentService.isMobileView();
$scope.getCurrentPromoFilterModel=function(){return $scope.filters.type};$scope.renderTable=function(trackPage){if(typeof trackPage==="undefined")trackPage=true;var url=savingsService.getUrl({provider:$scope.filters.provider!=="all"?$scope.filters.provider:null,type:$scope.filters.type!=="all"?savingsService.localizeType($scope.filters.type):null});var options={url:url,data:{operation:"getAllSavingsTableData"},done:function(response){if(!$scope.restoring){rhHistoryService.pushState($scope.getStateObject(),
null,url);if(trackPage&&!ratehub.isWidget&&typeof ga==="function"){ga("set","page",url.replace(ratehub.serverUri,""));ga("send","pageview")}}else $scope.restoring=false;document.title=response.title;$scope.$parent.intro=$sce.trustAsHtml(response.intro);$scope.$parent.content=$sce.trustAsHtml(response.content);$scope.rawAccounts=response.accounts||[];$scope.processSavings($scope.rawAccounts);$scope.isLoading=false}};$scope.isLoading=true;if(ratehub.isWidget)options.data.isWidget=true;rhHttpRequestService.jsonp(options)};
$scope.processSavings=function(accounts){$scope.accounts=savingsService.getSavingsValues(accounts,$scope.filters.balance,$scope.filters.location,$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()])};$scope.getStateObject=function(){return{type:$scope.filters.type,provider:$scope.filters.provider}};$scope.toggleLimit=function(){$scope.limit=$scope.limit===$scope.defaultLimit?$scope.accounts.length:$scope.defaultLimit};$scope.isUndefined=function(val){return typeof val==="undefined"};$scope.showTiers=
function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseover()};$scope.hideTiers=function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseout()};$scope.getDetailsHref=function(href){return appendQueryParams(href,{widget:ratehub.isWidget})};$scope.applyForSavings=function(event,account){event.preventDefault();event.stopPropagation();var vertical="savings";var tag=account.featured?"monetized_savings_leads":
"non-monetized_savings_leads";eyeReturnService.getEyeReturnTagCode(tag,{});var conversionOptions={isPaid:account.featured,type:vertical,product:{id:account.id,providerName:account.provider.name,productDescription:account.name}};if(account.promo_offers.promo_on&&account.promo_offers.popup_on)rh.Dialog.show(appendQueryParams(account.href,{"savings-balance":$scope.filters.balance,"widget":ratehub.isWidget}),{width:645,height:745});else if(account.featured){var url=depositsService.getApplyRedirect(account.href);
window.open(url,"_blank");eyeReturnService.getThankYouPopup(false,vertical,{id:account.id});rhConversionService.trackConversion(conversionOptions,"web")}else rh.Dialog.show(appendQueryParams(account.details_href,{"widget":ratehub.isWidget}))};$scope.sortSponsored=function(account){return account.sponsored?0:1};$scope.sortFeatured=function(account){return account.featured&&$scope.featuredSavingsEnabled?0:1};$scope.isFeatured=function(account){return account.featured&&!account.sponsored&&$scope.featuredSavingsEnabled};
$scope.displayPFAIcon=function(account){return account.pfa_winner&&ratehub.user.language!=="fr"&&ratehub.experiments&&ratehub.experiments.savings&&ratehub.experiments.savings.savPFAIconTest&&ratehub.experiments.savings.savPFAIconTest===1};$scope.$on("tableSorted",function(event,type){if(type)$scope.order=type;$scope.sorted=true});$scope.$watch("filters.promoOffers",function(){$scope.renderTable(false)},true);$scope.hasPromoOffers=function(){var showPromoOffersChecked=$scope.filters.promoOffers[$scope.getCurrentPromoFilterModel()];
var hasAtLeastOnePromoOffer=$scope.accounts.length&&$scope.accounts.some(function(account){return account.promo_offers.promo_on});return showPromoOffersChecked||hasAtLeastOnePromoOffer}});
rh.ng.directive("allSavingsTable",function($sce,rhHistoryService){var $=jQuery;return{restrict:"C",controller:"AllSavingsTableCtrl",link:{pre:function(scope,elem,attrs){scope.$parent.intro=$sce.trustAsHtml($('[rh-bind-compile-html="intro"]').html());scope.$parent.content=$sce.trustAsHtml($('[rh-bind-compile-html="content"]').html());scope.featuredSavingsEnabled=typeof attrs.featuredSavings!=="undefined"},post:function(scope){scope.scenario=scope.filters.promoOffers[scope.getCurrentPromoFilterModel()];
scope.rawAccounts=ratehub.savingsAccounts||{};scope.processSavings(scope.rawAccounts);if(!ratehub.isWidget)rhHistoryService.replaceState(scope.getStateObject(),"");$(window).bind("popstate",function(event){event.preventDefault();var state=event.originalEvent.state;if(state)scope.$apply(function(){scope.restoring=true;scope.filters.type=state.type;scope.filters.provider=state.provider;scope.renderTable(false)})})}}}});
rh.ng.directive("allSavingsTableNoResults",function(){var template='<tr ng-show="accounts.length === 0">'+"<td>"+"<p>"+ratehub.noResultsMsg+"</p>"+"</td>"+"</tr>";return{restrict:"C",replace:true,template:template}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.controller("BestSavingsCtrl",function($scope){$scope.french=Globalize.culture().language==="fr";$scope.location=ratehub.user.location;$scope.calcSavings=function(){$scope.$broadcast("update",$scope.balance,$scope.location)}});
rh.ng.controller("BestSavingsTableCtrl",function($scope,savingsService,rhEnvironmentService){$scope.defaultLimit=5;$scope.limit=$scope.defaultLimit;$scope.order="-first_year_return";$scope.isMobile=rhEnvironmentService.isMobileView();$scope.toggleLimit=function(){$scope.limit=$scope.limit===$scope.defaultLimit?$scope.accounts.length:$scope.defaultLimit};$scope.setType=function(type){$scope.type=type;$scope.accounts=savingsService.getSavingsValues(ratehub[$scope.type],$scope.balance,$scope.location,
false)};$scope.showTiers=function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseover()};$scope.hideTiers=function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseout()};$scope.$on("update",function(event,balance,location){$scope.accounts=savingsService.getSavingsValues(ratehub[$scope.type],balance,location,false)})});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhSortableTable",function(){var $=jQuery;var slideTime=400;var animation="easeOutExpo";return{restrict:"C",controller:function($scope){$scope.collapsed=false;$scope.toggleCollapse=function($event){$($event.currentTarget).closest(".rh-sortable-table").find(".sortable-content").slideToggle(slideTime,animation);$scope.collapsed=!$scope.collapsed};$scope.sortClicked=function($event){var element=$($event.currentTarget);var orderBy=element.attr("order-by");if(orderBy)$scope.setOrder(orderBy);
$scope.$emit("tableSorted",orderBy)};$scope.setOrder=function(newOrder){order=newOrder.split("/");if(order.length>1)order=$scope.order===order[0]?order[1]:order[0];else order=order[0];$scope.order=order};$scope.$on("setSortableOrder",function(event,newOrder){$scope.setOrder(newOrder)})},link:{pre:function(scope,elem,attrs){if(typeof scope.tableHeight!=="undefined"){elem.find(".sortable-content").css("max-height",scope.tableHeight+"px");elem.find(".sortable-content").css("overflow-y","scroll")}}}}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("offerViewCard",function(){var $=jQuery;var slideTime=400;return{restrict:"C",controller:function($scope){$scope.toggleCollapse=function($event){var elem=$event.currentTarget;$(elem).toggleClass("active");var collapsed=$(elem).find(".can-collapse");collapsed.slideToggle(slideTime);var arrow=$(elem).find(".collapse-arrow");arrow.toggleClass("fa-chevron-down");arrow.toggleClass("fa-chevron-up")}}}});rh=window.rh||{};rh.Stub=rh.Stub||{};
(function($){rh.Stub.palette={"down":{"bgColor":"white","bgColorHover":"#56ADC2","borderColor":"#CDD6D9"},"up":{"bgColor":"#7ECBDD","bgColorHover":"#7ECBDD","borderColor":"#7ECBDD"}};rh.Stub.initializeStub=function(stub){var canvas=document.createElement("canvas");if(canvas.getContext)var canvasSupported=true;else var canvasSupported=false;var slideTime=400;var animation="easeOutExpo";var $self=$(stub);var $stub=canvasSupported?$self.find("> .stub"):$self;var limit=Math.min($self.attr("data-limit"),
$self.find(".toggle-content > .rh-table:first-child > tbody > tr").length);var direction=$self.hasClass("direction-down")?"down":"up";var tableHeight,headerHeight,wrapperHeight,limitedHeight;$self.on("render",function(){setVisibleContent();drawCanvas()});$(window).on("load",function(){setVisibleContent()});if(canvasSupported)drawCanvas();$stub.click(function(){var containerHeight=$self.find(".toggle-content").height();var newHeight=tableHeight!=containerHeight?tableHeight:limitedHeight;var properties=
{height:newHeight};var options={duration:slideTime,easing:animation};$self.find(".toggle-content").animate(properties,options);if($self.hasClass("is-open")){var rect=$self.get(0).getBoundingClientRect();var distance=containerHeight-limitedHeight;if(rect.bottom-distance<0)$("html, body").animate({scrollTop:"-="+distance+"px"},options)}$self.toggleClass("is-open").toggleClass("is-closed")});function setVisibleContent(){tableHeight=$self.find(".toggle-content table").outerHeight();headerHeight=$self.find(".toggle-content thead th").outerHeight();
wrapperHeight=0;$self.find(".toggle-content tbody tr:lt("+limit+")").each(function(i,el){wrapperHeight+=$(el).outerHeight()});limitedHeight=headerHeight+wrapperHeight;if($self.hasClass("is-closed"))$self.find(".toggle-content").height(limitedHeight)}function drawCanvas(){var palette=rh.Stub.palette;var width=$self.width();var height=$self.height();$stub.append('<canvas width="'+width+'" height="'+height+'"></canvas>');var canvas=$stub.find("canvas")[0];rh.Stub.drawStub(canvas,direction);$stub.hover(function(){rh.Stub.drawStub(canvas,
direction,palette[direction]["bgColorHover"])},function(){rh.Stub.drawStub(canvas,direction,palette[direction]["bgColor"])});$(window).resize(function(){rh.Stub.drawStub(canvas,direction)})}};rh.Stub.drawStub=function drawStub(canvas,direction,bgColor){var palette=rh.Stub.palette;var width=$(canvas).width();var height=$(canvas).height();canvas.setAttribute("width",width);canvas.setAttribute("height",height);var shadowHeight=4;var edgeAngle=18;var openTextWidth=$(canvas).parent().find(".open")[0].offsetWidth;
var closedTextWidth=$(canvas).parent().find(".closed")[0].offsetWidth;var textWidth=openTextWidth>closedTextWidth?openTextWidth:closedTextWidth;var ctx=canvas.getContext("2d");ctx.clearRect(0,0,width,height);ctx.fillStyle=bgColor||palette[direction]["bgColor"];ctx.strokeStyle=palette[direction]["borderColor"];if(direction==="down"){ctx.beginPath();ctx.moveTo(0,.5);ctx.lineTo(width,.5);ctx.lineTo(width,height/2-shadowHeight-1);ctx.lineTo(width/2+textWidth/2,height/2-shadowHeight-1);ctx.lineTo(width/
2+textWidth/2-edgeAngle,height-shadowHeight-1);ctx.lineTo(width/2-textWidth/2+edgeAngle,height-shadowHeight-1);ctx.lineTo(width/2-textWidth/2,height/2-shadowHeight-1);ctx.lineTo(0,height/2-shadowHeight-1);ctx.lineTo(0,.5);ctx.closePath();ctx.shadowColor="rgba(0,0,0,0.1)";ctx.shadowOffsetY=shadowHeight;ctx.shadowBlur=0;ctx.fill();ctx.stroke();ctx.shadowColor=0;ctx.shadowOffsetY=0}else if(direction==="up"){ctx.beginPath();ctx.moveTo(0,height-.5);ctx.lineTo(width,height-.5);ctx.lineTo(width,height/2);
ctx.lineTo(width/2+textWidth/2,height/2);ctx.lineTo(width/2+textWidth/2-edgeAngle,.5);ctx.lineTo(width/2-textWidth/2+edgeAngle,.5);ctx.lineTo(width/2-textWidth/2,height/2);ctx.lineTo(0,height/2);ctx.lineTo(0,height-.5);ctx.closePath()}ctx.fill();ctx.stroke()}})(jQuery);rh.ng.directive("rhStub",function(){return{restrict:"C",link:function(scope,elem){rh.Stub.initializeStub(elem)}}});(function($){rh.ng.directive("navTabs",function($timeout){var hoverBgColor="#56ADC2";var unhoverBgColor="#EBF3F5";var borderColor=$(".tab-stop").css("border-top-color");var tabsTopLayer=$(".tab-stop").css("z-index");return{restrict:"C",link:function(scope,elem){if(elem.parent().is(".rh-tabs-v2"))return;scope.controlGroup=elem.attr("data-control-group");var canvas=document.createElement("canvas");if(!(canvas.getContext&&canvas.getContext("2d")))return;$(window).resize(function(){elem.find("li > a").each(function(i){var tab=
$(this);var width=tab.outerWidth();var height=tab.outerHeight();tab.find("canvas").attr("width",width);tab.find("canvas").attr("height",height)});drawTabSet(elem)});$timeout(function(){elem.find("li > a").each(function(i){var tab=$(this);var width=tab.outerWidth();var height=tab.outerHeight();tab.css("z-index",tabsTopLayer-i);tab.prepend('<canvas width="'+width+'" height="'+height+'"></canvas>');tab.hover(function(){drawTab($(this).find("canvas")[0],hoverBgColor)},function(){drawTab($(this).find("canvas")[0],
unhoverBgColor)});tab.focus(function(){drawTab($(this).find("canvas")[0],hoverBgColor)});tab.blur(function(){drawTab($(this).find("canvas")[0],unhoverBgColor)});if(ratehub.experiments.mortgages.removeMortgageType){if(!elem.prop("data-disabled"))tab.click(function(event){$(this).tab("show")});if(elem.prop("data-disabled"))tab.find("input[type=radio]").attr("disabled",true)}tab.on("shown.bs.tab",function(event){drawTabSet($(this).closest("ul.nav-tabs"));scope.activeTab=event.target.hash.substr(1);if(ratehub.experiments.mortgages.removeMortgageType){$(event.target).find("input[type=radio]").prop("checked",
true);$(event.relatedTarget).find("input[type=radio]").prop("checked",false)}})});drawTabSet(elem);elem.find("li.active a").trigger("shown.bs.tab")})}};function drawTabSet(tabs){tabs.find("li canvas").each(function(){drawTab(this)})}function drawTab(canvas,bgColor){var item=$(canvas).parent().parent();if(item.is(".active"))var backgroundColor="white";else if(bgColor)var backgroundColor=bgColor;else var backgroundColor=unhoverBgColor;var width=$(canvas).width();var height=$(canvas).height();var ctx=
canvas.getContext("2d");ctx.beginPath();ctx.moveTo(.5,height);if(item.is(":first-child"))ctx.lineTo(.5,.5);else ctx.lineTo(3/4*height,.5);ctx.lineTo(width-3/4*height,.5);ctx.lineTo(width,height);ctx.fillStyle=backgroundColor;ctx.fill();ctx.strokeStyle=borderColor;ctx.stroke()}});rh.ng.directive("navDropdown",function($timeout){return{restrict:"C",link:function(scope,elem){scope.elem=elem;scope.controlGroup=elem.attr("data-control-group")},controller:function($scope){$scope.showTab=function(tabName){$timeout(function(){$("[data-control-group="+
$scope.controlGroup+"].nav-tabs").find('a[href="#'+tabName+'"]').click()})}}}});rh.ng.directive("navPanel",function($timeout){return{restrict:"C",link:function(scope,elem){scope.elem=elem;scope.controlGroup=elem.attr("data-control-group")},controller:function($scope){$scope.showTab=function(event,tabId){event.preventDefault();event.stopPropagation();$("#"+tabId).toggleClass("active");$('a[href="#'+tabId+'"]').trigger("shown.bs.tab");$('.nav-panel[href="#'+tabId+'"]').toggleClass("active")}}}})})(jQuery);rh.ng.directive("rhTieredRates",function(){var tmpl='<table class="rh-tiered-interest">'+"<thead>"+"<tr>"+"<th>"+"<span ng-bind=\"'if-balance-is-title' | localize\"></span>"+"</th>"+"<th>"+"<span ng-bind=\"'rate-title' | localize\"></span>"+"</th>"+"</tr>"+"</thead>"+"<tbody>"+'<tr ng-repeat="tier in account.interest_tiers">'+"<td>"+"<span>{{tier.tier}}</span>"+"</td>"+"<td>"+"<span>{{tier.rate}}%</span>"+"</td>"+"</tr>"+"</tbody>"+"</table>";return{restrict:"A",scope:{account:"=rhTieredRates"},replace:true,
template:tmpl}});jQuery(function($){$(".rh-toggle-bar").click(function(){$(this).toggleClass("is-open");$(this).find("+ .toggle-content").slideToggle()})});rh.ng.directive("rhTooltipContainer",function($timeout,rhEnvironmentService){return{restrict:"C",link:function(scope,elem,attrs){$timeout(function(){var options={};var isMobile=rhEnvironmentService.isMobileView();var title=elem.find(".rh-title");title=title.length?title.html():null;var content=elem.find(".rh-content");content=content?content.html():null;var tooltip=elem.find(".rh-tooltip");if(isMobile||tooltip.attr("data-trigger")==="click"){title=(title||"")+'<span class="rh-close"><i class="fa fa-times-circle"></i></span>';
options.html=true}options.content=content;if(title)options.title=title;tooltip.popover(options);if(tooltip.attr("show-by-default")==="true"){tooltip.popover("show");elem.find(".rh-close").click(function(){tooltip.popover("hide")})}tooltip.on("shown.bs.popover",function(){elem.find(".rh-close").click(function(){tooltip.popover("hide")})})})}}});
jQuery(function($){var originalLeave=$.fn.popover.Constructor.prototype.leave;$.fn.popover.Constructor.prototype.leave=function(obj){var self=obj instanceof this.constructor?obj:$(obj.currentTarget)[this.type](this.getDelegateOptions()).data("bs."+this.type);var container,timeout,timeToPersist=300;if(obj.currentTarget){container=$(obj.currentTarget).siblings(".popover");timeout=setTimeout(function(){originalLeave.call(self,obj)},timeToPersist);container.one("mouseenter",function(){clearTimeout(timeout);
container.one("mouseleave",function(){originalLeave.call(self,obj)})})}}});rh.ng.directive("rhVideo",function(){var $=jQuery;return{restrict:"C",link:function(scope,elem,attrs){var ratio=16/9;var query="";if(elem.attr("data-query"))query="&"+elem.attr("data-query");var src="//www.youtube.com/embed/"+elem.attr("data-youtube")+"?wmode=transparent"+query;elem.append($("<iframe/>",{width:elem.width(),height:elem.width()/ratio,src:src,frameborder:0,allowfullscreen:true}));var lastWidth=elem.width()?elem.width():null;var timeoutId=null;function resizeVideo(){if(elem.width()&&
elem.width()!=lastWidth){lastWidth=elem.width();clearTimeout(timeoutId);timeoutId=setTimeout(function(){elem.find("iframe").css("width",elem.width()).css("height",elem.width()/ratio)},250)}}$(window).resize(resizeVideo);var tabId=elem.closest(".tab-pane").attr("id");if(tabId){var tab=elem.closest(".tab-content").prev("ul.nav.nav-tabs").find('a[href="#'+tabId+'"]');tab.on("shown.bs.tab",resizeVideo)}}}});
